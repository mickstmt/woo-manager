{% extends "base.html" %}

{% block title %}Reporte de Ganancias - WooCommerce Manager{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        transition: transform 0.2s;
    }
    .metric-card:hover {
        transform: translateY(-5px);
    }
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
    }
    .profit-positive {
        color: #28a745;
    }
    .profit-negative {
        color: #dc3545;
    }
    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }
    .table th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-0">
            <i class="bi bi-currency-dollar"></i> Reporte de Ganancias
        </h1>
        <p class="text-muted">Análisis de costos y ganancias por pedidos</p>
    </div>
</div>

<!-- Filtro de fechas -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Fecha Inicio</label>
                        <input type="date" id="start-date" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Fecha Fin</label>
                        <input type="date" id="end-date" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="loadReport()">
                            <i class="bi bi-search"></i> Generar Reporte
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Métricas principales -->
<div class="row mb-4" id="metrics-container">
    <div class="col-md-3 mb-3">
        <div class="card metric-card bg-primary text-white">
            <div class="card-body">
                <h6 class="card-title">Total Pedidos</h6>
                <div class="metric-value" id="total-pedidos">-</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card bg-info text-white">
            <div class="card-body">
                <h6 class="card-title">Ventas Totales (PEN)</h6>
                <div class="metric-value" id="ventas-totales">-</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card bg-warning text-dark">
            <div class="card-body">
                <h6 class="card-title">Costos Totales (PEN)</h6>
                <div class="metric-value" id="costos-totales">-</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title">Ganancia Total (PEN)</h6>
                <div class="metric-value" id="ganancias-totales">-</div>
                <small id="margen-promedio">Margen: -</small>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de pedidos -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Ganancias por Pedido</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Pedido</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Estado</th>
                                <th class="text-end">Venta (PEN)</th>
                                <th class="text-end">Tipo Cambio</th>
                                <th class="text-end">Costo (USD)</th>
                                <th class="text-end">Costo (PEN)</th>
                                <th class="text-end">Ganancia (PEN)</th>
                                <th class="text-end">Margen %</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table">
                            <tr>
                                <td colspan="10" class="text-center text-muted">
                                    Selecciona un rango de fechas y genera el reporte
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Botón flotante para ir arriba -->
<button id="back-to-top" class="btn btn-primary rounded-circle"
        style="position: fixed; bottom: 20px; right: 20px; display: none; z-index: 1000;">
    <i class="bi bi-arrow-up"></i>
</button>

{% endblock %}

{% block extra_js %}
<script>
    // Inicializar fechas (últimos 30 días)
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);

    document.getElementById('end-date').valueAsDate = today;
    document.getElementById('start-date').valueAsDate = thirtyDaysAgo;

    // Cargar reporte automáticamente al inicio
    loadReport();

    function loadReport() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        if (!startDate || !endDate) {
            showAlert('Por favor selecciona ambas fechas', 'warning');
            return;
        }

        // Mostrar loading
        document.getElementById('orders-table').innerHTML = `
            <tr>
                <td colspan="10" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </td>
            </tr>
        `;

        // Llamar al API
        fetch(`/reports/api/profits?start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateMetrics(data.data.summary);
                    updateTable(data.data.orders);
                } else {
                    showAlert('Error al cargar el reporte: ' + data.error, 'danger');
                    console.error(data);
                }
            })
            .catch(error => {
                showAlert('Error de conexión: ' + error, 'danger');
                console.error(error);
            });
    }

    function updateMetrics(summary) {
        document.getElementById('total-pedidos').textContent = summary.total_pedidos;
        document.getElementById('ventas-totales').textContent = 'S/. ' + formatNumber(summary.ventas_totales_pen);
        document.getElementById('costos-totales').textContent = 'S/. ' + formatNumber(summary.costos_totales_pen);
        document.getElementById('ganancias-totales').textContent = 'S/. ' + formatNumber(summary.ganancias_totales_pen);
        document.getElementById('margen-promedio').textContent = 'Margen: ' + formatNumber(summary.margen_promedio_porcentaje) + '%';
    }

    function updateTable(orders) {
        const tbody = document.getElementById('orders-table');

        if (orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" class="text-center text-muted">
                        No hay pedidos en el rango seleccionado
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = orders.map(order => {
            const profitClass = order.ganancia_pen >= 0 ? 'profit-positive' : 'profit-negative';
            const statusBadge = getStatusBadge(order.estado);
            const clienteNombre = order.cliente_nombre && order.cliente_apellido
                ? `${order.cliente_nombre} ${order.cliente_apellido}`
                : 'Sin nombre';

            return `
                <tr>
                    <td><a href="/orders/${order.pedido_id}">${order.numero_pedido}</a></td>
                    <td>${formatDate(order.fecha_pedido)}</td>
                    <td>${clienteNombre}</td>
                    <td>${statusBadge}</td>
                    <td class="text-end">S/. ${formatNumber(order.total_venta_pen)}</td>
                    <td class="text-end">${formatNumber(order.tipo_cambio)}</td>
                    <td class="text-end">$ ${formatNumber(order.costo_total_usd)}</td>
                    <td class="text-end">S/. ${formatNumber(order.costo_total_pen)}</td>
                    <td class="text-end ${profitClass}">
                        <strong>S/. ${formatNumber(order.ganancia_pen)}</strong>
                    </td>
                    <td class="text-end ${profitClass}">
                        <strong>${formatNumber(order.margen_porcentaje)}%</strong>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function getStatusBadge(status) {
        const statusMap = {
            'wc-completed': '<span class="badge bg-success">Completado</span>',
            'wc-processing': '<span class="badge bg-primary">Procesando</span>',
            'wc-pending': '<span class="badge bg-warning">Pendiente</span>',
            'wc-on-hold': '<span class="badge bg-info">En espera</span>',
            'wc-cancelled': '<span class="badge bg-danger">Cancelado</span>',
            'wc-refunded': '<span class="badge bg-secondary">Reembolsado</span>',
            'wc-failed': '<span class="badge bg-dark">Fallido</span>'
        };
        return statusMap[status] || `<span class="badge bg-secondary">${status}</span>`;
    }

    function formatNumber(num) {
        if (num === null || num === undefined) return '0.00';
        return parseFloat(num).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr + 'T00:00:00');
        return date.toLocaleDateString('es-PE', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Botón para volver arriba
    window.onscroll = function() {
        const backToTop = document.getElementById('back-to-top');
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            backToTop.style.display = 'block';
        } else {
            backToTop.style.display = 'none';
        }
    };

    document.getElementById('back-to-top').addEventListener('click', function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
</script>
{% endblock %}
