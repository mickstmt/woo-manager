{% extends "base.html" %}

{% block title %}Reporte de Ganancias - WooCommerce Manager{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        transition: transform 0.2s;
    }

    .metric-card:hover {
        transform: translateY(-5px);
    }

    .metric-value {
        font-size: 2rem;
        font-weight: bold;
    }

    .profit-positive {
        color: #28a745;
    }

    .profit-negative {
        color: #dc3545;
    }

    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }

    .table th {
        position: sticky;
        top: 0;
        background-color: var(--bs-body-bg);
        z-index: 10;
    }

    /* Estilos para filas expandidas con soporte modo oscuro */
    .details-row>td {
        background-color: var(--bs-tertiary-bg) !important;
    }

    .details-row .table {
        background-color: var(--bs-body-bg);
    }

    .details-row .table thead {
        background-color: var(--bs-secondary-bg);
    }

    .details-row .table thead th {
        background-color: var(--bs-secondary-bg);
        color: var(--bs-body-color);
    }

    .details-row .table tbody tr {
        background-color: var(--bs-body-bg);
    }

    .details-row .table tbody td {
        color: var(--bs-body-color);
        border-color: var(--bs-border-color);
    }

    /* ============================================
       RESPONSIVE STYLES
       ============================================ */

    @media (max-width: 992px) {
        .metric-value {
            font-size: 1.5rem;
        }

        .metric-card .card-body {
            padding: 0.75rem;
        }

        .metric-card h6 {
            font-size: 0.8rem;
        }
    }

    @media (max-width: 768px) {

        /* Header responsive */
        .col-12.d-flex.justify-content-between {
            flex-direction: column;
            gap: 15px;
        }

        /* Filtros responsive */
        .row.align-items-end>div {
            margin-bottom: 10px;
        }

        /* Métricas en 2 columnas */
        #metrics-container .col-md-3 {
            flex: 0 0 50%;
            max-width: 50%;
        }

        .metric-value {
            font-size: 1.3rem;
        }

        /* Tabs scrollables */
        .nav-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tabs .nav-link {
            white-space: nowrap;
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
        }

        /* Tabla más compacta */
        .table th,
        .table td {
            font-size: 0.8rem;
            padding: 0.4rem;
        }
    }

    @media (max-width: 576px) {

        /* Título más pequeño */
        h1 {
            font-size: 1.3rem;
        }

        /* Métricas en 1 columna o 2 muy compactas */
        #metrics-container .col-md-3 {
            flex: 0 0 50%;
            max-width: 50%;
        }

        .metric-value {
            font-size: 1.1rem;
        }

        .metric-card .card-body {
            padding: 0.5rem;
        }

        .metric-card h6 {
            font-size: 0.7rem;
            margin-bottom: 0.25rem;
        }

        /* Botones apilados */
        .row.align-items-end .col-md-2 {
            flex: 0 0 100%;
            max-width: 100%;
        }

        /* Ocultar texto en tabs, solo iconos */
        .nav-tabs .nav-link {
            padding: 0.5rem;
        }

        .nav-tabs .nav-link i {
            margin-right: 0;
        }

        /* Tabla ultra compacta */
        .table-responsive {
            font-size: 0.75rem;
        }

        .table th,
        .table td {
            padding: 0.3rem;
        }

        /* Ocultar columnas no esenciales en mobile */
        .table .hide-mobile {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-3 mb-md-4">
    <div
        class="col-12 d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
        <div>
            <h1 class="mb-0">
                <i class="bi bi-currency-dollar"></i> <span class="d-none d-sm-inline">Reporte de Ganancias</span><span
                    class="d-sm-none">Ganancias</span>
            </h1>
            <p class="text-muted mb-0 d-none d-md-block">Análisis de costos y ganancias por pedidos</p>
        </div>
        <div>
            <a href="/reports/profits/dashboard" class="btn btn-primary btn-sm btn-md-normal">
                <i class="bi bi-bar-chart-line-fill"></i> <span class="d-none d-sm-inline">Ver Dashboard</span><span
                    class="d-sm-none">Dashboard</span>
            </a>
        </div>
    </div>
</div>

<!-- Filtro de fechas -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Fecha Inicio</label>
                        <input type="date" id="start-date" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Fecha Fin</label>
                        <input type="date" id="end-date" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="loadReport()">
                            <i class="bi bi-search"></i> Generar Reporte
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success w-100" onclick="exportToExcel()">
                            <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pestañas de filtro por origen -->
<div class="row mb-3">
    <div class="col-12">
        <ul class="nav nav-tabs" id="sourceTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-source="all" type="button"
                    role="tab" onclick="changeSource('all')">
                    <i class="bi bi-globe"></i> Todos los Pedidos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="whatsapp-tab" data-bs-toggle="tab" data-source="whatsapp" type="button"
                    role="tab" onclick="changeSource('whatsapp')">
                    <i class="bi bi-whatsapp"></i> WhatsApp
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="woocommerce-tab" data-bs-toggle="tab" data-source="woocommerce"
                    type="button" role="tab" onclick="changeSource('woocommerce')">
                    <i class="bi bi-shop"></i> WooCommerce
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="externos-tab" data-bs-toggle="tab" data-source="externos" type="button"
                    role="tab" onclick="changeSource('externos')">
                    <i class="bi bi-file-earmark-text"></i> Externos
                </button>
            </li>
        </ul>
    </div>
</div>

<!-- Métricas principales -->
<div class="row mb-4" id="metrics-container">
    <div class="col-md-3 mb-3">
        <div class="card metric-card bg-primary text-white">
            <div class="card-body">
                <h6 class="card-title">Total Pedidos</h6>
                <div class="metric-value" id="total-pedidos">-</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card bg-info text-white">
            <div class="card-body">
                <h6 class="card-title">Ventas Totales (PEN)</h6>
                <div class="metric-value" id="ventas-totales">-</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card bg-warning text-dark">
            <div class="card-body">
                <h6 class="card-title">Costos Totales (PEN)</h6>
                <div class="metric-value" id="costos-totales">-</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title">Ganancia Total (PEN)</h6>
                <div class="metric-value" id="ganancias-totales">-</div>
                <small id="margen-promedio">Margen: -</small>
            </div>
        </div>
    </div>
</div>

<!-- Mensaje inicial cuando no hay reporte cargado -->
<div class="row mb-4" id="initial-message" style="display: none;">
    <div class="col-12">
        <div class="alert alert-info border-0 shadow-sm" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-info-circle-fill fs-3 me-3"></i>
                <div>
                    <h5 class="alert-heading mb-1">¡Bienvenido al Reporte de Ganancias!</h5>
                    <p class="mb-0">
                        Para comenzar, selecciona un <strong>rango de fechas</strong> y haz clic en el botón
                        <strong class="text-primary">
                            <i class="bi bi-search"></i> Generar Reporte
                        </strong>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de pedidos -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Ganancias por Pedido</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th style="width: 30px;"></th>
                                <th>Pedido</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th class="hide-mobile">Estado</th>
                                <th class="text-center hide-mobile">Items</th>
                                <th class="text-end">Venta (PEN)</th>
                                <th class="text-end hide-mobile">Tipo Cambio</th>
                                <th class="text-end hide-mobile">Costo (USD)</th>
                                <th class="text-end hide-mobile">Costo (PEN)</th>
                                <th class="text-end hide-mobile">Envío (PEN)</th>
                                <th class="text-end">Ganancia (PEN)</th>
                                <th class="text-end hide-mobile">Margen %</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table">
                            <tr>
                                <td colspan="13" class="text-center py-5">
                                    <div class="text-muted">
                                        <i
                                            class="bi bi-file-earmark-bar-graph display-1 d-block mb-3 text-secondary opacity-25"></i>
                                        <h5 class="text-muted">No hay datos para mostrar</h5>
                                        <p class="mb-0">Selecciona un rango de fechas y haz clic en "Generar Reporte"
                                        </p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Botón flotante para ir arriba -->
<button id="back-to-top" class="btn btn-primary rounded-circle"
    style="position: fixed; bottom: 20px; right: 20px; display: none; z-index: 1000;">
    <i class="bi bi-arrow-up"></i>
</button>

<!-- Modal: Filtro de Estados para Exportación -->
<div class="modal fade" id="exportFilterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Selecciona el formato y los estados de pedidos que deseas incluir:</p>

                <div class="mb-4">
                    <label class="form-label fw-bold"><i class="bi bi-layout-text-sidebar-reverse"></i> Tipo de
                        Reporte:</label>
                    <div class="d-flex gap-3 mt-1">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="report_type" id="report-consolidated"
                                value="consolidated" checked>
                            <label class="form-check-label" for="report-consolidated">
                                Consolidado <small class="text-muted d-block">(Un pedido por fila)</small>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="report_type" id="report-detailed"
                                value="detailed">
                            <label class="form-check-label" for="report-detailed">
                                Detallado <small class="text-muted d-block">(Un producto por fila)</small>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="form-label fw-bold"><i class="bi bi-check2-square"></i> Estados a incluir:</label>
                </div>

                <div class="mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="status-select-all" checked
                            onchange="toggleAllStatuses(this)">
                        <label class="form-check-label fw-bold" for="status-select-all">
                            Seleccionar todos
                        </label>
                    </div>
                    <hr class="my-2">
                </div>

                <div class="row">
                    <div class="col-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input export-status-check" type="checkbox" value="wc-completed"
                                id="status-completed" checked>
                            <label class="form-check-label" for="status-completed">
                                <span class="badge bg-success">Completado</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input export-status-check" type="checkbox" value="wc-processing"
                                id="status-processing" checked>
                            <label class="form-check-label" for="status-processing">
                                <span class="badge bg-primary">Procesando</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input export-status-check" type="checkbox" value="wc-on-hold"
                                id="status-on-hold" checked>
                            <label class="form-check-label" for="status-on-hold">
                                <span class="badge bg-info">En espera</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input export-status-check" type="checkbox" value="wc-enviado"
                                id="status-enviado" checked>
                            <label class="form-check-label" for="status-enviado">
                                <span class="badge" style="background-color: #17a2b8; color: white;">Enviado</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input export-status-check" type="checkbox" value="wc-en-transito"
                                id="status-en-transito" checked>
                            <label class="form-check-label" for="status-en-transito">
                                <span class="badge" style="background-color: #6f42c1; color: white;">En tránsito</span>
                            </label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input export-status-check" type="checkbox" value="wc-pending"
                                id="status-pending" checked>
                            <label class="form-check-label" for="status-pending">
                                <span class="badge bg-warning text-dark">Pendiente</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input export-status-check" type="checkbox" value="wc-cancelled"
                                id="status-cancelled">
                            <label class="form-check-label" for="status-cancelled">
                                <span class="badge bg-danger">Cancelado</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input export-status-check" type="checkbox" value="wc-refunded"
                                id="status-refunded">
                            <label class="form-check-label" for="status-refunded">
                                <span class="badge bg-secondary">Reembolsado</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input export-status-check" type="checkbox" value="wc-failed"
                                id="status-failed">
                            <label class="form-check-label" for="status-failed">
                                <span class="badge bg-dark">Fallido</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-3 mb-0">
                    <small><i class="bi bi-info-circle"></i> Los estados "Cancelado" y "Reembolsado" están desmarcados
                        por defecto.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="confirmExport()">
                    <i class="bi bi-download"></i> Exportar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Inicializar fechas (SIN cargar reporte automáticamente)
    document.addEventListener('DOMContentLoaded', function () {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(1); // Primer día del mes actual

        const startInput = document.getElementById('start-date');
        const endInput = document.getElementById('end-date');

        // Verificar si Flatpickr está inicializado
        if (startInput._flatpickr) {
            startInput._flatpickr.setDate(startDate, true);
        } else {
            startInput.valueAsDate = startDate;
        }

        if (endInput._flatpickr) {
            endInput._flatpickr.setDate(endDate, true);
        } else {
            endInput.valueAsDate = endDate;
        }

        // Mostrar mensaje inicial en lugar de cargar automáticamente
        showInitialMessage();
    });

    // Función para mostrar mensaje inicial
    function showInitialMessage() {
        const initialMessage = document.getElementById('initial-message');
        if (initialMessage) {
            initialMessage.style.display = 'block';
        }
    }

    // Función para ocultar mensaje inicial
    function hideInitialMessage() {
        const initialMessage = document.getElementById('initial-message');
        if (initialMessage) {
            initialMessage.style.display = 'none';
        }
    }

    // Variable global para almacenar el origen seleccionado
    let currentSource = 'all';

    // Función para cambiar el origen
    function changeSource(source) {
        currentSource = source;

        // Actualizar las clases active de las pestañas
        document.querySelectorAll('#sourceTabs .nav-link').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById(`${source}-tab`).classList.add('active');

        // Recargar el reporte con el nuevo filtro
        loadReport();
    }

    function loadReport() {
        const startDate = getDateValue('start-date');
        const endDate = getDateValue('end-date');

        if (!startDate || !endDate) {
            showAlert('Por favor selecciona ambas fechas para generar el reporte', 'warning');
            return;
        }

        // Ocultar mensaje inicial si está visible
        hideInitialMessage();

        // Mostrar loading
        document.getElementById('orders-table').innerHTML = `
            <tr>
                <td colspan="12" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </td>
            </tr>
        `;

        // Determinar el endpoint según el source
        let apiUrl;
        if (currentSource === 'externos') {
            apiUrl = `/reports/api/profits/externos?start_date=${startDate}&end_date=${endDate}`;
        } else {
            apiUrl = `/reports/api/profits?start_date=${startDate}&end_date=${endDate}&source=${currentSource}`;
        }

        // Llamar al API
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Para pedidos externos, la estructura es diferente
                    if (currentSource === 'externos') {
                        updateMetrics(data.summary);
                        updateTable(data.orders);
                    } else {
                        updateMetrics(data.data.summary);
                        updateTable(data.data.orders);
                    }
                } else {
                    showAlert('Error al cargar el reporte: ' + data.error, 'danger');
                    console.error(data);
                }
            })
            .catch(error => {
                showAlert('Error de conexión: ' + error, 'danger');
                console.error(error);
            });
    }

    function exportToExcel() {
        const startDate = getDateValue('start-date');
        const endDate = getDateValue('end-date');

        if (!startDate || !endDate) {
            showAlert('Por favor selecciona ambas fechas antes de exportar', 'warning');
            return;
        }

        // Mostrar modal de filtro de estados
        const modal = new bootstrap.Modal(document.getElementById('exportFilterModal'));
        modal.show();
    }

    // Toggle todos los checkboxes de estado
    function toggleAllStatuses(checkbox) {
        const isChecked = checkbox.checked;
        document.querySelectorAll('.export-status-check').forEach(cb => {
            cb.checked = isChecked;
        });
    }

    // Actualizar estado del "seleccionar todos" cuando cambian checkboxes individuales
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.export-status-check').forEach(cb => {
            cb.addEventListener('change', function () {
                updateSelectAllCheckbox();
            });
        });
    });

    function updateSelectAllCheckbox() {
        const allCheckboxes = document.querySelectorAll('.export-status-check');
        const checkedCheckboxes = document.querySelectorAll('.export-status-check:checked');
        const selectAllCb = document.getElementById('status-select-all');

        if (checkedCheckboxes.length === allCheckboxes.length) {
            selectAllCb.checked = true;
            selectAllCb.indeterminate = false;
        } else if (checkedCheckboxes.length === 0) {
            selectAllCb.checked = false;
            selectAllCb.indeterminate = false;
        } else {
            selectAllCb.checked = false;
            selectAllCb.indeterminate = true;
        }
    }

    // Confirmar exportación con los estados seleccionados
    function confirmExport() {
        const startDate = getDateValue('start-date');
        const endDate = getDateValue('end-date');

        // Obtener estados seleccionados
        const selectedStatuses = [];
        document.querySelectorAll('.export-status-check:checked').forEach(cb => {
            selectedStatuses.push(cb.value);
        });

        if (selectedStatuses.length === 0) {
            showAlert('Debes seleccionar al menos un estado', 'warning');
            return;
        }

        // Obtener tipo de reporte
        const reportType = document.querySelector('input[name="report_type"]:checked').value;

        // Cerrar modal
        bootstrap.Modal.getInstance(document.getElementById('exportFilterModal')).hide();

        // Mostrar mensaje de descarga
        showAlert('Generando archivo Excel... Por favor espera', 'info');

        // Crear URL con parámetros según el source
        const statusesParam = selectedStatuses.join(',');
        let url;
        if (currentSource === 'externos') {
            url = `/reports/api/profits/externos/export?start_date=${startDate}&end_date=${endDate}&statuses=${statusesParam}&report_type=${reportType}`;
        } else {
            url = `/reports/api/profits/export?start_date=${startDate}&end_date=${endDate}&source=${currentSource}&statuses=${statusesParam}&report_type=${reportType}`;
        }

        // Crear elemento <a> temporal para descargar
        const link = document.createElement('a');
        link.href = url;
        link.download = `ganancias_${currentSource}_${startDate}_${endDate}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Mostrar mensaje de éxito después de un breve delay
        setTimeout(() => {
            showAlert('Archivo Excel descargado exitosamente', 'success');
        }, 1000);
    }

    function updateMetrics(summary) {
        document.getElementById('total-pedidos').textContent = summary.total_pedidos;
        document.getElementById('ventas-totales').textContent = 'S/. ' + formatNumber(summary.ventas_totales_pen);
        document.getElementById('costos-totales').textContent = 'S/. ' + formatNumber(summary.costos_totales_pen);
        document.getElementById('ganancias-totales').textContent = 'S/. ' + formatNumber(summary.ganancias_totales_pen);
        document.getElementById('margen-promedio').textContent = 'Margen: ' + formatNumber(summary.margen_promedio_porcentaje) + '%';
    }

    function updateTable(orders) {
        const tbody = document.getElementById('orders-table');

        if (orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="13" class="text-center text-muted">
                        No hay pedidos en el rango seleccionado
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = orders.map((order, index) => {
            const profitClass = order.ganancia_pen >= 0 ? 'profit-positive' : 'profit-negative';
            const statusBadge = getStatusBadge(order.estado);
            const clienteNombre = order.cliente_nombre && order.cliente_apellido
                ? `${order.cliente_nombre} ${order.cliente_apellido}`
                : 'Sin nombre';

            const rowId = `order-${order.pedido_id}`;
            const detailsId = `details-${order.pedido_id}`;

            // Fila principal
            let html = `
                <tr class="order-row" style="cursor: pointer;" onclick="toggleDetails('${detailsId}', '${rowId}')">
                    <td class="text-center">
                        <i class="bi bi-chevron-right" id="icon-${rowId}"></i>
                    </td>
                    <td><a href="/orders/${order.pedido_id}" onclick="event.stopPropagation();">${order.numero_pedido}</a></td>
                    <td>${formatDate(order.fecha_pedido)}</td>
                    <td>${clienteNombre} ${order.is_community ? '<br><span class="badge" style="background-color: #6f42c1; font-size: 0.7rem;">Comunidad</span>' : ''}</td>
                    <td class="hide-mobile">${statusBadge}</td>
                    <td class="text-center hide-mobile"><span class="badge bg-secondary">${order.total_items}</span></td>
                    <td class="text-end">S/. ${formatNumber(order.total_venta_pen)}</td>
                    <td class="text-end hide-mobile">${formatNumber(order.tipo_cambio)}</td>
                    <td class="text-end hide-mobile">$ ${formatNumber(order.costo_total_usd)}</td>
                    <td class="text-end hide-mobile">S/. ${formatNumber(order.costo_total_pen)}</td>
                    <td class="text-end hide-mobile">S/. ${formatNumber(order.costo_envio_pen)}</td>
                    <td class="text-end ${profitClass}">
                        <strong>S/. ${formatNumber(order.ganancia_pen)}</strong>
                    </td>
                    <td class="text-end hide-mobile ${profitClass}">
                        <strong>${formatNumber(order.margen_porcentaje)}%</strong>
                    </td>
                </tr>
            `;

            // Fila de detalles (oculta por defecto)
            html += `
                <tr id="${detailsId}" class="details-row" style="display: none;">
                    <td colspan="13">
                        <div class="p-3">
                            <h6 class="mb-3"><i class="bi bi-box-seam"></i> Productos del pedido</h6>
                            <table class="table table-sm table-bordered mb-0">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-center">Cantidad</th>
                                        <th class="text-center">SKU</th>
                                        <th class="text-end">Costo Unit. (USD)</th>
                                        <th class="text-end">Costo Total (USD)</th>
                                        <th class="text-end">Costo Unit. (PEN)</th>
                                        <th class="text-end">Costo Total (PEN)</th>
                                        <th class="text-center">Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(order.items && order.items.length > 0) ? order.items.map(item => {
                const statusClass = !item.tiene_sku ? 'text-danger' : (!item.tiene_costo ? 'text-warning' : 'text-success');
                const statusText = !item.tiene_sku ? 'Sin SKU' : (!item.tiene_costo ? 'Sin costo en FC' : 'OK');
                const statusIcon = !item.tiene_sku ? 'x-circle-fill' : (!item.tiene_costo ? 'exclamation-triangle-fill' : 'check-circle-fill');

                const costoUnitPen = item.costo_unitario_usd * order.tipo_cambio;
                const costoTotalPen = item.costo_total_usd * order.tipo_cambio;

                return `
                                            <tr>
                                                <td>${item.producto}</td>
                                                <td class="text-center">${item.cantidad}</td>
                                                <td class="text-center"><code>${item.sku}</code></td>
                                                <td class="text-end">$ ${formatNumber(item.costo_unitario_usd)}</td>
                                                <td class="text-end">$ ${formatNumber(item.costo_total_usd)}</td>
                                                <td class="text-end">S/. ${formatNumber(costoUnitPen)}</td>
                                                <td class="text-end">S/. ${formatNumber(costoTotalPen)}</td>
                                                <td class="text-center ${statusClass}">
                                                    <i class="bi bi-${statusIcon}"></i> ${statusText}
                                                </td>
                                            </tr>
                                        `;
            }).join('') : '<tr><td colspan="8" class="text-center text-muted">No hay items en este pedido</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>
            `;

            return html;
        }).join('');
    }

    function toggleDetails(detailsId, rowId) {
        const detailsRow = document.getElementById(detailsId);
        const icon = document.getElementById('icon-' + rowId);

        if (detailsRow.style.display === 'none') {
            detailsRow.style.display = 'table-row';
            icon.className = 'bi bi-chevron-down';
        } else {
            detailsRow.style.display = 'none';
            icon.className = 'bi bi-chevron-right';
        }
    }

    function getStatusBadge(status) {
        const statusMap = {
            'wc-completed': '<span class="badge bg-success">Completado</span>',
            'wc-processing': '<span class="badge bg-primary">Procesando</span>',
            'wc-pending': '<span class="badge bg-warning">Pendiente</span>',
            'wc-on-hold': '<span class="badge bg-info">En espera</span>',
            'wc-enviado': '<span class="badge" style="background-color: #17a2b8; color: white;">Enviado</span>',
            'wc-en-transito': '<span class="badge" style="background-color: #6f42c1; color: white;">En tránsito</span>',
            'wc-cancelled': '<span class="badge bg-danger">Cancelado</span>',
            'wc-refunded': '<span class="badge bg-secondary">Reembolsado</span>',
            'wc-failed': '<span class="badge bg-dark">Fallido</span>'
        };
        return statusMap[status] || `<span class="badge bg-secondary">${status}</span>`;
    }

    function formatNumber(num) {
        if (num === null || num === undefined) return '0.00';
        return parseFloat(num).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr + 'T00:00:00');
        return date.toLocaleDateString('es-PE', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Botón para volver arriba
    window.onscroll = function () {
        const backToTop = document.getElementById('back-to-top');
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            backToTop.style.display = 'block';
        } else {
            backToTop.style.display = 'none';
        }
    };

    document.getElementById('back-to-top').addEventListener('click', function () {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
</script>
{% endblock %}