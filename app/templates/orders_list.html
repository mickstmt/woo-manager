{% extends "base.html" %}

{% block title %}Gestión de Pedidos - WooCommerce Manager{% endblock %}

{% block extra_css %}
<style>
    .order-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: box-shadow 0.2s;
    }

    .order-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .status-badge {
        font-size: 0.85rem;
        padding: 4px 10px;
    }

    .product-item {
        border: 1px solid #e9ecef;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        background: #f8f9fa;
    }

    .product-item .remove-btn {
        float: right;
        cursor: pointer;
        color: #dc3545;
    }

    #products-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .search-result-item {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
    }

    .search-result-item:hover {
        background: #f8f9fa;
    }

    /* Estilos para los botones de acción */
    .action-buttons-orders {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .action-buttons-orders .btn {
        padding: 0.65rem 1.25rem;
        font-size: 0.95rem;
        font-weight: 500;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .action-buttons-orders .btn i {
        font-size: 1.1rem;
    }

    /* Responsive: Header de pedidos en mobile */
    @media (max-width: 768px) {
        .page-header-orders {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 15px;
        }

        .page-header-orders h1 {
            font-size: 1.5rem;
        }

        .action-buttons-orders {
            flex-direction: column;
            width: 100%;
            gap: 10px;
        }

        .action-buttons-orders .btn {
            width: 100%;
            justify-content: center;
            padding: 0.75rem 1rem;
        }
    }

    /* Asegurar que los botones no se corten con el scroll */
    @media (min-width: 769px) {
        .page-header-orders {
            margin-bottom: 1.5rem;
        }
    }

    /* Responsive: Tarjetas de pedidos en móvil */
    @media (max-width: 767px) {
        .order-card {
            padding: 10px;
        }

        .order-card h5 {
            font-size: 1rem;
        }

        .order-customer-name {
            font-size: 0.9rem;
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        .order-card .row {
            row-gap: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4 page-header-orders">
            <h1>
                <i class="bi bi-cart-check"></i> Gestión de Pedidos
            </h1>
            <div class="action-buttons-orders">
                <a href="/orders/create?type=whatsapp" class="btn btn-success">
                    <i class="bi bi-whatsapp"></i> Nuevo Pedido WhatsApp
                </a>
                <a href="/orders/create?type=external" class="btn btn-primary">
                    <i class="bi bi-shop"></i> Nuevo Pedido Externo
                </a>
            </div>
        </div>

        <!-- Pestañas de canales -->
        <ul class="nav nav-tabs mb-3" id="orderChannelTabs" role="tablist">
            <!-- Pestaña 1: Pedidos WooCommerce (PRINCIPAL) -->
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="woocommerce-tab" data-bs-toggle="tab" data-bs-target="#woocommerce-orders"
                    type="button" role="tab" aria-controls="woocommerce-orders" aria-selected="true"
                    onclick="switchChannel('woocommerce')">
                    <i class="bi bi-cart3"></i> Pedidos Tienda
                    <span class="badge bg-primary ms-2" id="woocommerce-count">0</span>
                </button>
            </li>
            <!-- Pestaña 2: Pedidos WhatsApp -->
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="whatsapp-tab" data-bs-toggle="tab" data-bs-target="#whatsapp-orders"
                    type="button" role="tab" aria-controls="whatsapp-orders" aria-selected="false"
                    onclick="switchChannel('whatsapp')">
                    <i class="bi bi-whatsapp"></i> Pedidos WhatsApp
                    <span class="badge bg-success ms-2" id="whatsapp-count">0</span>
                </button>
            </li>
            <!-- Pestaña 3: Pedidos Externos -->
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="external-tab" data-bs-toggle="tab" data-bs-target="#external-orders"
                    type="button" role="tab" aria-controls="external-orders" aria-selected="false"
                    onclick="switchChannel('external')">
                    <i class="bi bi-shop"></i> Pedidos Externos
                    <span class="badge bg-warning ms-2" id="external-count">0</span>
                </button>
            </li>
        </ul>

        <div class="tab-content" id="orderChannelTabsContent">

            <!-- Tab WooCommerce (PRINCIPAL - ACTIVO) -->
            <div class="tab-pane fade show active" id="woocommerce-orders" role="tabpanel" aria-labelledby="woocommerce-tab">
                <!-- Filtros para WooCommerce -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="search-input-woocommerce"
                                        placeholder="Buscar por ID, email, nombre, teléfono...">
                                    <button class="btn btn-outline-secondary" id="clear-woocommerce" style="display:none;" onclick="clearSearch('woocommerce')" title="Limpiar búsqueda">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                    <button class="btn btn-primary" onclick="searchOrdersWooCommerce()">
                                        Buscar
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="status-filter-woocommerce">
                                    <option value="">Todos los estados</option>
                                    <option value="wc-pending">Pendiente</option>
                                    <option value="wc-processing">Procesando</option>
                                    <option value="wc-on-hold">En espera</option>
                                    <option value="wc-completed">Completado</option>
                                    <option value="wc-cancelled">Cancelado</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="source-filter-woocommerce">
                                    <option value="">Todas las fuentes</option>
                                    <option value="web">Web</option>
                                    <option value="marketplace">Marketplace</option>
                                    <option value="manual">Manual</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="per-page-select-woocommerce">
                                    <option value="20">20 por página</option>
                                    <option value="50">50 por página</option>
                                    <option value="100">100 por página</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading -->
                <div id="loading-woocommerce" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando pedidos...</p>
                </div>

                <!-- Lista de pedidos WooCommerce -->
                <div id="orders-container-woocommerce"></div>

                <!-- Paginación WooCommerce -->
                <div id="pagination-container-woocommerce" class="mt-3"></div>
            </div>
            <!-- Fin Tab WooCommerce -->

            <!-- Tab WhatsApp -->
            <div class="tab-pane fade" id="whatsapp-orders" role="tabpanel" aria-labelledby="whatsapp-tab">
                <!-- Filtros para WhatsApp -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="search-input"
                                        placeholder="Buscar por ID, email, nombre, teléfono o DNI...">
                                    <button class="btn btn-outline-secondary" id="clear-whatsapp" style="display:none;" onclick="clearSearch('whatsapp')" title="Limpiar búsqueda">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                    <button class="btn btn-primary" onclick="searchOrders()">
                                        Buscar
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="user-filter">
                                    <option value="">Todos los usuarios</option>
                                    <!-- Se llenará dinámicamente con JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="status-filter">
                                    <option value="">Todos los estados</option>
                                    <option value="wc-processing">Procesando</option>
                                    <option value="wc-on-hold">En espera</option>
                                    <option value="wc-completed">Completado</option>
                                    <option value="wc-cancelled">Cancelado</option>
                                    <option value="trash">Papelera</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="per-page-select">
                                    <option value="20">20 por página</option>
                                    <option value="50">50 por página</option>
                                    <option value="100">100 por página</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading -->
                <div id="loading" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando pedidos...</p>
                </div>

                <!-- Lista de pedidos WhatsApp -->
                <div id="orders-container"></div>

                <!-- Paginación WhatsApp -->
                <div id="pagination-container" class="mt-3"></div>
            </div>
            <!-- Fin Tab WhatsApp -->

            <!-- Tab Externos -->
            <div class="tab-pane fade" id="external-orders" role="tabpanel" aria-labelledby="external-tab">
                <!-- Filtros para Externos -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="search-input-external"
                                        placeholder="Buscar por ID, email, nombre, teléfono o DNI...">
                                    <button class="btn btn-outline-secondary" id="clear-external" style="display:none;" onclick="clearSearch('external')" title="Limpiar búsqueda">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                    <button class="btn btn-primary" onclick="searchOrdersExternal()">
                                        Buscar
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="source-filter">
                                    <option value="">Todas las fuentes</option>
                                    <option value="marketplace">Marketplace</option>
                                    <option value="tienda_fisica">Tienda Física</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="per-page-select-external">
                                    <option value="20">20 por página</option>
                                    <option value="50">50 por página</option>
                                    <option value="100">100 por página</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Externos -->
                <div id="loading-external" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando pedidos externos...</p>
                </div>

                <!-- Lista de pedidos externos -->
                <div id="orders-container-external"></div>

                <!-- Paginación Externos -->
                <div id="pagination-container-external" class="mt-3"></div>
            </div>
            <!-- Fin Tab Externos -->
        </div>
        <!-- Fin Tab Content -->
    </div>
</div>

<!-- Modal para crear pedido -->
<div class="modal fade" id="createOrderModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-cart-plus"></i> Crear Nuevo Pedido (Venta por WhatsApp)
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Columna izquierda: Datos del cliente -->
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-person"></i> Datos del Cliente
                        </h6>

                        <div class="mb-3">
                            <label class="form-label">Nombre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="customer-first-name" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Apellido <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="customer-last-name" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="customer-email" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Teléfono <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="customer-phone" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Dirección <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="customer-address" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ciudad <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="customer-city" value="Lima" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Departamento</label>
                                <input type="text" class="form-control" id="customer-state" value="Lima">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Código Postal</label>
                                <input type="text" class="form-control" id="customer-postcode" value="15001">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">País</label>
                                <input type="text" class="form-control" id="customer-country" value="PE" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Columna derecha: Productos -->
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-box"></i> Productos
                        </h6>

                        <!-- Buscador de productos -->
                        <div class="mb-3">
                            <label class="form-label">Buscar producto (por SKU o nombre)</label>
                            <input type="text" class="form-control" id="product-search"
                                placeholder="Escribe para buscar...">
                            <div id="product-search-results" class="border rounded mt-2"
                                style="display: none; max-height: 200px; overflow-y: auto;"></div>
                        </div>

                        <!-- Lista de productos agregados -->
                        <div id="products-list">
                            <p class="text-muted text-center py-4">
                                <i class="bi bi-inbox" style="font-size: 2rem;"></i><br>
                                No hay productos agregados
                            </p>
                        </div>

                        <!-- Total -->
                        <div class="mt-3 p-3 bg-light rounded">
                            <div class="d-flex justify-content-between mb-2">
                                <strong>Subtotal:</strong>
                                <span id="order-subtotal">S/ 0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <strong>IGV (18%):</strong>
                                <span id="order-tax">S/ 0.00</span>
                            </div>
                            <div class="d-flex justify-content-between border-top pt-2">
                                <strong style="font-size: 1.2rem;">TOTAL:</strong>
                                <strong style="font-size: 1.2rem;" id="order-total">S/ 0.00</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información adicional -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-credit-card"></i> Información de Pago
                        </h6>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Método de Pago</label>
                        <select class="form-select" id="payment-method">
                            <option value="cod">Yape</option>
                            <option value="cheque">Plin</option>
                            <option value="qr_dinamico">QR (Yape/Plin/BIM)</option>
                            <option value="bacs">Banca Virtual</option>
                            <option value="izipaypay">Izipay (Yape/Plin)</option>
                            <option value="woo-mercado-pago-basic">Mercado Pago</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Notas del Cliente</label>
                        <textarea class="form-control" id="customer-note" rows="2"
                            placeholder="Contactó por WhatsApp..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="createOrder()">
                    <i class="bi bi-check-circle"></i> Crear Pedido
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ver Detalle de Pedido Externo -->
<div class="modal fade" id="viewOrderExternalModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-eye"></i> Detalle de Pedido Externo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewOrderExternalContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Pedido Externo -->
<div class="modal fade" id="editOrderExternalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="bi bi-pencil"></i> Editar Pedido Externo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editOrderExternalForm">
                    <input type="hidden" id="edit-order-id">

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Solo se pueden editar los datos del cliente y notas. Los
                        productos no pueden ser modificados.
                    </div>

                    <h6 class="border-bottom pb-2 mb-3">Datos del Cliente</h6>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit-first-name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Apellido <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit-last-name" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="edit-email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Teléfono <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="edit-phone" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">DNI</label>
                            <input type="text" class="form-control" id="edit-dni">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">RUC</label>
                            <input type="text" class="form-control" id="edit-ruc">
                        </div>
                    </div>

                    <h6 class="border-bottom pb-2 mb-3 mt-4">Dirección de Envío</h6>

                    <div class="mb-3">
                        <label class="form-label">Dirección</label>
                        <input type="text" class="form-control" id="edit-address">
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ciudad</label>
                            <input type="text" class="form-control" id="edit-city">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Departamento</label>
                            <input type="text" class="form-control" id="edit-state">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Referencia</label>
                        <textarea class="form-control" id="edit-reference" rows="2"></textarea>
                    </div>

                    <h6 class="border-bottom pb-2 mb-3 mt-4">Información Adicional</h6>

                    <div class="mb-3">
                        <label class="form-label">Fuente del Pedido</label>
                        <select class="form-select" id="edit-external-source">
                            <option value="marketplace">Marketplace</option>
                            <option value="tienda_fisica">Tienda Física</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notas del Cliente</label>
                        <textarea class="form-control" id="edit-customer-note" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="saveOrderExternal()">
                    <i class="bi bi-save"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="deleteOrderExternalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="delete-order-id">
                <p class="mb-3">¿Estás seguro que deseas eliminar el pedido <strong id="delete-order-number"></strong>?
                </p>
                <div class="alert alert-warning">
                    <i class="bi bi-info-circle"></i> Esta acción restaurará el stock de los productos del pedido.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="deleteOrderExternal()">
                    <i class="bi bi-trash"></i> Eliminar Pedido
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    let currentChannel = 'woocommerce'; // 'woocommerce', 'whatsapp' o 'external'
    let currentPage = 1;
    let perPage = 20;
    let searchTerm = '';
    let userFilter = '';
    let statusFilter = '';
    let sourceFilter = ''; // Para pedidos externos
    let selectedProducts = [];

    // Variables para WooCommerce
    let currentPageWooCommerce = 1;
    let perPageWooCommerce = 20;
    let searchTermWooCommerce = '';
    let statusFilterWooCommerce = '';
    let sourceFilterWooCommerce = '';

    // Variables para externos
    let currentPageExternal = 1;
    let perPageExternal = 20;
    let searchTermExternal = '';

    $(document).ready(function () {
        // Cargar usuarios y pedidos WooCommerce (pestaña principal)
        loadUsers();
        loadOrdersWooCommerce();

        // Cargar contadores
        updateOrderCounts();

        // Eventos
        $('#user-filter').on('change', function () {
            userFilter = $(this).val();
            currentPage = 1;
            loadOrders();
        });

        $('#status-filter').on('change', function () {
            statusFilter = $(this).val();
            currentPage = 1;
            loadOrders();
        });

        $('#per-page-select').on('change', function () {
            perPage = parseInt($(this).val());
            currentPage = 1;
            loadOrders();
        });

        // Buscar productos mientras se escribe
        let searchTimeout;
        $('#product-search').on('input', function () {
            clearTimeout(searchTimeout);
            const query = $(this).val();

            if (query.length < 2) {
                $('#product-search-results').hide();
                return;
            }

            searchTimeout = setTimeout(function () {
                searchProducts(query);
            }, 300);
        });

        // Enter para buscar pedidos
        $('#search-input').on('keypress', function (e) {
            if (e.which === 13) {
                searchOrders();
            }
        });

        // Búsqueda en tiempo real - Pedidos WhatsApp (Debounced)
        let searchOrdersTimeout;
        $('#search-input').on('input', function () {
            clearTimeout(searchOrdersTimeout);
            searchOrdersTimeout = setTimeout(() => {
                const query = $(this).val().trim();
                if (query.length >= 3 || query.length === 0) {
                    searchOrders();
                }
            }, 600);
        });

        // ========================================
        // Event Listeners para Pedidos WooCommerce
        // ========================================

        // Enter para buscar pedidos WooCommerce
        $('#search-input-woocommerce').on('keypress', function (e) {
            if (e.which === 13) {
                searchOrdersWooCommerce();
            }
        });

        // Búsqueda en tiempo real - Pedidos WooCommerce (Debounced)
        let searchOrdersWooCommerceTimeout;
        $('#search-input-woocommerce').on('input', function () {
            clearTimeout(searchOrdersWooCommerceTimeout);
            searchOrdersWooCommerceTimeout = setTimeout(() => {
                const query = $(this).val().trim();
                if (query.length >= 3 || query.length === 0) {
                    searchOrdersWooCommerce();
                }
            }, 600);
        });

        // Filtros WooCommerce
        $('#status-filter-woocommerce').on('change', function () {
            searchOrdersWooCommerce();
        });

        $('#source-filter-woocommerce').on('change', function () {
            searchOrdersWooCommerce();
        });

        $('#per-page-select-woocommerce').on('change', function () {
            searchOrdersWooCommerce();
        });

        // ========================================
        // Fin Event Listeners WooCommerce
        // ========================================

        // Enter para buscar pedidos externos
        $('#search-input-external').on('keypress', function (e) {
            if (e.which === 13) {
                searchOrdersExternal();
            }
        });

        // Búsqueda en tiempo real - Pedidos Externos (Debounced)
        let searchExternalTimeout;
        $('#search-input-external').on('input', function () {
            clearTimeout(searchExternalTimeout);
            searchExternalTimeout = setTimeout(() => {
                const query = $(this).val().trim();
                if (query.length >= 3 || query.length === 0) {
                    searchOrdersExternal();
                }
            }, 600);
        });
    });

    function loadUsers() {
        $.ajax({
            url: '/orders/get-users',
            method: 'GET',
            success: function (response) {
                if (response.success && response.users.length > 0) {
                    const select = $('#user-filter');
                    response.users.forEach(user => {
                        // Mostrar nombre completo, no username
                        select.append(`<option value="${user.username}">${user.full_name}</option>`);
                    });
                }
            },
            error: function () {
                console.log('Error al cargar usuarios');
            }
        });
    }

    function searchOrders() {
        searchTerm = $('#search-input').val();
        currentPage = 1;
        loadOrders();
    }

    function clearSearch(tab) {
        const map = {
            'woocommerce': { input: '#search-input-woocommerce', btn: '#clear-woocommerce', fn: () => { searchTermWooCommerce = ''; currentPageWooCommerce = 1; loadOrdersWooCommerce(); } },
            'whatsapp':    { input: '#search-input',             btn: '#clear-whatsapp',    fn: () => { searchTerm = ''; currentPage = 1; loadOrders(); } },
            'external':    { input: '#search-input-external',    btn: '#clear-external',    fn: () => { searchTermExternal = ''; currentPageExternal = 1; loadOrdersExternal(); } }
        };
        const cfg = map[tab];
        if (!cfg) return;
        $(cfg.input).val('');
        $(cfg.btn).hide();
        cfg.fn();
    }

    // Mostrar/ocultar botón X según contenido de cada input
    $('#search-input-woocommerce').on('input', function() { $('#clear-woocommerce').toggle($(this).val().length > 0); });
    $('#search-input').on('input', function()             { $('#clear-whatsapp').toggle($(this).val().length > 0); });
    $('#search-input-external').on('input', function()    { $('#clear-external').toggle($(this).val().length > 0); });

    function loadOrders(page = 1) {
        currentPage = page;
        $('#loading').show();
        $('#orders-container').hide();

        $.ajax({
            url: '/orders/list',
            method: 'GET',
            data: {
                page: currentPage,
                per_page: perPage,
                search: searchTerm,
                created_by: userFilter,
                status: statusFilter
            },
            success: function (response) {
                if (response.success) {
                    renderOrders(response.orders);
                    renderPagination(response.pagination);
                } else {
                    showNotification('error', 'Error al cargar pedidos');
                }
                $('#loading').hide();
                $('#orders-container').show();
            },
            error: function () {
                showNotification('error', 'Error de conexión');
                $('#loading').hide();
            }
        });
    }

    function renderOrders(orders) {
        const container = $('#orders-container');

        if (orders.length === 0) {
            container.html(`
            <div class="alert alert-info text-center">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <h5 class="mt-3">No se encontraron pedidos</h5>
                <p>Intenta con otros filtros de búsqueda</p>
            </div>
        `);
            return;
        }

        let html = '';
        orders.forEach(order => {
            const statusClass = order.status.includes('trash') ? 'secondary' :
                order.status.includes('delivered') ? 'success' :
                    order.status.includes('completed') ? 'info' :
                        order.status.includes('cancelled') ? 'danger' : 'warning';

            const statusText = order.status === 'trash' ? 'PAPELERA' :
                order.status.replace('wc-', '').replace('-', ' ').toUpperCase();

            html += `
            <div class="order-card" onclick="showOrderDetail(${order.id})" style="cursor: pointer;" title="Click para ver detalles">
                <div class="row align-items-center">
                    <div class="col-6 col-md-1">
                        <h5 class="mb-0 text-primary">${order.order_number || '#' + order.id}</h5>
                        <small class="text-muted d-none d-md-inline">ID: ${order.id}</small>
                        ${order.is_community ? '<div class="mt-1"><span class="badge" style="background-color: #6f42c1;">Comunidad</span></div>' : ''}
                        <!-- Info condensada solo en móvil -->
                        <div class="d-md-none mt-1">
                            <span class="badge bg-${statusClass} status-badge">${statusText}</span>
                        </div>
                    </div>
                    <div class="col-md-2 d-none d-md-block">
                        <span class="badge bg-${statusClass} status-badge">${statusText}</span><br>
                        <small class="text-muted"><i class="bi bi-person-badge"></i> ${order.created_by}</small>
                    </div>
                    <div class="col-6 col-md-3">
                        <strong class="order-customer-name">${order.customer_name}</strong><br>
                        <small class="text-muted d-none d-md-inline">${order.billing_email}</small>
                        <small class="text-muted d-none d-md-inline"><br><i class="bi bi-phone"></i> ${order.customer_phone}</small>
                        <!-- Solo teléfono en móvil -->
                        <small class="text-muted d-md-none"><i class="bi bi-phone"></i> ${order.customer_phone}</small>
                    </div>
                    <div class="col-6 col-md-2">
                        <strong>${order.currency} ${order.total.toFixed(2)}</strong><br>
                        <small class="text-muted d-none d-md-inline">${order.payment_method}</small>
                    </div>
                    <div class="col-md-2 d-none d-md-block">
                        <small class="text-muted">${order.date_created}</small><br>
                        <small class="text-muted"><i class="bi bi-box"></i> ${order.items_count} item(s)</small><br>
                        <small class="text-muted"><i class="bi bi-truck"></i> ${order.shipping_method}</small><br>
                        ${order.tracking_number ?
                    `<small class="text-success"><i class="bi bi-check-circle-fill"></i> ${order.tracking_number}</small>` :
                    `<small class="text-muted"><i class="bi bi-dash-circle"></i> Sin tracking</small>`
                }
                    </div>
                    <div class="col-6 col-md-2 text-end d-flex flex-column gap-2 justify-content-end align-items-end">
                        <a href="https://www.izistoreperu.com/wp-admin/admin.php?page=wc-orders&action=edit&id=${order.id}"
                           target="_blank"
                           class="btn btn-sm btn-outline-warning w-100 w-md-auto">
                            <i class="bi bi-box-arrow-up-right"></i> <span class="d-none d-lg-inline">Ver en WooCommerce</span>
                        </a>
                        ${['wc-pending', 'wc-processing', 'wc-on-hold'].includes(order.status) ?
                    `<a href="/orders/edit/${order.id}" class="btn btn-sm btn-primary w-100 w-md-auto">
                            <i class="bi bi-pencil"></i> <span class="d-none d-lg-inline">Editar</span>
                        </a>
                        <button type="button" class="btn btn-sm btn-outline-danger w-100 w-md-auto" onclick="confirmTrashOrder(${order.id}, '${order.order_number}')">
                            <i class="bi bi-trash"></i> <span class="d-none d-lg-inline">Papelera</span>
                        </button>` : ''}
                    </div>
                </div>
            </div>
        `;
        });

        container.html(html);
    }

    function renderPagination(pagination) {
        const container = $('#pagination-container');

        if (pagination.pages <= 1) {
            container.html('');
            return;
        }

        let html = '<nav><ul class="pagination justify-content-center">';

        // Anterior
        html += `<li class="page-item ${!pagination.has_prev ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadOrders(${pagination.prev_num}); return false;">Anterior</a>
             </li>`;

        // Números de página
        for (let i = 1; i <= pagination.pages; i++) {
            if (i === pagination.page) {
                html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
            } else if (i === 1 || i === pagination.pages || Math.abs(i - pagination.page) <= 2) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadOrders(${i}); return false;">${i}</a></li>`;
            } else if (Math.abs(i - pagination.page) === 3) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        // Siguiente
        html += `<li class="page-item ${!pagination.has_next ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadOrders(${pagination.next_num}); return false;">Siguiente</a>
             </li>`;

        html += '</ul></nav>';
        container.html(html);
    }

    function showCreateOrderModal() {
        selectedProducts = [];
        updateProductsList();
        calculateTotals();
        $('#createOrderModal').modal('show');
    }

    function searchProducts(query) {
        $.ajax({
            url: '/orders/search-products',
            method: 'GET',
            data: { q: query },
            success: function (response) {
                if (response.success) {
                    renderProductSearchResults(response.products);
                }
            }
        });
    }

    function renderProductSearchResults(products) {
        const container = $('#product-search-results');

        if (products.length === 0) {
            container.html('<div class="p-2 text-muted">No se encontraron productos</div>');
            container.show();
            return;
        }

        let html = '';
        products.forEach(product => {
            html += `
            <div class="search-result-item" onclick="addProduct(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${product.price}, ${product.stock})">
                <strong>${product.name}</strong><br>
                <small class="text-muted">SKU: ${product.sku} | Precio: S/ ${product.price.toFixed(2)} | Stock: ${product.stock}</small>
            </div>
        `;
        });

        container.html(html);
        container.show();
    }

    function addProduct(id, name, price, stock) {
        // Verificar si ya existe
        const existing = selectedProducts.find(p => p.id === id);
        if (existing) {
            showNotification('warning', 'Este producto ya está agregado');
            return;
        }

        selectedProducts.push({
            id: id,
            name: name,
            price: price,
            stock: stock,
            quantity: 1
        });

        updateProductsList();
        calculateTotals();

        // Limpiar búsqueda
        $('#product-search').val('');
        $('#product-search-results').hide();
    }

    function removeProduct(index) {
        selectedProducts.splice(index, 1);
        updateProductsList();
        calculateTotals();
    }

    function updateQuantity(index, change) {
        const product = selectedProducts[index];
        const newQty = product.quantity + change;

        if (newQty < 1) {
            showNotification('warning', 'La cantidad mínima es 1');
            return;
        }

        if (newQty > product.stock) {
            showNotification('warning', `Stock disponible: ${product.stock}`);
            return;
        }

        product.quantity = newQty;
        updateProductsList();
        calculateTotals();
    }

    function updateProductsList() {
        const container = $('#products-list');

        if (selectedProducts.length === 0) {
            container.html(`
            <p class="text-muted text-center py-4">
                <i class="bi bi-inbox" style="font-size: 2rem;"></i><br>
                No hay productos agregados
            </p>
        `);
            return;
        }

        let html = '';
        selectedProducts.forEach((product, index) => {
            html += `
            <div class="product-item">
                <span class="remove-btn" onclick="removeProduct(${index})">
                    <i class="bi bi-x-circle"></i>
                </span>
                <strong>${product.name}</strong><br>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="updateQuantity(${index}, -1)">-</button>
                        <button class="btn btn-outline-secondary" disabled>${product.quantity}</button>
                        <button class="btn btn-outline-secondary" onclick="updateQuantity(${index}, 1)">+</button>
                    </div>
                    <span>S/ ${(product.price * product.quantity).toFixed(2)}</span>
                </div>
            </div>
        `;
        });

        container.html(html);
    }

    function calculateTotals() {
        let subtotal = 0;
        selectedProducts.forEach(product => {
            subtotal += product.price * product.quantity;
        });

        const tax = subtotal * 0.18;
        const total = subtotal + tax;

        $('#order-subtotal').text(`S/ ${subtotal.toFixed(2)}`);
        $('#order-tax').text(`S/ ${tax.toFixed(2)}`);
        $('#order-total').text(`S/ ${total.toFixed(2)}`);
    }

    function createOrder() {
        // Validar campos del cliente
        const customer = {
            first_name: $('#customer-first-name').val().trim(),
            last_name: $('#customer-last-name').val().trim(),
            email: $('#customer-email').val().trim(),
            phone: $('#customer-phone').val().trim(),
            address_1: $('#customer-address').val().trim(),
            city: $('#customer-city').val().trim(),
            state: $('#customer-state').val().trim(),
            postcode: $('#customer-postcode').val().trim(),
            country: $('#customer-country').val().trim()
        };

        // Validaciones
        if (!customer.first_name || !customer.last_name) {
            showNotification('error', 'Nombre y apellido son requeridos');
            return;
        }

        if (!customer.email || !customer.email.includes('@')) {
            showNotification('error', 'Email válido es requerido');
            return;
        }

        if (!customer.phone) {
            showNotification('error', 'Teléfono es requerido');
            return;
        }

        if (!customer.address_1 || !customer.city) {
            showNotification('error', 'Dirección y ciudad son requeridas');
            return;
        }

        if (selectedProducts.length === 0) {
            showNotification('error', 'Debe agregar al menos un producto');
            return;
        }

        // Preparar items
        const items = selectedProducts.map(product => ({
            product_id: product.id,
            quantity: product.quantity,
            price: product.price
        }));

        // Datos del pedido
        const orderData = {
            customer: customer,
            items: items,
            payment_method: $('#payment-method').val(),
            payment_method_title: $('#payment-method option:selected').text(),
            customer_note: $('#customer-note').val().trim()
        };

        // Deshabilitar botón
        const btn = $('button[onclick="createOrder()"]');
        btn.prop('disabled', true);
        btn.html('<span class="spinner-border spinner-border-sm me-1"></span>Creando pedido...');

        // Enviar
        $.ajax({
            url: '/orders/create',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(orderData),
            success: function (response) {
                if (response.success) {
                    showNotification('success', response.message);
                    $('#createOrderModal').modal('hide');
                    loadOrders(); // Recargar lista

                    // Limpiar formulario
                    $('#createOrderModal input').val('');
                    $('#createOrderModal textarea').val('');
                    selectedProducts = [];
                    updateProductsList();
                } else {
                    showNotification('error', response.error || 'Error al crear pedido');
                }
                btn.prop('disabled', false);
                btn.html('<i class="bi bi-check-circle"></i> Crear Pedido');
            },
            error: function (xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error de conexión';
                showNotification('error', error);
                btn.prop('disabled', false);
                btn.html('<i class="bi bi-check-circle"></i> Crear Pedido');
            }
        });
    }

    function showNotification(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const html = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3"
             style="z-index: 9999; max-width: 500px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
        $('body').append(html);
        setTimeout(() => $('.alert').fadeOut(), 3000);
    }

    // ==================== FUNCIONES PARA PEDIDOS EXTERNOS ====================

    function switchChannel(channel) {
        currentChannel = channel;
        if (channel === 'woocommerce') {
            loadOrdersWooCommerce();
        } else if (channel === 'external') {
            loadOrdersExternal();
        } else {
            loadOrders(); // whatsapp
        }
    }

    // ============================================
    // FUNCIONES PARA PEDIDOS WOOCOMMERCE
    // ============================================

    function loadOrdersWooCommerce() {
        $('#loading-woocommerce').show();
        $('#orders-container-woocommerce').hide();

        $.ajax({
            url: '/orders/api/list-woocommerce',
            method: 'GET',
            data: {
                page: currentPageWooCommerce,
                per_page: perPageWooCommerce,
                search: searchTermWooCommerce,
                status: statusFilterWooCommerce,
                source: sourceFilterWooCommerce
            },
            success: function (response) {
                $('#loading-woocommerce').hide();
                $('#orders-container-woocommerce').show();

                if (response.success) {
                    renderWooCommerceOrders(response.orders);
                    renderPaginationWooCommerce(response.pagination);
                    $('#woocommerce-count').text(response.pagination.total);
                } else {
                    $('#orders-container-woocommerce').html(`
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> ${response.error || 'Error al cargar pedidos'}
                        </div>
                    `);
                }
            },
            error: function (xhr) {
                $('#loading-woocommerce').hide();
                $('#orders-container-woocommerce').show().html(`
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> Error de conexión
                    </div>
                `);
            }
        });
    }

    function searchOrdersWooCommerce() {
        searchTermWooCommerce = $('#search-input-woocommerce').val();
        statusFilterWooCommerce = $('#status-filter-woocommerce').val();
        sourceFilterWooCommerce = $('#source-filter-woocommerce').val();
        perPageWooCommerce = parseInt($('#per-page-select-woocommerce').val());
        currentPageWooCommerce = 1;
        loadOrdersWooCommerce();
    }

    function renderWooCommerceOrders(orders) {
        const container = $('#orders-container-woocommerce');

        if (orders.length === 0) {
            container.html(`
                <div class="alert alert-info text-center">
                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">No se encontraron pedidos</h5>
                    <p>Intenta con otros filtros de búsqueda</p>
                </div>
            `);
            return;
        }

        let html = '';
        orders.forEach(order => {
            const statusClass = order.status.includes('trash') ? 'secondary' :
                order.status.includes('delivered') ? 'success' :
                    order.status.includes('completed') ? 'info' :
                        order.status.includes('cancelled') ? 'danger' : 'warning';

            const statusText = order.status === 'trash' ? 'PAPELERA' :
                order.status.replace('wc-', '').replace('-', ' ').toUpperCase();

            const isCommunity = order.is_community === 'yes';
            const customerName = `${order.customer_first_name || ''} ${order.customer_last_name || ''}`.trim() || 'Sin nombre';

            html += `
            <div class="order-card" onclick="showOrderDetail(${order.id})" style="cursor: pointer;" title="Click para ver detalles">
                <div class="row align-items-center">
                    <div class="col-6 col-md-1">
                        <h5 class="mb-0 text-primary">${order.order_number}</h5>
                        <small class="text-muted d-none d-md-inline">ID: ${order.id}</small>
                        ${isCommunity ? '<div class="mt-1"><span class="badge" style="background-color: #6f42c1;">Comunidad</span></div>' : ''}
                        <!-- Info condensada solo en móvil -->
                        <div class="d-md-none mt-1">
                            <span class="badge bg-${statusClass} status-badge">${statusText}</span>
                        </div>
                    </div>
                    <div class="col-md-2 d-none d-md-block">
                        <span class="badge bg-${statusClass} status-badge">${statusText}</span><br>
                        ${order.order_source ? `<small class="text-muted"><i class="bi bi-tag"></i> ${order.order_source}</small>` : '<small class="text-muted"><i class="bi bi-globe"></i> Web</small>'}
                    </div>
                    <div class="col-6 col-md-3">
                        <strong class="order-customer-name">${customerName}</strong><br>
                        <small class="text-muted d-none d-md-inline">${order.customer_email}</small>
                        <small class="text-muted d-none d-md-inline"><br><i class="bi bi-phone"></i> ${order.customer_phone || 'N/A'}</small>
                        <!-- Solo teléfono en móvil -->
                        <small class="text-muted d-md-none"><i class="bi bi-phone"></i> ${order.customer_phone || 'N/A'}</small>
                    </div>
                    <div class="col-6 col-md-2">
                        <strong>${order.currency} ${parseFloat(order.total_amount).toFixed(2)}</strong><br>
                        <small class="text-muted d-none d-md-inline">${order.payment_method_title || order.payment_method || 'N/A'}</small>
                    </div>
                    <div class="col-md-2 d-none d-md-block">
                        <small class="text-muted">${order.date_created}</small><br>
                        <small class="text-muted"><i class="bi bi-box"></i> ${order.items_count} item(s)</small><br>
                        <small class="text-muted"><i class="bi bi-truck"></i> ${order.shipping_method || 'N/A'}</small><br>
                        ${order.tracking_number ?
                    `<small class="text-success"><i class="bi bi-check-circle-fill"></i> Con tracking</small>` :
                    `<small class="text-muted"><i class="bi bi-dash-circle"></i> Sin tracking</small>`
                }
                    </div>
                    <div class="col-6 col-md-2 text-end d-flex flex-column gap-2 justify-content-end align-items-end">
                        <a href="https://www.izistoreperu.com/wp-admin/admin.php?page=wc-orders&action=edit&id=${order.id}"
                           target="_blank"
                           class="btn btn-sm btn-outline-warning w-100 w-md-auto">
                            <i class="bi bi-box-arrow-up-right"></i> <span class="d-none d-lg-inline">Ver en WooCommerce</span>
                        </a>
                        ${['wc-pending', 'wc-processing', 'wc-on-hold'].includes(order.status) ?
                    `<a href="/orders/edit/${order.id}" class="btn btn-sm btn-primary w-100 w-md-auto">
                            <i class="bi bi-pencil"></i> <span class="d-none d-lg-inline">Editar</span>
                        </a>
                        <button type="button" class="btn btn-sm btn-outline-danger w-100 w-md-auto" onclick="confirmTrashOrder(${order.id}, '${order.order_number}')">
                            <i class="bi bi-trash"></i> <span class="d-none d-lg-inline">Papelera</span>
                        </button>` : ''}
                    </div>
                </div>
            </div>
        `;
        });

        container.html(html);
    }

    function renderPaginationWooCommerce(pagination) {
        const container = $('#pagination-container-woocommerce');

        if (pagination.pages <= 1) {
            container.html('');
            return;
        }

        let html = '<nav><ul class="pagination justify-content-center">';

        // Anterior
        html += `<li class="page-item ${!pagination.has_prev ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="gotoPageWooCommerce(${pagination.prev_num}); return false;">Anterior</a>
             </li>`;

        // Números de página (con lógica inteligente)
        for (let i = 1; i <= pagination.pages; i++) {
            if (i === pagination.page) {
                // Página actual
                html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
            } else if (i === 1 || i === pagination.pages || Math.abs(i - pagination.page) <= 2) {
                // Primera, última, o páginas cercanas (±2)
                html += `<li class="page-item"><a class="page-link" href="#" onclick="gotoPageWooCommerce(${i}); return false;">${i}</a></li>`;
            } else if (Math.abs(i - pagination.page) === 3) {
                // Mostrar "..." en la posición 3 de distancia
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        // Siguiente
        html += `<li class="page-item ${!pagination.has_next ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="gotoPageWooCommerce(${pagination.next_num}); return false;">Siguiente</a>
             </li>`;

        html += '</ul></nav>';
        container.html(html);
    }

    function gotoPageWooCommerce(page) {
        currentPageWooCommerce = page;
        loadOrdersWooCommerce();
    }

    // ============================================
    // MODAL DE DETALLES (para todos los pedidos)
    // ============================================

    function showOrderDetail(orderId) {
        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
        modal.show();

        // Mostrar loading
        $('#detail-loading').show();
        $('#detail-content').hide();
        $('#detail-error').hide();

        // Cargar datos del pedido
        $.ajax({
            url: `/orders/api/get-order-detail/${orderId}`,
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    try {
                        renderOrderDetail(response.order);
                        $('#detail-loading').hide();
                        $('#detail-content').show();
                    } catch (error) {
                        console.error('Error rendering order detail:', error);
                        showDetailError('Error al renderizar detalles del pedido: ' + error.message);
                    }
                } else {
                    showDetailError(response.error || 'Error al cargar detalles del pedido');
                }
            },
            error: function (xhr, status, error) {
                console.error('AJAX error:', status, error);
                showDetailError('Error de conexión al cargar detalles del pedido');
            }
        });
    }

    function renderOrderDetail(order) {
        // Validar que order existe
        if (!order) {
            throw new Error('Order object is null or undefined');
        }

        // Asegurar que products existe como array
        if (!order.products) {
            order.products = [];
        }

        // Número de pedido en el título
        $('#detail-order-number').text(order.order_number || 'N/A');

        // Información general
        const statusClass = order.status.includes('completed') ? 'success' :
            order.status.includes('processing') ? 'info' :
                order.status.includes('cancelled') ? 'danger' :
                    order.status.includes('pending') ? 'warning' : 'secondary';
        const statusText = order.status.replace('wc-', '').replace('-', ' ').toUpperCase();

        $('#detail-status').html(`<span class="badge bg-${statusClass}">${statusText}</span>`);
        $('#detail-date-created').text(order.date_created || 'N/A');
        $('#detail-date-modified').text(order.date_modified || 'N/A');
        $('#detail-source').text(order.order_source || (order.created_by ? 'WhatsApp' : 'Web'));

        // Mostrar creado por solo si existe
        if (order.created_by) {
            $('#detail-created-by').text(order.created_by);
            $('#detail-created-by-row').show();
        } else {
            $('#detail-created-by-row').hide();
        }

        // Pago
        $('#detail-payment-method').text(order.payment_method_title || order.payment_method || 'N/A');
        $('#detail-subtotal').text(`${order.currency} ${(order.subtotal || 0).toFixed(2)}`);
        $('#detail-shipping-cost').text(`${order.currency} ${(order.shipping.cost || 0).toFixed(2)}`);

        // Mostrar impuestos si existen
        if (order.total_tax && order.total_tax > 0) {
            $('#detail-tax').text(`${order.currency} ${order.total_tax.toFixed(2)}`);
            $('#detail-tax-row').show();
        } else {
            $('#detail-tax-row').hide();
        }

        // Calcular total correcto: Subtotal (con IGV) + Envío
        // En Perú, el subtotal ya incluye IGV, así que solo sumamos el envío
        const calculatedTotal = (order.subtotal || 0) + (order.shipping.cost || 0);
        $('#detail-total').text(`${order.currency} ${calculatedTotal.toFixed(2)}`);

        // Badges (COD, Comunidad)
        let badges = '';
        if (order.is_cod) {
            badges += '<span class="badge bg-warning text-dark me-1"><i class="bi bi-cash"></i> COD</span>';
        }
        if (order.is_community) {
            badges += '<span class="badge" style="background-color: #6f42c1;"><i class="bi bi-people"></i> Comunidad</span>';
        }
        if (badges) {
            $('#detail-badges').html(badges);
            $('#detail-badges-row').show();
        } else {
            $('#detail-badges-row').hide();
        }

        // Datos de facturación
        const billing = order.billing || {};
        $('#detail-billing-name').text(`${billing.first_name || ''} ${billing.last_name || ''}`.trim() || 'N/A');
        if (billing.company) {
            $('#detail-billing-company').text(billing.company).show();
        } else {
            $('#detail-billing-company').hide();
        }
        $('#detail-billing-email').text(billing.email || 'N/A');
        $('#detail-billing-phone').text(billing.phone || 'N/A');

        let billingAddress = [billing.address_1, billing.address_2, billing.city, billing.state, billing.postcode]
            .filter(x => x).join(', ') || 'N/A';
        $('#detail-billing-address').text(billingAddress);

        // Datos de envío
        const shipping = order.shipping || {};
        $('#detail-shipping-name').text(`${shipping.first_name || ''} ${shipping.last_name || ''}`.trim() || 'Igual que facturación');
        if (shipping.company) {
            $('#detail-shipping-company').text(shipping.company).show();
        } else {
            $('#detail-shipping-company').hide();
        }
        $('#detail-shipping-phone').text(shipping.phone || billing.phone || 'N/A');

        let shippingAddress = [shipping.address_1, shipping.address_2, shipping.city, shipping.state, shipping.postcode]
            .filter(x => x).join(', ') || 'Igual que facturación';
        $('#detail-shipping-address').text(shippingAddress);

        $('#detail-shipping-method').text(shipping.method || 'N/A');

        // Tracking
        if (order.tracking_number) {
            $('#detail-tracking').text(order.tracking_number);
            $('#detail-tracking-row').show();
        } else {
            $('#detail-tracking-row').hide();
        }

        // Referencia de dirección
        if (order.shipping.reference) {
            $('#detail-shipping-reference').text(order.shipping.reference);
            $('#detail-shipping-reference-row').show();
        } else {
            $('#detail-shipping-reference-row').hide();
        }

        // Productos
        let productsHtml = '';
        if (order.products && order.products.length > 0) {
            order.products.forEach(product => {
                // Calcular precios CON impuestos incluidos
                const productTax = product.tax || 0;
                const quantity = product.quantity || 1;
                const priceWithTax = (product.price || 0) + (productTax / quantity);
                const totalWithTax = (product.total || 0) + productTax;

                productsHtml += `
                    <tr>
                        <td>${product.name || 'N/A'}</td>
                        <td><code>${product.sku || 'N/A'}</code></td>
                        <td class="text-center">${quantity}</td>
                        <td class="text-end">${order.currency} ${priceWithTax.toFixed(2)}</td>
                        <td class="text-end fw-bold">${order.currency} ${totalWithTax.toFixed(2)}</td>
                    </tr>
                `;
            });
        } else {
            productsHtml = '<tr><td colspan="5" class="text-center text-muted">No hay productos</td></tr>';
        }
        $('#detail-products-table').html(productsHtml);

        // Notas del cliente
        if (order.customer_note) {
            $('#detail-customer-note').text(order.customer_note);
            $('#detail-notes-row').show();
        } else {
            $('#detail-notes-row').hide();
        }

        // Botones
        $('#detail-btn-woocommerce').attr('href', `https://www.izistoreperu.com/wp-admin/admin.php?page=wc-orders&action=edit&id=${order.id}`);

        if (['wc-pending', 'wc-processing', 'wc-on-hold'].includes(order.status)) {
            $('#detail-btn-edit').attr('href', `/orders/edit/${order.id}`).show();
        } else {
            $('#detail-btn-edit').hide();
        }
    }

    function showDetailError(message) {
        $('#detail-loading').hide();
        $('#detail-content').hide();
        $('#detail-error-message').text(message);
        $('#detail-error').show();
    }

    // ============================================
    // FIN FUNCIONES WOOCOMMERCE
    // ============================================

    function loadOrdersExternal() {
        $('#loading-external').show();
        $('#orders-container-external').hide();

        $.ajax({
            url: '/orders/list-external',
            method: 'GET',
            data: {
                page: currentPageExternal,
                per_page: perPageExternal,
                search: searchTermExternal,
                source: sourceFilter
            },
            success: function (response) {
                $('#loading-external').hide();
                $('#orders-container-external').show();

                if (response.success) {
                    renderOrdersExternal(response.orders);
                    renderPaginationExternal(response.pagination);
                } else {
                    $('#orders-container-external').html(`
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> ${response.error || 'Error al cargar pedidos'}
                    </div>
                `);
                }
            },
            error: function (xhr) {
                $('#loading-external').hide();
                $('#orders-container-external').show().html(`
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> Error de conexión
                </div>
            `);
            }
        });
    }

    function renderOrdersExternal(orders) {
        if (orders.length === 0) {
            $('#orders-container-external').html(`
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No se encontraron pedidos externos
            </div>
        `);
            return;
        }

        let html = '';
        orders.forEach(order => {
            const badgeClass = 'bg-success'; // Siempre completed
            const statusText = 'Completado';

            html += `
            <div class="order-card">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="mb-2">
                            <span class="badge ${badgeClass}">${statusText}</span>
                            Pedido #${order.order_number}
                            <span class="badge bg-secondary">${order.external_source || 'Externo'}</span>
                        </h5>
                        <p class="mb-1">
                            <strong><i class="bi bi-person"></i> ${order.customer_first_name} ${order.customer_last_name}</strong>
                        </p>
                        <p class="mb-1 text-muted">
                            <i class="bi bi-envelope"></i> ${order.customer_email} |
                            <i class="bi bi-telephone"></i> ${order.customer_phone}
                        </p>
                        <p class="mb-0 text-muted small">
                            <i class="bi bi-calendar"></i> ${order.date_created}
                            ${order.created_by ? `| <i class="bi bi-person-badge"></i> ${order.created_by}` : ''}
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <h4 class="text-success mb-3">S/ ${parseFloat(order.total_amount).toFixed(2)}</h4>
                        <div class="d-flex gap-2 justify-content-end">
                            <button class="btn btn-outline-primary btn-sm" onclick="viewOrderExternal(${order.id})" title="Ver Detalles">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="editOrderExternal(${order.id})" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="confirmDeleteOrderExternal(${order.id}, '${order.order_number}')" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        });

        $('#orders-container-external').html(html);
    }

    function renderPaginationExternal(pagination) {
        if (!pagination || pagination.pages <= 1) {
            $('#pagination-container-external').html('');
            return;
        }

        let html = '<nav><ul class="pagination justify-content-center">';

        // Botón anterior
        html += `
        <li class="page-item ${!pagination.has_prev ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="goToPageExternal(${pagination.prev_num}); return false;">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
    `;

        // Páginas
        for (let i = 1; i <= pagination.pages; i++) {
            if (i === 1 || i === pagination.pages || (i >= pagination.page - 2 && i <= pagination.page + 2)) {
                html += `
                <li class="page-item ${i === pagination.page ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToPageExternal(${i}); return false;">${i}</a>
                </li>
            `;
            } else if (i === pagination.page - 3 || i === pagination.page + 3) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }

        // Botón siguiente
        html += `
        <li class="page-item ${!pagination.has_next ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="goToPageExternal(${pagination.next_num}); return false;">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
    `;

        html += '</ul></nav>';
        $('#pagination-container-external').html(html);
    }

    function goToPageExternal(page) {
        if (page) {
            currentPageExternal = page;
            loadOrdersExternal();
        }
    }

    function searchOrdersExternal() {
        searchTermExternal = $('#search-input-external').val().trim();
        currentPageExternal = 1;
        loadOrdersExternal();
    }

    function viewOrderExternal(orderId) {
        // Mostrar modal con loading
        $('#viewOrderExternalContent').html(`
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    `);
        $('#viewOrderExternalModal').modal('show');

        // Obtener datos del pedido
        $.ajax({
            url: `/orders/external/${orderId}`,
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    renderExternalOrderDetail(response.order);
                } else {
                    $('#viewOrderExternalContent').html(`
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> ${response.error || 'Error al cargar el pedido'}
                    </div>
                `);
                }
            },
            error: function (xhr) {
                $('#viewOrderExternalContent').html(`
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> Error de conexión
                </div>
            `);
            }
        });
    }

    function renderExternalOrderDetail(order) {
        const sourceLabels = {
            'marketplace': 'Marketplace',
            'tienda_fisica': 'Tienda Física',
            'otro': 'Otro'
        };

        let itemsHtml = '';
        if (order.items && order.items.length > 0) {
            order.items.forEach(item => {
            itemsHtml += `
            <tr>
                <td>${item.product_name}</td>
                <td>${item.product_sku}</td>
                <td class="text-center">${item.quantity}</td>
                <td class="text-end">S/ ${item.unit_price.toFixed(2)}</td>
                <td class="text-end">S/ ${item.total.toFixed(2)}</td>
            </tr>
        `;
            });
        }

        const html = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="border-bottom pb-2 mb-3">
                    <i class="bi bi-info-circle"></i> Información del Pedido
                </h6>
                <table class="table table-sm">
                    <tr>
                        <th width="40%">Número de Pedido:</th>
                        <td><strong>${order.order_number}</strong></td>
                    </tr>
                    <tr>
                        <th>Fecha:</th>
                        <td>${order.date_created}</td>
                    </tr>
                    <tr>
                        <th>Estado:</th>
                        <td><span class="badge bg-success">Completado</span></td>
                    </tr>
                    <tr>
                        <th>Fuente:</th>
                        <td>${sourceLabels[order.external_source] || order.external_source}</td>
                    </tr>
                    <tr>
                        <th>Creado por:</th>
                        <td>${order.created_by}</td>
                    </tr>
                </table>

                <h6 class="border-bottom pb-2 mb-3 mt-4">
                    <i class="bi bi-person"></i> Datos del Cliente
                </h6>
                <table class="table table-sm">
                    <tr>
                        <th width="40%">Nombre:</th>
                        <td>${order.customer_first_name} ${order.customer_last_name}</td>
                    </tr>
                    <tr>
                        <th>Email:</th>
                        <td>${order.customer_email}</td>
                    </tr>
                    <tr>
                        <th>Teléfono:</th>
                        <td>${order.customer_phone}</td>
                    </tr>
                    ${order.customer_dni ? `<tr><th>DNI:</th><td>${order.customer_dni}</td></tr>` : ''}
                    ${order.customer_ruc ? `<tr><th>RUC:</th><td>${order.customer_ruc}</td></tr>` : ''}
                </table>

                ${order.shipping_address_1 ? `
                <h6 class="border-bottom pb-2 mb-3 mt-4">
                    <i class="bi bi-geo-alt"></i> Dirección de Envío
                </h6>
                <table class="table table-sm">
                    <tr>
                        <th width="40%">Dirección:</th>
                        <td>${order.shipping_address_1}</td>
                    </tr>
                    ${order.shipping_city ? `<tr><th>Ciudad:</th><td>${order.shipping_city}</td></tr>` : ''}
                    ${order.shipping_state ? `<tr><th>Departamento:</th><td>${order.shipping_state}</td></tr>` : ''}
                    ${order.shipping_reference ? `<tr><th>Referencia:</th><td>${order.shipping_reference}</td></tr>` : ''}
                </table>
                ` : ''}
            </div>

            <div class="col-md-6">
                <h6 class="border-bottom pb-2 mb-3">
                    <i class="bi bi-box"></i> Productos
                </h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Producto</th>
                                <th>SKU</th>
                                <th class="text-center">Cant.</th>
                                <th class="text-end">Precio</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                </div>

                <h6 class="border-bottom pb-2 mb-3 mt-4">
                    <i class="bi bi-calculator"></i> Totales
                </h6>
                <table class="table table-sm">
                    <tr>
                        <th width="40%">Subtotal:</th>
                        <td class="text-end">S/ ${order.subtotal.toFixed(2)}</td>
                    </tr>
                    ${order.discount_amount > 0 ? `
                    <tr>
                        <th>Descuento (${order.discount_percentage}%):</th>
                        <td class="text-end text-danger">- S/ ${order.discount_amount.toFixed(2)}</td>
                    </tr>
                    ` : ''}
                    ${order.shipping_cost > 0 ? `
                    <tr>
                        <th>Envío:</th>
                        <td class="text-end">S/ ${order.shipping_cost.toFixed(2)}</td>
                    </tr>
                    ` : ''}
                    <tr class="table-success">
                        <th><strong>TOTAL:</strong></th>
                        <td class="text-end"><strong>S/ ${order.total_amount.toFixed(2)}</strong></td>
                    </tr>
                </table>

                ${order.payment_method ? `
                <h6 class="border-bottom pb-2 mb-3 mt-4">
                    <i class="bi bi-credit-card"></i> Pago
                </h6>
                <table class="table table-sm">
                    <tr>
                        <th width="40%">Método:</th>
                        <td>${order.payment_method_title || order.payment_method}</td>
                    </tr>
                </table>
                ` : ''}

                ${order.customer_note ? `
                <h6 class="border-bottom pb-2 mb-3 mt-4">
                    <i class="bi bi-chat-left-text"></i> Notas
                </h6>
                <p class="text-muted">${order.customer_note}</p>
                ` : ''}
            </div>
        </div>
    `;

        $('#viewOrderExternalContent').html(html);
    }

    function editOrderExternal(orderId) {
        // Obtener datos del pedido
        $.ajax({
            url: `/orders/external/${orderId}`,
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    const order = response.order;

                    // Llenar formulario
                    $('#edit-order-id').val(order.id);
                    $('#edit-first-name').val(order.customer_first_name);
                    $('#edit-last-name').val(order.customer_last_name);
                    $('#edit-email').val(order.customer_email);
                    $('#edit-phone').val(order.customer_phone);
                    $('#edit-dni').val(order.customer_dni);
                    $('#edit-ruc').val(order.customer_ruc);
                    $('#edit-address').val(order.shipping_address_1);
                    $('#edit-city').val(order.shipping_city);
                    $('#edit-state').val(order.shipping_state);
                    $('#edit-reference').val(order.shipping_reference);
                    $('#edit-external-source').val(order.external_source);
                    $('#edit-customer-note').val(order.customer_note);

                    // Mostrar modal
                    $('#editOrderExternalModal').modal('show');
                } else {
                    showNotification('error', response.error || 'Error al cargar el pedido');
                }
            },
            error: function () {
                showNotification('error', 'Error de conexión');
            }
        });
    }

    function saveOrderExternal() {
        const orderId = $('#edit-order-id').val();

        // Validaciones básicas
        if (!$('#edit-first-name').val() || !$('#edit-last-name').val()) {
            showNotification('error', 'Nombre y apellido son requeridos');
            return;
        }

        if (!$('#edit-email').val() || !$('#edit-email').val().includes('@')) {
            showNotification('error', 'Email válido es requerido');
            return;
        }

        if (!$('#edit-phone').val()) {
            showNotification('error', 'Teléfono es requerido');
            return;
        }

        // Preparar datos
        const data = {
            customer_first_name: $('#edit-first-name').val().trim(),
            customer_last_name: $('#edit-last-name').val().trim(),
            customer_email: $('#edit-email').val().trim(),
            customer_phone: $('#edit-phone').val().trim(),
            customer_dni: $('#edit-dni').val().trim(),
            customer_ruc: $('#edit-ruc').val().trim(),
            shipping_address_1: $('#edit-address').val().trim(),
            shipping_city: $('#edit-city').val().trim(),
            shipping_state: $('#edit-state').val().trim(),
            shipping_reference: $('#edit-reference').val().trim(),
            external_source: $('#edit-external-source').val(),
            customer_note: $('#edit-customer-note').val().trim()
        };

        // Deshabilitar botón
        const btn = $('button[onclick="saveOrderExternal()"]');
        btn.prop('disabled', true);
        btn.html('<span class="spinner-border spinner-border-sm me-1"></span>Guardando...');

        // Enviar
        $.ajax({
            url: `/orders/external/${orderId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (response) {
                if (response.success) {
                    showNotification('success', response.message);
                    $('#editOrderExternalModal').modal('hide');
                    loadOrdersExternal(); // Recargar lista
                } else {
                    showNotification('error', response.error || 'Error al actualizar el pedido');
                }
                btn.prop('disabled', false);
                btn.html('<i class="bi bi-save"></i> Guardar Cambios');
            },
            error: function (xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error de conexión';
                showNotification('error', error);
                btn.prop('disabled', false);
                btn.html('<i class="bi bi-save"></i> Guardar Cambios');
            }
        });
    }

    function confirmDeleteOrderExternal(orderId, orderNumber) {
        $('#delete-order-id').val(orderId);
        $('#delete-order-number').text(orderNumber);
        $('#deleteOrderExternalModal').modal('show');
    }

    function deleteOrderExternal() {
        const orderId = $('#delete-order-id').val();

        // Deshabilitar botón
        const btn = $('button[onclick="deleteOrderExternal()"]');
        btn.prop('disabled', true);
        btn.html('<span class="spinner-border spinner-border-sm me-1"></span>Eliminando...');

        // Enviar
        $.ajax({
            url: `/orders/external/${orderId}`,
            method: 'DELETE',
            success: function (response) {
                if (response.success) {
                    showNotification('success', response.message);
                    $('#deleteOrderExternalModal').modal('hide');
                    loadOrdersExternal(); // Recargar lista
                    updateOrderCounts(); // Actualizar contador
                } else {
                    showNotification('error', response.error || 'Error al eliminar el pedido');
                }
                btn.prop('disabled', false);
                btn.html('<i class="bi bi-trash"></i> Eliminar Pedido');
            },
            error: function (xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error de conexión';
                showNotification('error', error);
                btn.prop('disabled', false);
                btn.html('<i class="bi bi-trash"></i> Eliminar Pedido');
            }
        });
    }

    function updateOrderCounts() {
        // Actualizar contador de WooCommerce
        $.ajax({
            url: '/orders/count',
            method: 'GET',
            data: { channel: 'woocommerce' },
            success: function (response) {
                if (response.success) {
                    $('#woocommerce-count').text(response.count);
                }
            }
        });

        // Actualizar contador de WhatsApp
        $.ajax({
            url: '/orders/count',
            method: 'GET',
            data: { channel: 'whatsapp' },
            success: function (response) {
                if (response.success) {
                    $('#whatsapp-count').text(response.count);
                }
            }
        });

        // Actualizar contador de Externos
        $.ajax({
            url: '/orders/count',
            method: 'GET',
            data: { channel: 'external' },
            success: function (response) {
                if (response.success) {
                    $('#external-count').text(response.count);
                }
            }
        });
    }

    // Eventos para filtros externos
    $('#source-filter').on('change', function () {
        sourceFilter = $(this).val();
        currentPageExternal = 1;
        loadOrdersExternal();
    });

    $('#per-page-select-external').on('change', function () {
        perPageExternal = parseInt($(this).val());
        currentPageExternal = 1;
        loadOrdersExternal();
    });

    $('#search-input-external').on('keypress', function (e) {
        if (e.which === 13) {
            searchOrdersExternal();
        }
    });
</script>

<!-- Modal de Confirmación de Papelera -->
<div class="modal fade" id="trashOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-trash"></i> Mover a la Papelera</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas mover el pedido <strong id="trash-order-number"></strong> a la papelera?
                </p>

                <div class="form-check p-3 border rounded bg-light">
                    <input class="form-check-input" type="checkbox" value="" id="restore-stock-check" checked>
                    <label class="form-check-label" for="restore-stock-check">
                        <strong>Restaurar Stock al Inventario</strong>
                        <div class="text-muted small mt-1">
                            Si se marca, se devolverán las unidades de este pedido al stock disponible de los productos.
                            <br>
                            <span class="text-danger">Desmarcar si el stock fue forzado o no debe contarse.</span>
                        </div>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirm-trash-btn">
                    <i class="bi bi-trash"></i> Mover a Papelera
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Detalles del Pedido -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-receipt"></i> Detalles del Pedido <span id="detail-order-number"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Loading -->
                <div id="detail-loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando detalles del pedido...</p>
                </div>

                <!-- Contenido del pedido -->
                <div id="detail-content" style="display: none;">
                    <!-- Sección 1: Información General -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-info-circle"></i> Información General</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td class="fw-bold" style="width: 40%;">Estado:</td>
                                    <td id="detail-status"></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Fecha de creación:</td>
                                    <td id="detail-date-created"></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Última modificación:</td>
                                    <td id="detail-date-modified"></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Fuente:</td>
                                    <td id="detail-source"></td>
                                </tr>
                                <tr id="detail-created-by-row" style="display: none;">
                                    <td class="fw-bold">Creado por:</td>
                                    <td id="detail-created-by"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-credit-card"></i> Pago</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td class="fw-bold" style="width: 40%;">Método de pago:</td>
                                    <td id="detail-payment-method"></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Subtotal:</td>
                                    <td id="detail-subtotal"></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Envío:</td>
                                    <td id="detail-shipping-cost"></td>
                                </tr>
                                <tr id="detail-tax-row" style="display: none;">
                                    <td class="fw-bold">Impuestos:</td>
                                    <td id="detail-tax" class="text-muted"></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold" style="font-size: 1.1rem;">TOTAL:</td>
                                    <td id="detail-total" class="fw-bold text-primary" style="font-size: 1.1rem;"></td>
                                </tr>
                                <tr id="detail-badges-row">
                                    <td class="fw-bold">Extras:</td>
                                    <td id="detail-badges"></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Sección 2: Cliente -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-person"></i> Datos de Facturación</h6>
                            <p class="mb-1"><strong id="detail-billing-name"></strong></p>
                            <p class="mb-1" id="detail-billing-company"></p>
                            <p class="mb-1"><i class="bi bi-envelope"></i> <span id="detail-billing-email"></span></p>
                            <p class="mb-1"><i class="bi bi-telephone"></i> <span id="detail-billing-phone"></span></p>
                            <p class="mb-0 text-muted small">
                                <i class="bi bi-geo-alt"></i>
                                <span id="detail-billing-address"></span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-truck"></i> Datos de Envío</h6>
                            <p class="mb-1"><strong id="detail-shipping-name"></strong></p>
                            <p class="mb-1" id="detail-shipping-company"></p>
                            <p class="mb-1"><i class="bi bi-telephone"></i> <span id="detail-shipping-phone"></span></p>
                            <p class="mb-1 text-muted small">
                                <i class="bi bi-geo-alt"></i>
                                <span id="detail-shipping-address"></span>
                            </p>
                            <p class="mb-0">
                                <strong>Método:</strong> <span id="detail-shipping-method"></span>
                            </p>
                            <p class="mb-0" id="detail-tracking-row" style="display: none;">
                                <strong>Tracking:</strong> <span id="detail-tracking" class="badge bg-success"></span>
                            </p>
                            <p class="mb-0" id="detail-shipping-reference-row" style="display: none;">
                                <i class="bi bi-signpost-2"></i>
                                <strong>Referencia:</strong> <span id="detail-shipping-reference" class="text-muted"></span>
                            </p>
                        </div>
                    </div>

                    <!-- Sección 3: Productos -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-box-seam"></i> Productos</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Producto</th>
                                            <th>SKU</th>
                                            <th class="text-center">Cantidad</th>
                                            <th class="text-end">Precio Unit.</th>
                                            <th class="text-end">Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detail-products-table">
                                        <!-- Se llenará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Sección 4: Notas -->
                    <div class="row" id="detail-notes-row" style="display: none;">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-chat-left-text"></i> Notas del Cliente</h6>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <span id="detail-customer-note"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error -->
                <div id="detail-error" class="alert alert-danger" style="display: none;">
                    <i class="bi bi-exclamation-triangle"></i>
                    <span id="detail-error-message"></span>
                </div>
            </div>
            <div class="modal-footer">
                <a id="detail-btn-woocommerce" href="#" target="_blank" class="btn btn-outline-warning">
                    <i class="bi bi-wordpress"></i> Ver en WooCommerce
                </a>
                <a id="detail-btn-edit" href="#" class="btn btn-primary" style="display: none;">
                    <i class="bi bi-pencil"></i> Editar
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let orderIdToTrash = null;

    function confirmTrashOrder(orderId, orderNumber) {
        orderIdToTrash = orderId;
        $('#trash-order-number').text('#' + orderNumber);
        $('#restore-stock-check').prop('checked', true); // Default checked
        $('#trashOrderModal').modal('show');
    }

    $('#confirm-trash-btn').on('click', function () {
        if (!orderIdToTrash) return;

        const restoreStock = $('#restore-stock-check').is(':checked');
        const $btn = $(this);

        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Procesando...');

        $.ajax({
            url: `/orders/trash/${orderIdToTrash}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ restore_stock: restoreStock }),
            success: function (response) {
                if (response.success) {
                    $('#trashOrderModal').modal('hide');

                    let msg = 'Pedido movido a la papelera.';
                    if (response.stock_restored) {
                        msg += ' Stock restaurado correctamente.';
                    }

                    // Reload orders según la pestaña activa
                    if (currentChannel === 'woocommerce') {
                        loadOrdersWooCommerce();
                    } else if (currentChannel === 'external') {
                        loadOrdersExternal();
                    } else {
                        loadOrders(currentPage);
                    }

                    // Mostrar feedback (si hay toast container global)
                    if (typeof showToast === 'function') {
                        showToast('success', msg);
                    } else {
                        alert(msg);
                    }
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function (xhr) {
                alert('Error de conexión al mover a papelera');
            },
            complete: function () {
                $btn.prop('disabled', false).html('<i class="bi bi-trash"></i> Mover a Papelera');
                orderIdToTrash = null;
            }
        });
    });
</script>
{% endblock %}