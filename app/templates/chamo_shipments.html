{% extends "base.html" %}

{% block title %}Registro de Envíos CHAMO{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-bicycle"></i> Registro de Envíos CHAMO</h2>
            <p class="text-muted">Control y facturación de envíos realizados por CHAMO</p>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4" id="stats-container">
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Total Envíos</h6>
                    <h3 id="stat-total">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Envíos COD</h6>
                    <h3 id="stat-cod">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Total Pedidos</h6>
                    <h3 id="stat-amount">S/ -</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Total COD</h6>
                    <h3 id="stat-cod-amount">S/ -</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-primary">
                <div class="card-body">
                    <h6 class="text-muted">Costo Envío</h6>
                    <h3 id="stat-shipping-cost" class="text-primary">S/ -</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Fecha Desde</label>
                            <input type="date" class="form-control" id="filter-date-from" autocomplete="off">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fecha Hasta</label>
                            <input type="date" class="form-control" id="filter-date-to" autocomplete="off">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" id="filter-cod">
                                <option value="">Todos</option>
                                <option value="true">Solo COD</option>
                                <option value="false">Solo Normal</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="loadShipments()">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-success w-100" onclick="exportCSV()">
                                <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="shipments-table">
                            <thead>
                                <tr>
                                    <th>Pedido</th>
                                    <th>Fecha Entrega</th>
                                    <th>Cliente</th>
                                    <th>Distrito</th>
                                    <th>Total</th>
                                    <th>Costo Envío</th>
                                    <th>COD</th>
                                    <th>Enviado Por</th>
                                    <th>Fecha Envío</th>
                                </tr>
                            </thead>
                            <tbody id="shipments-tbody">
                                <tr>
                                    <td colspan="9" class="text-center">
                                        <div class="spinner-border"></div>
                                        <p>Cargando envíos...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Confirmar edición de costo de envío -->
<div class="modal fade" id="confirmShippingCostModal" tabindex="-1" aria-labelledby="confirmShippingCostModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="confirmShippingCostModalLabel">
                    <i class="bi bi-pencil-square"></i> Editar Costo de Envío
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">¿Guardar el nuevo costo para el pedido <strong id="confirm-order-number"></strong>?</p>
                <div class="d-flex justify-content-between text-muted mb-1">
                    <span>Anterior:</span>
                    <span id="confirm-old-cost"></span>
                </div>
                <div class="d-flex justify-content-between fw-bold">
                    <span>Nuevo:</span>
                    <span id="confirm-new-cost" class="text-primary"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary btn-sm" id="confirm-save-btn" onclick="confirmShippingCostUpdate()">
                    Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.shipping-cost-input {
    width: 75px;
    border: 1px solid transparent;
    background: transparent;
    color: var(--bs-primary);
    font-weight: bold;
    text-align: right;
    padding: 2px 4px;
    border-radius: 4px;
    font-size: inherit;
    -moz-appearance: textfield;
}
.shipping-cost-input::-webkit-outer-spin-button,
.shipping-cost-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.shipping-cost-input:hover {
    border-color: var(--bs-primary);
    cursor: text;
}
.shipping-cost-input:focus {
    border-color: var(--bs-primary);
    background: var(--bs-body-bg);
    outline: none;
    box-shadow: 0 0 0 2px rgba(var(--bs-primary-rgb), 0.15);
}
</style>

<script>
let pendingShippingCostUpdate = null;
let shippingCostSaved = false;

// Load shipments with filters
async function loadShipments() {
    const dateFrom = document.getElementById('filter-date-from').value;
    const dateTo = document.getElementById('filter-date-to').value;
    const isCod = document.getElementById('filter-cod').value;

    const params = new URLSearchParams();
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);
    if (isCod) params.append('is_cod', isCod);

    try {
        const response = await fetch(`/dispatch/api/chamo-shipments?${params}`);
        const data = await response.json();

        if (data.success) {
            renderShipments(data.shipments);
            loadStats();
        } else {
            console.error('Error loading shipments:', data.error);
            showError('Error cargando envíos: ' + data.error);
        }
    } catch (error) {
        console.error('Error loading shipments:', error);
        showError('Error de conexión al cargar envíos');
    }
}

// Render shipments table
function renderShipments(shipments) {
    const tbody = document.getElementById('shipments-tbody');

    if (shipments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No se encontraron envíos</td></tr>';
        return;
    }

    tbody.innerHTML = shipments.map(s => `
        <tr>
            <td><strong>${s.order_number}</strong></td>
            <td>${s.delivery_date || '-'}</td>
            <td>${s.customer_name || '-'}</td>
            <td>${s.customer_district || '-'}</td>
            <td>S/ ${(s.order_total || 0).toFixed(2)}</td>
            <td>
                <div class="d-flex align-items-center gap-1">
                    <span class="text-primary fw-bold">S/</span>
                    <input type="number"
                           class="shipping-cost-input"
                           data-shipment-id="${s.id}"
                           data-order-number="${s.order_number}"
                           data-original="${(s.shipping_cost || 0).toFixed(2)}"
                           value="${(s.shipping_cost || 0).toFixed(2)}"
                           step="0.10" min="0"
                           title="Presiona Enter para guardar"
                           onkeydown="onShippingCostKeydown(event, this)">
                </div>
            </td>
            <td>
                ${s.is_cod ? `<span class="badge bg-warning text-dark">COD S/ ${(s.cod_amount || 0).toFixed(2)}</span>` : '<span class="badge bg-secondary">Normal</span>'}
            </td>
            <td>${s.sent_by || '-'}</td>
            <td>${s.sent_at || '-'}</td>
        </tr>
    `).join('');
}

// Handle keydown on shipping cost input
function onShippingCostKeydown(event, input) {
    if (event.key === 'Enter') {
        event.preventDefault();

        const shipmentId = input.dataset.shipmentId;
        const orderNumber = input.dataset.orderNumber;
        const oldCost = parseFloat(input.dataset.original);
        const newCost = parseFloat(input.value);

        if (isNaN(newCost) || newCost < 0) {
            input.value = oldCost.toFixed(2);
            input.blur();
            return;
        }

        if (newCost === oldCost) {
            input.blur();
            return;
        }

        pendingShippingCostUpdate = { shipmentId, orderNumber, oldCost, newCost, input };
        shippingCostSaved = false;

        document.getElementById('confirm-order-number').textContent = orderNumber;
        document.getElementById('confirm-old-cost').textContent = `S/ ${oldCost.toFixed(2)}`;
        document.getElementById('confirm-new-cost').textContent = `S/ ${newCost.toFixed(2)}`;

        const modal = new bootstrap.Modal(document.getElementById('confirmShippingCostModal'));
        modal.show();
    }

    if (event.key === 'Escape') {
        input.value = parseFloat(input.dataset.original).toFixed(2);
        input.blur();
    }
}

// Confirm and save new shipping cost
async function confirmShippingCostUpdate() {
    if (!pendingShippingCostUpdate) return;

    const { shipmentId, newCost, oldCost, input } = pendingShippingCostUpdate;
    const btn = document.getElementById('confirm-save-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    try {
        const response = await fetch(`/dispatch/api/chamo-shipments/${shipmentId}/shipping-cost`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ shipping_cost: newCost })
        });
        const data = await response.json();

        if (data.success) {
            shippingCostSaved = true;
            input.dataset.original = newCost.toFixed(2);
            input.value = newCost.toFixed(2);
            bootstrap.Modal.getInstance(document.getElementById('confirmShippingCostModal')).hide();
            loadStats();
        } else {
            input.value = oldCost.toFixed(2);
            alert('Error al guardar: ' + (data.error || 'Error desconocido'));
            bootstrap.Modal.getInstance(document.getElementById('confirmShippingCostModal')).hide();
        }
    } catch (error) {
        input.value = oldCost.toFixed(2);
        alert('Error de conexión al guardar el costo');
        bootstrap.Modal.getInstance(document.getElementById('confirmShippingCostModal')).hide();
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Guardar';
        pendingShippingCostUpdate = null;
    }
}

// Reset on modal close (handles Escape / click outside)
document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('confirmShippingCostModal').addEventListener('hidden.bs.modal', function () {
        if (!shippingCostSaved && pendingShippingCostUpdate) {
            pendingShippingCostUpdate.input.value = pendingShippingCostUpdate.oldCost.toFixed(2);
        }
        pendingShippingCostUpdate = null;
        shippingCostSaved = false;
        const btn = document.getElementById('confirm-save-btn');
        btn.disabled = false;
        btn.innerHTML = 'Guardar';
    });
});

// Load statistics
async function loadStats() {
    const dateFrom = document.getElementById('filter-date-from').value;
    const dateTo = document.getElementById('filter-date-to').value;

    const params = new URLSearchParams();
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);

    try {
        const response = await fetch(`/dispatch/api/chamo-shipments/stats?${params}`);
        const data = await response.json();

        if (data.success) {
            document.getElementById('stat-total').textContent = data.stats.total_shipments;
            document.getElementById('stat-cod').textContent = data.stats.total_cod;
            document.getElementById('stat-amount').textContent = `S/ ${data.stats.total_amount.toFixed(2)}`;
            document.getElementById('stat-cod-amount').textContent = `S/ ${data.stats.total_cod_amount.toFixed(2)}`;
            document.getElementById('stat-shipping-cost').textContent = `S/ ${data.stats.total_shipping_cost.toFixed(2)}`;
        } else {
            console.error('Error loading stats:', data.error);
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Export to Excel
function exportCSV() {
    const dateFrom = document.getElementById('filter-date-from').value;
    const dateTo = document.getElementById('filter-date-to').value;
    const isCod = document.getElementById('filter-cod').value;

    const params = new URLSearchParams();
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);
    if (isCod) params.append('is_cod', isCod);

    window.location.href = `/dispatch/api/chamo-shipments/export?${params}`;
}

// Show error message
function showError(message) {
    const tbody = document.getElementById('shipments-tbody');
    tbody.innerHTML = `
        <tr>
            <td colspan="9" class="text-center text-danger">
                <i class="bi bi-exclamation-triangle"></i> ${message}
            </td>
        </tr>
    `;
}

// Load on page ready
document.addEventListener('DOMContentLoaded', function () {
    // Esperar a que Flatpickr termine de inicializarse
    setTimeout(function() {
        // Establecer fechas predeterminadas (primer día del mes hasta hoy)
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(1); // Primer día del mes actual

        const dateFromInput = document.getElementById('filter-date-from');
        const dateToInput = document.getElementById('filter-date-to');

        // Verificar si Flatpickr está inicializado (mismo patrón que reports_profits.html)
        if (dateFromInput._flatpickr) {
            dateFromInput._flatpickr.setDate(startDate, true);
        } else {
            dateFromInput.valueAsDate = startDate;
        }

        if (dateToInput._flatpickr) {
            dateToInput._flatpickr.setDate(endDate, true);
        } else {
            dateToInput.valueAsDate = endDate;
        }

        // Cargar datos iniciales
        loadShipments();
        loadStats();
    }, 200); // Esperar 200ms para que Flatpickr se inicialice
});
</script>
{% endblock %}
