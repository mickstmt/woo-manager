<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}WooCommerce Manager{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
        rel="stylesheet" />

    <!-- Flatpickr CSS (date picker en español) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">

    <!-- CSS personalizado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">

    <!-- Estilos para date pickers -->
    <style>
        /* Contenedor del date picker */
        .date-picker-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        /* Input del date picker con icono */
        .date-picker-wrapper .form-control {
            padding-right: 40px;
            cursor: pointer;
        }

        /* Icono de calendario */
        .date-picker-wrapper::after {
            content: "\f073";
            font-family: "bootstrap-icons";
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #6c757d;
            font-size: 1.1rem;
        }

        /* Placeholder personalizado para inputs vacíos */
        input.flatpickr-input:not([value]):not(:focus)::before {
            content: attr(placeholder);
            color: #6c757d;
        }

        /* Mejorar apariencia del calendario Flatpickr */
        .flatpickr-calendar {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            border-radius: 0.375rem;
            border: 1px solid #dee2e6;
        }

        .flatpickr-day.selected {
            background: #0d6efd;
            border-color: #0d6efd;
        }

        .flatpickr-day.today {
            border-color: #0d6efd;
        }

        .flatpickr-day:hover {
            background: #e9ecef;
        }

        .flatpickr-months .flatpickr-month {
            background: #0d6efd;
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months {
            background: #0d6efd;
        }

        .flatpickr-weekdays {
            background: #f8f9fa;
        }

        /* Estilos para enlaces deshabilitados en el sidebar */
        .sidebar .nav-link.disabled-link {
            cursor: not-allowed !important;
            opacity: 0.5;
            filter: grayscale(0.8);
            pointer-events: auto !important;
        }

        .sidebar .nav-link.disabled-link:hover {
            background: transparent !important;
            color: inherit !important;
            transform: none !important;
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>

<body>

    <!-- Badge de ambiente (solo visible si NO es producción) -->
    {% if not is_production %}
    <div class="alert alert-info alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-2 shadow"
        style="z-index: 9999; max-width: 400px;">
        <i class="bi bi-info-circle-fill"></i>
        <strong>Ambiente: {{ environment|upper }}</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    {% if current_user.is_authenticated %}
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Header: Logo + Toggle -->
            <div class="sidebar-header">
                <a href="/" class="sidebar-brand">
                    <div class="sidebar-brand-icon">
                        <i class="bi bi-shop"></i>
                    </div>
                    <span class="sidebar-brand-text">WooManager</span>
                </a>
            </div>

            <!-- Navegación -->
            <nav class="sidebar-nav">
                <!-- Sección: PRINCIPAL -->
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <ul class="nav-items">
                        <li class="nav-item">
                            <a href="/" class="nav-link" data-tooltip="Dashboard">
                                <span class="nav-link-icon"><i class="bi bi-speedometer2"></i></span>
                                <span class="nav-link-text">Dashboard</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/stock/" class="nav-link" data-tooltip="Inventario">
                                <span class="nav-link-icon"><i class="bi bi-boxes"></i></span>
                                <span class="nav-link-text">Inventario</span>
                            </a>
                        </li>
                        <li class="nav-item has-submenu" id="nav-productos">
                            <div class="nav-link-group">
                                <a href="/products/" class="nav-link" data-tooltip="Productos">
                                    <span class="nav-link-icon"><i class="bi bi-box-seam"></i></span>
                                    <span class="nav-link-text">Productos</span>
                                </a>
                                <button class="submenu-toggle-btn" data-submenu-id="productos"
                                    onclick="toggleSubmenu(event, this)">
                                    <span class="submenu-arrow"><i class="bi bi-chevron-down"></i></span>
                                </button>
                            </div>
                            <ul class="submenu">
                                <li class="nav-item">
                                    <a href="/products/" class="nav-link" data-tooltip="Listado">
                                        <span class="nav-link-icon"><i class="bi bi-list-ul"></i></span>
                                        <span class="nav-link-text">Listado</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/products/create" class="nav-link" data-tooltip="Crear Producto">
                                        <span class="nav-link-icon"><i class="bi bi-plus-circle"></i></span>
                                        <span class="nav-link-text">Nuevo Producto</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a href="/purchases/" class="nav-link" data-tooltip="Compras">
                                <span class="nav-link-icon"><i class="bi bi-cart-plus"></i></span>
                                <span class="nav-link-text">Compras</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/prices/" class="nav-link" data-tooltip="Precios">
                                <span class="nav-link-icon"><i class="bi bi-tag"></i></span>
                                <span class="nav-link-text">Precios</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Sección: OPERACIONES -->
                <div class="nav-section">
                    <div class="nav-section-title">Operaciones</div>
                    <ul class="nav-items">
                        <li class="nav-item">
                            <a href="/orders/" class="nav-link" data-tooltip="Pedidos">
                                <span class="nav-link-icon"><i class="bi bi-cart-check"></i></span>
                                <span class="nav-link-text">Pedidos</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="javascript:void(0)" class="nav-link disabled-link" data-tooltip="Cotizaciones">
                                <span class="nav-link-icon"><i class="bi bi-file-earmark-text"></i></span>
                                <span class="nav-link-text">Cotizaciones</span>
                            </a>
                        </li>
                        {% if current_user.is_master() %}
                        <li class="nav-item has-submenu" id="nav-despacho">
                            <div class="nav-link-group">
                                <a href="/dispatch/" class="nav-link" data-tooltip="Despacho">
                                    <span class="nav-link-icon"><i class="bi bi-kanban"></i></span>
                                    <span class="nav-link-text">Despacho</span>
                                </a>
                                <button class="submenu-toggle-btn" data-submenu-id="despacho"
                                    onclick="toggleSubmenu(event, this)">
                                    <span class="submenu-arrow"><i class="bi bi-chevron-down"></i></span>
                                </button>
                            </div>
                            <ul class="submenu">
                                <li class="nav-item">
                                    <a href="/dispatch/" class="nav-link" data-tooltip="Kanban">
                                        <span class="nav-link-icon"><i class="bi bi-columns-gap"></i></span>
                                        <span class="nav-link-text">Kanban</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/dispatch/bulk-tracking" class="nav-link" data-tooltip="Tracking Shalom">
                                        <span class="nav-link-icon"><i class="bi bi-truck"></i></span>
                                        <span class="nav-link-text">Tracking Shalom</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/dispatch/bulk-tracking-olva" class="nav-link"
                                        data-tooltip="Tracking OLVA">
                                        <span class="nav-link-icon"><i class="bi bi-box-seam"></i></span>
                                        <span class="nav-link-text">Tracking OLVA</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        {% endif %}
                        <li class="nav-item">
                            <a href="/history/" class="nav-link" data-tooltip="Historial">
                                <span class="nav-link-icon"><i class="bi bi-clock-history"></i></span>
                                <span class="nav-link-text">Historial</span>
                            </a>
                        </li>
                        <li class="nav-item has-submenu" id="nav-reportes">
                            <div class="nav-link-group">
                                <a href="/reports/" class="nav-link" data-tooltip="Reportes">
                                    <span class="nav-link-icon"><i class="bi bi-graph-up"></i></span>
                                    <span class="nav-link-text">Reportes</span>
                                </a>
                                <button class="submenu-toggle-btn" data-submenu-id="reportes"
                                    onclick="toggleSubmenu(event, this)">
                                    <span class="submenu-arrow"><i class="bi bi-chevron-down"></i></span>
                                </button>
                            </div>
                            <ul class="submenu">
                                <li class="nav-item">
                                    <a href="/reports/" class="nav-link" data-tooltip="Dashboard">
                                        <span class="nav-link-icon"><i class="bi bi-speedometer"></i></span>
                                        <span class="nav-link-text">Dashboard</span>
                                    </a>
                                </li>
                                {% if current_user.is_master() %}
                                <li class="nav-item">
                                    <a href="/reports/profits" class="nav-link" data-tooltip="Ganancias">
                                        <span class="nav-link-icon"><i class="bi bi-currency-dollar"></i></span>
                                        <span class="nav-link-text">Ganancias</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/dispatch/chamo-shipments" class="nav-link" data-tooltip="Registro CHAMO">
                                        <span class="nav-link-icon"><i class="bi bi-bicycle"></i></span>
                                        <span class="nav-link-text">Registro CHAMO</span>
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a href="{{ url_for('images.index') }}" class="nav-link" data-tooltip="Imágenes">
                                <span class="nav-link-icon"><i class="bi bi-image"></i></span>
                                <span class="nav-link-text">Imágenes</span>
                            </a>
                        </li>
                    </ul>
                </div>
                {% if current_user.username == 'mickstmt' %}
                <div class="nav-section">
                    <div class="nav-section-title">SISTEMA</div>
                    <ul class="nav-items">
                        <li class="nav-item">
                            <a href="javascript:void(0)" class="nav-link disabled-link" data-tooltip="Backup DB">
                                <span class="nav-link-icon"><i class="bi bi-database-down"></i></span>
                                <span class="nav-link-text">Backup Base de Datos</span>
                            </a>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </nav>

            <!-- Footer: Configuración + Logout -->
            <div class="sidebar-footer">
                <ul class="nav-items">
                    {% if current_user.is_admin() %}
                    <li class="nav-item">
                        <a href="{{ url_for('auth.admin_users') }}" class="nav-link" data-tooltip="Configuración">
                            <span class="nav-link-icon"><i class="bi bi-gear"></i></span>
                            <span class="nav-link-text">Configuración</span>
                        </a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a href="{{ url_for('auth.logout') }}" class="nav-link" data-tooltip="Cerrar Sesión">
                            <span class="nav-link-icon"><i class="bi bi-box-arrow-right"></i></span>
                            <span class="nav-link-text">Cerrar Sesión</span>
                        </a>
                    </li>
                </ul>
            </div>
        </aside>

        <!-- Contenido principal -->
        <main class="main-content">
            <!-- Topbar superior -->
            <div class="topbar">
                <!-- Toggle Sidebar (Desktop & Mobile) -->
                <div class="d-flex align-items-center">
                    <button class="sidebar-toggle-btn d-none d-md-flex" id="sidebarToggle" title="Alternar menú">
                        <i class="bi bi-list"></i>
                    </button>
                    <button class="sidebar-toggle-btn d-md-none" id="mobileMenuToggle" title="Menú">
                        <i class="bi bi-list"></i>
                    </button>
                </div>

                <div class="d-flex align-items-center gap-3">
                    <!-- Shipping Rates Toggle -->
                    <button class="theme-toggle-btn" id="shippingRatesToggle" title="Ver tarifario de envíos">
                        <i class="bi bi-tag"></i>
                    </button>

                    <!-- Theme Toggle -->
                    <button class="theme-toggle-btn" id="themeToggle" title="Cambiar tema">
                        <i class="bi bi-moon"></i>
                    </button>

                    <!-- Dropdown de usuario -->
                    <div class="user-dropdown">
                        <button class="user-dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <div class="user-avatar">
                                {% if current_user.avatar_file %}
                                <img src="{{ url_for('static', filename='uploads/avatars/' + current_user.avatar_file) }}"
                                    class="rounded-circle object-fit-cover" width="32" height="32"
                                    style="object-fit: cover;" alt="Avatar">
                                {% else %}
                                {{ current_user.username[0]|upper }}
                                {% endif %}
                            </div>
                            <span>{{ current_user.username }}</span>
                            {% if current_user.is_master() %}
                            <span class="badge bg-dark">Master</span>
                            {% elif current_user.role == 'admin' %}
                            <span class="badge bg-danger">Admin</span>
                            {% elif current_user.is_advisor() %}
                            <span class="badge bg-warning">Asesor</span>
                            {% else %}
                            <span class="badge bg-primary">Usuario</span>
                            {% endif %}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li class="dropdown-header">
                                <small class="text-muted">{{ current_user.email }}</small>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('auth.profile') }}">
                                    <i class="bi bi-person"></i> Mi Perfil
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('auth.change_password') }}">
                                    <i class="bi bi-key"></i> Cambiar Contraseña
                                </a>
                            </li>
                            {% if current_user.is_master() %}
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('expenses.index') }}">
                                    <i class="bi bi-receipt"></i> Gastos Detallados
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/reports/exchange-rate">
                                    <i class="bi bi-currency-exchange"></i> Tipo de Cambio
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Wrapper del contenido con padding -->
            <div class="content-wrapper">
                {% else %}
                <!-- Vista para usuarios no autenticados (login) -->
                <div class="container mt-4">
                    {% endif %}
                    {% block content %}{% endblock %}
                    {% if current_user.is_authenticated %}
                </div>
        </main>
    </div>
    {% else %}
    </div>
    {% endif %}

    <!-- jQuery (debe ir ANTES de Bootstrap para Select2) -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Flatpickr JS (date picker en español) -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/es.js"></script>

    {% if current_user.is_authenticated %}
    <!-- Sidebar Toggle y Estado Activo -->
    <script>
        (function () {
            // --- Sidebar Logic ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');

            // Cargar estado guardado del sidebar
            const savedState = localStorage.getItem('sidebarCollapsed');
            if (savedState === 'true') {
                sidebar.classList.add('collapsed');
            }

            // Toggle Desktop
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function () {
                    sidebar.classList.toggle('collapsed');
                    localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
                });
            }

            // --- Theme Logic (Dark Mode) ---
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = themeToggle.querySelector('i');
            const htmlElement = document.documentElement;

            // Función para establecer tema
            function setTheme(theme) {
                htmlElement.setAttribute('data-theme', theme);
                htmlElement.setAttribute('data-bs-theme', theme);
                localStorage.setItem('theme', theme);

                // Actualizar icono
                if (theme === 'dark') {
                    themeIcon.classList.remove('bi-moon');
                    themeIcon.classList.add('bi-sun');
                } else {
                    themeIcon.classList.remove('bi-sun');
                    themeIcon.classList.add('bi-moon');
                }
            }

            // Cargar tema guardado o preferencia del sistema
            const savedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme) {
                setTheme(savedTheme);
            } else if (systemDark) {
                setTheme('dark');
            }

            // Evento toggle tema
            if (themeToggle) {
                themeToggle.addEventListener('click', function () {
                    const currentTheme = htmlElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    setTheme(newTheme);
                });
            }

            // --- Active Link Logic ---
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.sidebar .nav-link');

            // 1. Primero limpiar todo rastro de activo/abierto antes de empezar
            document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.sidebar .has-submenu').forEach(l => l.classList.remove('open'));

            // 2. Encontrar el mejor match para la URL actual
            let bestMatch = null;
            let maxLen = -1;

            navLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (!href || href === '#' || href === '') return;

                let linkPath;
                try {
                    linkPath = new URL(href, window.location.origin).pathname;
                } catch (e) { return; }

                if (currentPath === linkPath) {
                    bestMatch = link;
                    maxLen = 999;
                } else if (linkPath !== '/' && currentPath.startsWith(linkPath)) {
                    if (linkPath.length > maxLen) {
                        bestMatch = link;
                        maxLen = linkPath.length;
                    }
                }
            });

            // 3. Activar y expandir solo lo necesario
            if (bestMatch) {
                bestMatch.classList.add('active');
                const parentHasSubmenu = bestMatch.closest('.has-submenu');
                if (parentHasSubmenu) {
                    parentHasSubmenu.classList.add('open');
                }
            }

            // --- Mobile Logic ---
            const overlay = document.createElement('div');
            overlay.className = 'sidebar-overlay';
            document.body.appendChild(overlay);

            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', function () {
                    sidebar.classList.toggle('mobile-open');
                    overlay.classList.toggle('active');
                });
            }

            overlay.addEventListener('click', function () {
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
            });

            // --- Submenu Toggle Function (global) ---
            window.toggleSubmenu = function (event, element) {
                event.stopPropagation();
                event.preventDefault();
                const parentItem = element.closest('.has-submenu');
                const submenuId = element.getAttribute('data-submenu-id');

                if (parentItem && submenuId) {
                    parentItem.classList.toggle('open');
                    // Guardar estado en localStorage con llave única
                    const isOpen = parentItem.classList.contains('open');
                    localStorage.setItem(`submenu-${submenuId}-open`, isOpen);
                }
            };

            // (Eliminado: Restauración automática de localStorage para evitar expansiones indeseadas)

            // --- Tooltips Logic ---
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-tooltip]'));
            const tooltipList = tooltipTriggerList.map(function (el) {
                // Configurar atributos de Bootstrap
                el.setAttribute('data-bs-title', el.getAttribute('data-tooltip'));
                el.setAttribute('data-bs-toggle', 'tooltip');
                el.setAttribute('data-bs-placement', 'right');
                return new bootstrap.Tooltip(el, {
                    trigger: 'hover focus', // Default trigger
                    customClass: 'custom-sidebar-tooltip' // Clase personalizada para estilos
                });
            });

            // Función para habilitar/deshabilitar tooltips según estado
            function updateTooltipState() {
                const isCollapsed = sidebar.classList.contains('collapsed');
                tooltipList.forEach(t => {
                    if (isCollapsed) {
                        t.enable();
                    } else {
                        t.disable();
                    }
                });
            }

            // Inicializar estado
            updateTooltipState();

            // Actualizar al hacer toggle
            if (sidebarToggle) {
                // Reemplazamos el listener anterior para incluir la actualización de tooltips
                // Nota: Esto agrega un SEGUNDO listener si no tenemos cuidado, pero el anterior ya estaba definido arriba.
                // Lo ideal es modificar el bloque de arriba.
                // Como este es un script inline, podemos anexar la llamada al listener existente si tuvieramos acceso,
                // pero como está en un closure, es mejor agregar otro listener que solo haga updateTooltipState
                sidebarToggle.addEventListener('click', function () {
                    // Esperamos un tick para que la clase cambie (aunque el otro listener es síncrono, el orden importa)
                    setTimeout(updateTooltipState, 0);
                });
            }
        })();
    </script>

    <!-- Verificador de sesión -->
    <script>
        (function () {
            const CHECK_INTERVAL = 10000;
            let sessionExpired = false;

            function checkSession() {
                if (sessionExpired) return;

                fetch('/auth/check-session', {
                    method: 'GET',
                    credentials: 'same-origin'
                })
                    .then(response => {
                        // Si no es 200 OK, la sesión expiró
                        if (!response.ok || response.status === 401 || response.redirected) {
                            showSessionExpiredModal();
                            return null;
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data && data.expired === true) {
                            showSessionExpiredModal();
                        }
                    })
                    .catch(() => {
                        // En caso de error de red, no hacer nada
                    });
            }

            function showSessionExpiredModal() {
                if (sessionExpired) return;
                sessionExpired = true;

                // Crear modal dinámicamente para asegurar que existe
                let modalEl = document.getElementById('sessionExpiredModal');

                if (!modalEl) {
                    // Si no existe, crearlo
                    const modalHTML = `
                    <div class="modal fade" id="sessionExpiredModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-0 shadow-lg">
                                <div class="modal-body text-center p-5">
                                    <div class="mb-4">
                                        <i class="bi bi-clock-history text-warning" style="font-size: 4rem;"></i>
                                    </div>
                                    <h4 class="mb-3">Sesión Expirada</h4>
                                    <p class="text-muted mb-4">
                                        Tu sesión ha expirado por inactividad.<br>
                                        Por favor, inicia sesión nuevamente para continuar.
                                    </p>
                                    <a href="/auth/login" class="btn btn-primary btn-lg px-5">
                                        <i class="bi bi-box-arrow-in-right me-2"></i>Iniciar Sesión
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                    modalEl = document.getElementById('sessionExpiredModal');
                }

                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            }

            // Verificar cada 10 segundos
            setInterval(checkSession, CHECK_INTERVAL);
        })();
    </script>
    {% endif %}

    <!-- Función global de paginación inteligente -->
    <script>
        /**
         * Genera HTML de paginación inteligente que muestra solo un rango de páginas
         * @param {object} pagination - Objeto con: page, pages, has_prev, has_next, prev_num, next_num
         * @param {function} loadFunction - Función a llamar cuando se cambia de página (ej: loadStockHistory)
         * @returns {string} HTML de la paginación
         */
        function buildSmartPagination(pagination, loadFunction) {
            if (pagination.pages <= 1) {
                return '';
            }

            let html = '<nav><ul class="pagination justify-content-center">';
            const currentPage = pagination.page;
            const totalPages = pagination.pages;
            const maxVisible = 5; // Número máximo de páginas visibles

            const funcName = loadFunction.name;

            // Botón Primera página
            if (currentPage > 1) {
                html += `<li class="page-item">
                <a class="page-link" href="#" onclick="${funcName}(1); return false;">
                    &laquo; Primera
                </a>
            </li>`;
            }

            // Botón anterior
            if (pagination.has_prev) {
                html += `<li class="page-item">
                <a class="page-link" href="#" onclick="${funcName}(${pagination.prev_num}); return false;">
                    Anterior
                </a>
            </li>`;
            }

            // Calcular rango de páginas a mostrar
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);

            // Ajustar si estamos cerca del final
            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            // Mostrar "..." si no empezamos en la página 1
            if (startPage > 1) {
                html += `<li class="page-item disabled">
                <span class="page-link">...</span>
            </li>`;
            }

            // Páginas visibles
            for (let i = startPage; i <= endPage; i++) {
                let active = i === currentPage ? 'active' : '';
                html += `<li class="page-item ${active}">
                <a class="page-link" href="#" onclick="${funcName}(${i}); return false;">
                    ${i}
                </a>
            </li>`;
            }

            // Mostrar "..." si no terminamos en la última página
            if (endPage < totalPages) {
                html += `<li class="page-item disabled">
                <span class="page-link">...</span>
            </li>`;
            }

            // Botón siguiente
            if (pagination.has_next) {
                html += `<li class="page-item">
                <a class="page-link" href="#" onclick="${funcName}(${pagination.next_num}); return false;">
                    Siguiente
                </a>
            </li>`;
            }

            // Botón Última página
            if (currentPage < totalPages) {
                html += `<li class="page-item">
                <a class="page-link" href="#" onclick="${funcName}(${totalPages}); return false;">
                    Última &raquo;
                </a>
            </li>`;
            }

            html += '</ul></nav>';
            return html;
        }

        // ===================================================================
        // CONFIGURACIÓN GLOBAL: Formato de fechas en español (dd/mm/yyyy)
        // ===================================================================

        /**
         * Convierte una fecha del formato dd/mm/yyyy a yyyy-mm-dd
         * @param {string} dateStr - Fecha en formato dd/mm/yyyy
         * @returns {string} Fecha en formato yyyy-mm-dd (ISO)
         */
        function convertDateToISO(dateStr) {
            if (!dateStr) return '';

            // Si ya está en formato ISO (yyyy-mm-dd), devolverla tal cual
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }

            // Si está en formato dd/mm/yyyy, convertir
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                return `${year}-${month}-${day}`;
            }

            // Intentar parsear como fecha
            try {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            } catch (e) {
                console.warn('Error converting date:', dateStr, e);
            }

            return dateStr;
        }

        /**
         * Obtiene el valor de un input de fecha y lo convierte a formato ISO
         * @param {string} elementId - ID del elemento input
         * @returns {string} Fecha en formato yyyy-mm-dd (ISO)
         */
        function getDateValue(elementId) {
            const input = document.getElementById(elementId);
            if (!input) return '';

            // Si el input tiene el atributo data-iso-date (Flatpickr), usarlo
            const isoDate = input.getAttribute('data-iso-date');
            if (isoDate) return isoDate;

            // Si no, intentar convertir el valor
            return convertDateToISO(input.value);
        }

        function initSpanishDatePickers() {
            // Configurar todos los inputs tipo date con Flatpickr en español
            const dateInputs = document.querySelectorAll('input[type="date"]');

            dateInputs.forEach(input => {
                // Guardar el valor original y atributos
                const originalValue = input.value;
                const placeholder = input.getAttribute('placeholder') || 'dd/mm/aaaa';
                const inputId = input.id;
                const inputName = input.name;
                const inputClasses = input.className;

                // Envolver el input en un contenedor para el icono
                const wrapper = document.createElement('div');
                wrapper.className = 'date-picker-wrapper';
                input.parentNode.insertBefore(wrapper, input);
                wrapper.appendChild(input);

                // Cambiar el tipo a text para que Flatpickr funcione correctamente
                input.type = 'text';
                input.placeholder = placeholder;

                // Agregar clase de Bootstrap para mejor apariencia
                if (!input.classList.contains('form-control')) {
                    input.classList.add('form-control');
                }

                // Inicializar Flatpickr con configuración en español
                const fp = flatpickr(input, {
                    locale: 'es',               // Idioma español
                    dateFormat: 'd/m/Y',        // Formato dd/mm/yyyy
                    allowInput: true,           // Permitir escritura manual
                    disableMobile: true,        // Forzar uso de Flatpickr en móviles también
                    defaultDate: originalValue || null,  // Fecha inicial si existe
                    onChange: function (selectedDates, dateStr, instance) {
                        // Mantener compatibilidad: guardar también en formato ISO
                        if (selectedDates.length > 0) {
                            const date = selectedDates[0];
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            input.setAttribute('data-iso-date', `${year}-${month}-${day}`);
                        } else {
                            input.removeAttribute('data-iso-date');
                        }
                    },
                    onReady: function (selectedDates, dateStr, instance) {
                        // Cuando Flatpickr está listo, asegurarse de que el input tenga el valor correcto
                        if (originalValue) {
                            instance.setDate(originalValue, false);
                        }
                    },
                    onOpen: function (selectedDates, dateStr, instance) {
                        // Limpiar el valor del input al abrir para evitar sugerencias molestas
                        // Esto previene que se muestren fechas antiguas en el dropdown
                        instance.input.value = dateStr;
                    }
                });

                // Hacer que el wrapper también abra el calendario al hacer click
                wrapper.addEventListener('click', function (e) {
                    if (e.target === wrapper) {
                        fp.open();
                    }
                });
            });
        }

        // Ejecutar al cargar el DOM
        document.addEventListener('DOMContentLoaded', function () {
            // Esperar a que Flatpickr esté disponible
            if (typeof flatpickr !== 'undefined') {
                initSpanishDatePickers();
            }
        });
    </script>

    {% block extra_js %}{% endblock %}

    <!-- Global Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 2000;">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="toast align-items-center text-white bg-{{ category if category != 'warning' else 'warning text-dark' }} border-0 shadow-lg"
            role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
            <div class="d-flex">
                <div class="toast-body d-flex align-items-center">
                    {% if category == 'success' %}
                    <i class="bi bi-check-circle-fill me-2 fs-5"></i>
                    {% elif category == 'danger' %}
                    <i class="bi bi-exclamation-octagon-fill me-2 fs-5"></i>
                    {% elif category == 'warning' %}
                    <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                    {% else %}
                    <i class="bi bi-info-circle-fill me-2 fs-5"></i>
                    {% endif %}
                    <div>{{ message }}</div>
                </div>
                <button type="button"
                    class="btn-close {{ 'btn-close-white' if category != 'warning' else '' }} me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}
    </div>

    <!-- Script para inicializar Toasts globales -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toastElList = [].slice.call(document.querySelectorAll('.toast'));
            const toastList = toastElList.map(function (toastEl) {
                return new bootstrap.Toast(toastEl);
            });
            toastList.forEach(toast => toast.show());
        });

        // Función global para mostrar notificaciones programáticamente
        function showNotification(category, message) {
            const container = document.querySelector('.toast-container');
            if (!container) return;

            const iconMap = {
                'success': 'bi-check-circle-fill',
                'danger': 'bi-exclamation-octagon-fill',
                'warning': 'bi-exclamation-triangle-fill',
                'info': 'bi-info-circle-fill'
            };

            const bgClass = category === 'warning' ? 'bg-warning text-dark' : `bg-${category} text-white`;
            const btnCloseClass = category === 'warning' ? '' : 'btn-close-white';
            const icon = iconMap[category] || iconMap.info;

            const toastHtml = `
                <div class="toast align-items-center ${bgClass} border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
                    <div class="d-flex">
                        <div class="toast-body d-flex align-items-center">
                            <i class="bi ${icon} me-2 fs-5"></i>
                            <div>${message}</div>
                        </div>
                        <button type="button" class="btn-close ${btnCloseClass} me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            const toastWrapper = document.createElement('div');
            toastWrapper.innerHTML = toastHtml.trim();
            const toastEl = toastWrapper.firstChild;

            container.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl);
            toast.show();

            // Eliminar del DOM después de ocultarse
            toastEl.addEventListener('hidden.bs.toast', () => {
                toastEl.remove();
            });
        }

        // Funciones para Toasts de carga (loading)
        let activeLoadingToast = null;

        function showLoadingToast(message = 'Procesando...') {
            const container = document.querySelector('.toast-container');
            if (!container) return;

            // Limpiar anterior si existe
            if (activeLoadingToast) {
                activeLoadingToast.hide();
            }

            const toastHtml = `
                <div id="loading-toast" class="toast align-items-center bg-info text-white border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
                    <div class="d-flex">
                        <div class="toast-body d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <div>${message}</div>
                        </div>
                    </div>
                </div>
            `;

            const toastWrapper = document.createElement('div');
            toastWrapper.innerHTML = toastHtml.trim();
            const toastEl = toastWrapper.firstChild;

            container.appendChild(toastEl);
            activeLoadingToast = new bootstrap.Toast(toastEl);
            activeLoadingToast.show();
        }

        function hideLoadingToast() {
            if (activeLoadingToast) {
                activeLoadingToast.hide();
                const toastEl = document.getElementById('loading-toast');
                if (toastEl) {
                    toastEl.addEventListener('hidden.bs.toast', () => {
                        toastEl.remove();
                    });
                }
                activeLoadingToast = null;
            }
        }
    </script>

    {% if current_user.is_authenticated %}
    <!-- Modal Tarifario de Envíos -->
    <div class="modal fade" id="shippingRatesModal" tabindex="-1" aria-labelledby="shippingRatesModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg overflow-hidden">
                <div class="modal-header bg-primary text-white border-0 py-3">
                    <h5 class="modal-title d-flex align-items-center" id="shippingRatesModalLabel">
                        <i class="bi bi-tag-fill me-2"></i> Tarifario de Envíos
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 bg-light-subtle">
                    <div id="ratesContent" class="row g-4 justify-content-center">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 text-muted">Cargando tarifario...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estilos Tarifario -->
    <style>
        .rate-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            height: 100%;
            transition: transform 0.2s;
            overflow: hidden;
        }

        .rate-card:hover {
            transform: translateY(-3px);
        }

        .rate-card-header {
            padding: 12px;
            font-weight: 700;
            text-align: center;
            font-size: 1.1rem;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
        }

        .rate-tier-8 .rate-card-header {
            background: #e3f2fd;
            color: #0d47a1;
        }

        .rate-tier-10 .rate-card-header {
            background: #fff3e0;
            color: #e65100;
        }

        .rate-tier-15 .rate-card-header {
            background: #f3e5f5;
            color: #4a148c;
        }

        [data-theme="dark"] .rate-tier-8 .rate-card-header {
            background: #0d47a1;
            color: #e3f2fd;
        }

        [data-theme="dark"] .rate-tier-10 .rate-card-header {
            background: #e65100;
            color: #fff3e0;
        }

        [data-theme="dark"] .rate-tier-15 .rate-card-header {
            background: #4a148c;
            color: #f3e5f5;
        }

        .rate-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .rate-item {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .rate-item:last-child {
            border-bottom: none;
        }

        .rate-item:hover {
            background: var(--bg-hover);
        }

        .rate-district {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .rate-details {
            font-size: 0.75rem;
            color: #6c757d;
            font-style: italic;
        }

        [data-theme="dark"] .rate-details {
            color: #adb5bd;
        }
    </style>

    <script>
        (function () {
            const toggle = document.getElementById('shippingRatesToggle');
            const modalEl = document.getElementById('shippingRatesModal');
            let loaded = false;

            if (toggle && modalEl) {
                const modal = new bootstrap.Modal(modalEl);
                toggle.addEventListener('click', () => {
                    modal.show();
                    if (!loaded) loadRates();
                });
            }

            async function loadRates() {
                const container = document.getElementById('ratesContent');
                try {
                    const res = await fetch('/dispatch/api/shipping-rates');
                    const data = await res.json();
                    if (data.success) {
                        renderRates(data.rates);
                        loaded = true;
                    }
                } catch (e) {
                    container.innerHTML = '<div class="alert alert-danger">Error al cargar</div>';
                }
            }

            function renderRates(rates) {
                const container = document.getElementById('ratesContent');
                container.innerHTML = '';
                const tiers = [
                    { k: '8.00', l: '8 SOLES', c: 'rate-tier-8' },
                    { k: '10.00', l: '10 SOLES', c: 'rate-tier-10' },
                    { k: '15.00', l: '15 SOLES', c: 'rate-tier-15' }
                ];
                tiers.forEach(t => {
                    const col = document.createElement('div');
                    col.className = 'col-md-4';
                    const items = (rates[t.k] || []).map(r => `
                        <li class="rate-item">
                            <span class="rate-district">${r.district}</span>
                            ${r.details ? `<span class="rate-details">${r.details}</span>` : ''}
                        </li>
                    `).join('');
                    col.innerHTML = `
                        <div class="rate-card ${t.c}">
                            <div class="rate-card-header">${t.l}</div>
                            <ul class="rate-list">${items}</ul>
                        </div>
                    `;
                    container.appendChild(col);
                });
            }
        })();
    </script>
    {% endif %}

</body>

</html>