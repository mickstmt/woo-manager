{% extends "base.html" %}

{% block title %}Crear Nuevo Pedido - WooCommerce Manager{% endblock %}

{% block extra_css %}
<style>
    /* Wizard Steps */
    .wizard-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .wizard-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        position: relative;
    }

    .wizard-steps::before {
        content: '';
        position: absolute;
        top: 25px;
        left: 0;
        right: 0;
        height: 2px;
        background: #dee2e6;
        z-index: 0;
    }

    .wizard-step {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 1;
    }

    .wizard-step-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #dee2e6;
        color: #6c757d;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 10px;
        transition: all 0.3s;
    }

    .wizard-step.active .wizard-step-circle {
        background: #0d6efd;
        color: white;
    }

    .wizard-step.completed .wizard-step-circle {
        background: #198754;
        color: white;
    }

    .wizard-step-label {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .wizard-step.active .wizard-step-label {
        color: #0d6efd;
        font-weight: 600;
    }

    /* Content areas */
    .wizard-content {
        display: none;
    }

    .wizard-content.active {
        display: block;
    }

    /* Sidebar de categorías */
    .categories-sidebar {
        height: calc(100vh - 250px);
        overflow-y: auto;
        border-right: 1px solid #dee2e6;
        padding-right: 15px;
    }

    .category-item {
        padding: 8px 12px;
        margin-bottom: 5px;
        cursor: pointer;
        border-radius: 5px;
        transition: all 0.2s;
    }

    .category-item:hover {
        background: #f8f9fa;
    }

    .category-item.active {
        background: #0d6efd;
        color: white;
    }

    .category-item.has-children {
        font-weight: 600;
    }

    .category-children {
        margin-left: 20px;
        display: none;
    }

    .category-children.expanded {
        display: block;
    }

    .category-toggle {
        cursor: pointer;
        margin-right: 5px;
    }

    /* Grid de productos */
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        max-height: calc(100vh - 250px);
        overflow-y: auto;
        padding: 10px;
    }

    /* Responsive: 2 columnas en mobile para ver 4 productos (2x2) */
    @media (max-width: 768px) {
        .products-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 5px;
        }
    }

    .product-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
    }

    .product-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .product-card img {
        width: 100%;
        height: 150px;
        object-fit: contain;
        border-radius: 5px;
        margin-bottom: 10px;
        background-color: #f8f9fa;
    }

    /* Imagen más pequeña en mobile */
    @media (max-width: 768px) {
        .product-card {
            padding: 8px;
        }

        .product-card img {
            height: 120px;
            margin-bottom: 5px;
        }
    }

    .product-card-name {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 5px;
        height: 40px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    /* Texto más pequeño en mobile */
    @media (max-width: 768px) {
        .product-card-name {
            font-size: 0.75rem;
            height: 32px;
            margin-bottom: 3px;
        }
    }

    .product-card-price {
        color: #198754;
        font-weight: bold;
        font-size: 1.1rem;
    }

    @media (max-width: 768px) {
        .product-card-price {
            font-size: 0.9rem;
        }
    }

    .product-card-sku {
        font-size: 0.8rem;
        color: #6c757d;
    }

    @media (max-width: 768px) {
        .product-card-sku {
            font-size: 0.7rem;
        }
    }

    /* Cart (sticky) */
    .cart-sidebar {
        position: sticky;
        top: 80px;
        height: calc(100vh - 100px);
        overflow-y: auto;
        border-left: 1px solid #dee2e6;
        padding: 15px;
        border-radius: 16px;
    }

    .cart-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        background: white;
        display: flex;
        gap: 12px;
        position: relative;
    }

    .cart-item-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        flex-shrink: 0;
    }

    .cart-item-info {
        flex: 1;
        min-width: 0;
    }

    .cart-item-remove {
        position: absolute;
        top: 8px;
        right: 8px;
        cursor: pointer;
        color: #dc3545;
        font-size: 1.2rem;
        line-height: 1;
    }

    .cart-item-remove:hover {
        color: #bb2d3b;
    }

    .cart-totals {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 15px;
        border-top: 2px solid #dee2e6;
        margin-top: 20px;
    }

    /* Lightbox para zoom de imágenes (móvil) */
    .image-lightbox {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease, visibility 0.2s ease;
        -webkit-tap-highlight-color: transparent;
    }

    .image-lightbox.active {
        opacity: 1;
        visibility: visible;
    }

    .image-lightbox img {
        max-width: 90%;
        max-height: 80%;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        transform: scale(0.9);
        transition: transform 0.2s ease;
    }

    .image-lightbox.active img {
        transform: scale(1);
    }

    .image-lightbox-hint {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        font-size: 0.9rem;
        opacity: 0.7;
    }

    /* Indicador visual de que la imagen es expandible (solo móvil) */
    @media (max-width: 768px) {
        .cart-item-image {
            cursor: zoom-in;
            position: relative;
        }

        .cart-item-image::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 3px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z'/%3E%3C/svg%3E");
            background-size: 10px;
            background-repeat: no-repeat;
            background-position: center;
        }
    }

    /* Selector Visual de Variaciones */
    .variation-swatches {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 15px;
        margin-top: 15px;
        margin-bottom: 20px;
    }

    .variation-swatch {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        position: relative;
    }

    .variation-swatch:hover {
        border-color: #0d6efd;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(13, 110, 253, 0.2);
    }

    .variation-swatch.active {
        border-color: #0d6efd;
        border-width: 3px;
        background: #e7f3ff;
    }

    .variation-swatch.out-of-stock {
        opacity: 0.6;
        cursor: pointer;
        /* Permitir selección para lógica de agregar stock temporal */
    }

    .variation-swatch.out-of-stock:hover {
        border-color: #ffc107;
        /* Color ámbar para indicar "sin stock pero seleccionable" */
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
    }

    .variation-swatch-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 8px;
    }

    .variation-swatch-label {
        font-size: 0.85rem;
        font-weight: 500;
        text-align: center;
        color: #495057;
        word-break: break-word;
    }

    .variation-swatch.active .variation-swatch-label {
        color: #0d6efd;
        font-weight: 600;
    }

    .variation-swatch-stock {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #28a745;
        border: 2px solid white;
    }

    .variation-swatch.out-of-stock .variation-swatch-stock {
        background: #dc3545;
    }

    @media (max-width: 768px) {
        .variation-swatches {
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
        }

        .variation-swatch-image {
            width: 60px;
            height: 60px;
        }

        .variation-swatch-label {
            font-size: 0.75rem;
        }
    }

    /* Form styling */
    .form-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .form-section h5 {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
    }

    /* Variations modal */
    .variation-item {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .variation-item:hover {
        border-color: #0d6efd;
        background: #f8f9fa;
    }

    .variation-attributes {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 5px;
    }

    .out-of-stock {
        opacity: 0.5;
        cursor: not-allowed !important;
    }

    /* Navigation buttons - Floating Style */
    .wizard-navigation {
        position: sticky;
        bottom: 20px;
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        padding: 15px 25px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 16px;
        z-index: 100;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <!-- Wizard Steps Header -->
    <div class="wizard-steps">
        <div class="wizard-step active" data-step="1">
            <div class="wizard-step-circle">1</div>
            <div class="wizard-step-label">Seleccionar Productos</div>
        </div>
        <div class="wizard-step" data-step="2">
            <div class="wizard-step-circle">2</div>
            <div class="wizard-step-label">Datos del Cliente</div>
        </div>
        <div class="wizard-step" data-step="3">
            <div class="wizard-step-circle">3</div>
            <div class="wizard-step-label">Confirmar Pedido</div>
        </div>
    </div>

    <!-- PASO 1: Selección de Productos -->
    <div class="wizard-content active" id="step-1">
        <div class="row">
            <!-- Sidebar de categorías -->
            <div class="col-md-3">
                <h5>Categorías</h5>
                <!-- Select2 de subcategorías -->
                <div class="mb-3">
                    <select class="form-select" id="categories-select" style="width: 100%;">
                        <option value="">Cargando categorías...</option>
                    </select>
                    <small class="text-muted d-block mt-2">Subcategorías de Accesorios Smartwatch</small>
                </div>
            </div>

            <!-- Grid de productos -->
            <div class="col-md-6">
                <h5 class="mb-3">Productos</h5>

                <!-- Buscador contextual de productos -->
                <div class="mb-3">
                    <input type="text" class="form-control" id="product-filter-search"
                        placeholder="Buscar por nombre o SKU..." disabled>
                    <small class="text-muted" id="product-search-context">Selecciona una categoría para ver
                        productos</small>
                </div>

                <!-- Grid de productos con imágenes -->
                <div class="products-grid" id="products-grid">
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-box" style="font-size: 3rem; color: #dee2e6;"></i>
                        <p class="text-muted mt-3">Selecciona una categoría</p>
                    </div>
                </div>
            </div>

            <!-- Carrito -->
            <div class="col-md-3">
                <div class="cart-sidebar">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <h5 class="mb-0">Carrito</h5>
                        <span class="badge bg-primary rounded-pill d-flex align-items-center justify-content-center"
                            style="min-width: 24px; height: 24px;" id="cart-count">0</span>
                    </div>
                    <div id="cart-items">
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-cart" style="font-size: 2rem;"></i>
                            <p class="mt-2">Carrito vacío</p>
                        </div>
                    </div>
                    <div class="cart-totals">
                        <div class="d-flex justify-content-between mb-2">
                            <strong>Subtotal:</strong>
                            <span id="cart-subtotal">S/ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <strong>IGV (18%):</strong>
                            <span id="cart-tax">S/ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between border-top pt-2">
                            <strong style="font-size: 1.2rem;">TOTAL:</strong>
                            <strong style="font-size: 1.2rem;" id="cart-total">S/ 0.00</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="wizard-navigation">
            <a href="/orders/" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Cancelar
            </a>
            <button class="btn btn-primary" onclick="goToStep(2)" id="btn-step-1">
                Continuar <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- PASO 2: Datos del Cliente -->
    <div class="wizard-content" id="step-2">
        <div class="row">
            <div class="col-md-8">
                <!-- Datos personales -->
                <div class="form-section">
                    <h5><i class="bi bi-person"></i> Datos del Cliente</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="first-name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Apellido <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="last-name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Teléfono <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="phone" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">DNI / CE <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="dni" required>
                            <small class="text-muted">Documento de identidad</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">RUC (Opcional)</label>
                            <input type="text" class="form-control" id="ruc" maxlength="11">
                            <small class="text-muted">Solo si necesita factura</small>
                        </div>
                    </div>
                </div>

                <!-- Dirección de entrega -->
                <div class="form-section" id="delivery-section">
                    <h5><i class="bi bi-geo-alt"></i> Dirección de Entrega</h5>

                    <div class="mb-3">
                        <label class="form-label">Tipo de Entrega <span class="text-danger">*</span></label>
                        <select class="form-select" id="delivery-type" required onchange="updateAddressFields()">
                            <option value="" selected disabled>Seleccione tipo de entrega</option>
                            <option value="billing_domicilio">Entrega a Domicilio</option>
                            <option value="billing_agencia">En Agencia Shalom/Olva Courier</option>
                            <option value="billing_recojo">Recojo en Almacén</option>
                        </select>
                    </div>

                    <div class="mb-3" id="address-container">
                        <label class="form-label" id="address-label">Dirección <span
                                class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="address">
                    </div>

                    <div class="mb-3" id="reference-container">
                        <label class="form-label">Referencia (Opcional)</label>
                        <input type="text" class="form-control" id="reference">
                    </div>

                    <div class="row" id="location-container">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Departamento <span class="text-danger">*</span></label>
                            <select class="form-select" id="state">
                                <option value="">Seleccione departamento</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Distrito <span class="text-danger">*</span></label>
                            <select class="form-select" id="city">
                                <option value="">Seleccione distrito</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Información de pago -->
                <div class="form-section">
                    <h5><i class="bi bi-credit-card"></i> Información de Pago</h5>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Método de Envío <span class="text-danger">*</span></label>
                            <select class="form-select" id="shipping-method" required disabled>
                                <option value="">Primero seleccione distrito</option>
                            </select>
                            <small class="text-muted" id="shipping-help">Seleccione primero un distrito para ver métodos
                                disponibles</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Costo de Envío (S/) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="shipping-cost" value="0" min="0" step="0.01"
                                required>
                            <small class="text-muted">Se actualiza automáticamente al seleccionar método, pero puede
                                editarlo</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Método de Pago <span class="text-danger">*</span></label>
                            <select class="form-select" id="payment-method" required>
                                <option value="yape">Yape</option>
                                <option value="plin">Plin</option>
                                <option value="qr_dinamico">Paga con QR (Yape/Plin/BIM)</option>
                                <option value="bacs">Banca Virtual y Agentes</option>
                                <option value="transferencia">Transferencia Bancaria</option>
                                <option value="efectivo">Efectivo</option>
                                <option value="tarjeta_credito">Tarjeta de Crédito</option>
                                <option value="tarjeta_debito">Tarjeta de Débito</option>
                                <option value="mercadopago">Mercado Pago</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notas del Pedido</label>
                        <textarea class="form-control" id="customer-note" rows="2"
                            placeholder="Cliente contactó por WhatsApp..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Resumen del carrito -->
            <div class="col-md-4">
                <div class="form-section sticky-top" style="top: 80px;">
                    <h5><i class="bi bi-cart"></i> Resumen del Pedido</h5>
                    <div id="cart-summary"></div>
                    <div class="mt-3 pt-3 border-top">
                        <label class="form-label">Descuento (%)</label>
                        <input type="number" class="form-control" id="discount-percentage" value="0" min="0" max="100"
                            step="0.01">
                        <small class="text-muted">Descuento aplicado al subtotal de productos (incluye IGV)</small>
                    </div>

                    <!-- Nueva sección: Comunidad -->
                    <div class="mt-4 pt-4 border-top">
                        <div class="form-check form-switch card p-3 border-primary bg-light-purple shadow-sm">
                            <input class="form-check-input ms-0 me-2" type="checkbox" id="is-community"
                                style="width: 3rem; height: 1.5rem; cursor: pointer;">
                            <label class="form-check-label fw-bold text-primary" for="is-community"
                                style="cursor: pointer; font-size: 1.1rem;">
                                <i class="bi bi-people-fill"></i> ¿Es de la Comunidad?
                            </label>
                            <p class="text-muted small mb-0 mt-2">
                                Marca esta opción si el cliente forma parte de tu comunidad de WhatsApp.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="wizard-navigation">
            <button class="btn btn-secondary" onclick="goToStep(1)">
                <i class="bi bi-arrow-left"></i> Volver
            </button>
            <button class="btn btn-primary" onclick="goToStep(3)" id="btn-step-2">
                Continuar <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- PASO 3: Confirmación -->
    <div class="wizard-content" id="step-3">
        <div class="row">
            <div class="col-md-12">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Revisa todos los datos antes de crear el pedido. Una vez creado,
                    se reducirá el stock automáticamente.
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Resumen del cliente -->
            <div class="col-md-6">
                <div class="form-section">
                    <h5><i class="bi bi-person-check"></i> Datos del Cliente</h5>
                    <div id="customer-summary"></div>
                </div>

                <div class="form-section">
                    <h5><i class="bi bi-truck"></i> Información de Entrega</h5>
                    <div id="delivery-summary"></div>
                </div>
            </div>

            <!-- Resumen de productos y totales -->
            <div class="col-md-6">
                <div class="form-section">
                    <h5><i class="bi bi-box"></i> Productos del Pedido</h5>
                    <div id="products-summary"></div>
                </div>

                <div class="form-section">
                    <h5><i class="bi bi-calculator"></i> Totales</h5>
                    <div id="totals-summary"></div>
                </div>
            </div>
        </div>

        <div class="wizard-navigation">
            <button class="btn btn-secondary" onclick="goToStep(2)">
                <i class="bi bi-arrow-left"></i> Volver
            </button>
            <button class="btn btn-success btn-lg" onclick="submitOrder()" id="btn-submit">
                <i class="bi bi-check-circle"></i> <span id="btn-submit-text">Crear Pedido</span>
            </button>
        </div>
    </div>
</div>

<!-- Lightbox para zoom de imágenes del carrito -->
<div class="image-lightbox" id="imageLightbox">
    <img src="" alt="Zoom de producto">
    <span class="image-lightbox-hint">Toca para cerrar</span>
</div>

<!-- Modal para seleccionar variaciones -->
<div class="modal fade" id="variationsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="variations-modal-title">Seleccionar Variación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Selectores de atributos -->
                <div id="attribute-selectors">
                    <!-- Se generan dinámicamente -->
                </div>

                <!-- Producto seleccionado -->
                <div id="selected-variation-info" class="mt-4" style="display: none;">
                    <div class="border rounded p-3 bg-light">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="mb-2">Producto seleccionado:</h6>
                                <p class="mb-1"><strong id="selected-variation-name"></strong></p>
                                <p class="mb-1">
                                    <span class="text-muted">SKU: <span id="selected-variation-sku"></span></span>
                                </p>
                                <p class="mb-0">
                                    <span id="selected-variation-stock-badge"></span>
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <h4 class="text-success mb-0">S/ <span id="selected-variation-price">0.00</span></h4>
                                <button type="button" class="btn btn-primary mt-2" id="add-variation-btn">
                                    <i class="bi bi-cart-plus"></i> Agregar al Carrito
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mensaje cuando no hay coincidencia -->
                <div id="no-variation-match" class="alert alert-warning mt-3" style="display: none;">
                    <i class="bi bi-exclamation-triangle"></i> No hay stock disponible para esta combinación
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Pedido Creado -->
<div class="modal fade" id="orderCreatedModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <span id="modal-icon">
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    </span>
                    <span id="modal-title-text">Creando tu pedido...</span>
                </h5>
            </div>
            <div class="modal-body text-center py-4">
                <p id="modal-message" class="mb-4">Por favor espera mientras procesamos tu pedido</p>

                <!-- Botones (inicialmente ocultos) -->
                <div id="modal-actions" style="display: none;">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary btn-lg" onclick="createNewOrder()">
                            <i class="bi bi-plus-circle"></i> Crear Nuevo Pedido
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="goToOrdersList()">
                            <i class="bi bi-list-ul"></i> Ir a Lista de Pedidos
                        </button>
                        <button type="button" class="btn btn-outline-success" id="btn-view-woo"
                            onclick="viewInWooCommerce()">
                            <i class="bi bi-box-arrow-up-right"></i> Ver en WooCommerce
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    let currentStep = 1;
    let selectedCategory = null;
    let cart = [];

    // Detectar tipo de pedido desde URL
    const urlParams = new URLSearchParams(window.location.search);
    const orderType = urlParams.get('type') || 'whatsapp'; // 'whatsapp' o 'external'
    let categories = [];
    let currentProducts = []; // Productos de la categoría actual o filtrados
    let allProducts = []; // Todos los productos cargados al inicio

    // Datos del pedido
    let orderData = {
        customer: {},
        items: [],
        shipping_cost: 0,
        payment_method: '',
        payment_method_title: '',
        customer_note: ''
    };

    $(document).ready(function () {
        loadCategories();
        // NO cargar productos al inicio - esperar a que seleccione categoría
        updateCartDisplay();

        // Inicializar lightbox para imágenes del carrito
        initImageLightbox();

        // Cargar departamentos desde API
        loadDepartamentos();

        // Ocultar sección de dirección de entrega solo para pedidos externos
        if (orderType === 'external') {
            $('#delivery-section').hide();
            // Asegurar que el delivery-type esté en "billing_recojo"
            $('#delivery-type').val('billing_recojo');
        } else {
            // Para pedidos WhatsApp, inicializar campos de dirección según el tipo seleccionado
            updateAddressFields();
        }

        // Cuando cambie el departamento, cargar sus distritos
        $('#state').on('change', function () {
            const departamentoCode = $(this).val();
            if (departamentoCode) {
                loadDistritos(departamentoCode);
            } else {
                // Limpiar distrito si no hay departamento seleccionado
                $('#city').empty().append('<option value="">Seleccione distrito</option>');
                $('#city').trigger('change');
            }
        });

        // Actualizar resumen cuando cambie el costo de envío
        $('#shipping-cost').on('input', function () {
            updateCartSummary();
        });

        // Actualizar resumen cuando cambie el descuento
        $('#discount-percentage').on('input', function () {
            updateCartSummary();
        });
    });

    // ==================== UBIGEO: DEPARTAMENTOS Y DISTRITOS ====================

    function loadDepartamentos() {
        $.ajax({
            url: '/orders/api/departamentos',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    const $select = $('#state');
                    $select.empty();
                    $select.append('<option value="">Seleccione departamento</option>');

                    response.departamentos.forEach(function (dep) {
                        $select.append(`<option value="${dep.code}">${dep.name}</option>`);
                    });

                    // Inicializar Select2 después de cargar opciones
                    $select.select2({
                        theme: 'bootstrap-5',
                        placeholder: 'Buscar departamento...',
                        allowClear: true,
                        width: '100%'
                    });
                } else {
                    showNotification('error', 'Error al cargar departamentos: ' + response.error);
                }
            },
            error: function () {
                showNotification('error', 'Error de conexión al cargar departamentos');
            }
        });
    }

    function loadDistritos(departamentoCode) {
        console.log('[loadDistritos] Cargando distritos para departamento:', departamentoCode);
        const $citySelect = $('#city');

        // Mostrar loading
        $citySelect.empty().append('<option value="">Cargando...</option>');

        $.ajax({
            url: `/orders/api/distritos/${departamentoCode}`,
            method: 'GET',
            success: function (response) {
                console.log('[loadDistritos] Respuesta recibida:', response);
                if (response.success) {
                    console.log('[loadDistritos] Distritos cargados:', response.distritos.length);
                    $citySelect.empty();
                    $citySelect.append('<option value="">Seleccione distrito</option>');

                    response.distritos.forEach(function (distrito) {
                        $citySelect.append(`<option value="${distrito}">${distrito}</option>`);
                    });

                    // Inicializar o reinicializar Select2 en distrito
                    if ($citySelect.hasClass('select2-hidden-accessible')) {
                        $citySelect.select2('destroy');
                    }

                    $citySelect.select2({
                        theme: 'bootstrap-5',
                        placeholder: 'Buscar distrito...',
                        allowClear: true,
                        width: '100%'
                    });

                    // Escuchar cambios en distrito para cargar métodos de envío
                    $citySelect.off('change.shipping').on('change.shipping', function () {
                        const distrito = $(this).val();
                        if (distrito) {
                            loadMetodosEnvio(distrito);
                        } else {
                            // Limpiar métodos de envío si no hay distrito
                            $('#shipping-method').prop('disabled', true).empty()
                                .append('<option value="">Primero seleccione distrito</option>');
                            $('#shipping-cost').val(0);
                            $('#shipping-help').text('Seleccione primero un distrito para ver métodos disponibles');
                        }
                    });
                } else {
                    $citySelect.empty().append('<option value="">Error al cargar</option>');
                    showNotification('error', 'Error: ' + response.error);
                }
            },
            error: function () {
                $citySelect.empty().append('<option value="">Error de conexión</option>');
                showNotification('error', 'Error de conexión al cargar distritos');
            }
        });
    }

    function loadMetodosEnvio(distrito, callback) {
        const $shippingSelect = $('#shipping-method');
        const $shippingHelp = $('#shipping-help');

        console.log('[loadMetodosEnvio] Iniciando carga para distrito:', distrito);

        // Mostrar loading
        $shippingSelect.prop('disabled', true).empty()
            .append('<option value="">Cargando métodos...</option>');
        $shippingHelp.text('Buscando métodos de envío disponibles...');

        $.ajax({
            url: `/orders/api/metodos-envio/${encodeURIComponent(distrito)}`,
            method: 'GET',
            success: function (response) {
                console.log('[loadMetodosEnvio] Respuesta recibida:', response);
                if (response.success && response.metodos.length > 0) {
                    // Obtener tipo de entrega seleccionado
                    const deliveryType = $('#delivery-type').val();

                    // Filtrar métodos según tipo de entrega
                    let filteredMetodos = response.metodos;

                    if (deliveryType === 'billing_agencia') {
                        // Solo Olva y Shalom
                        filteredMetodos = response.metodos.filter(function (metodo) {
                            const title = metodo.title.toLowerCase();
                            return title.includes('olva') || title.includes('shalom');
                        });
                    } else if (deliveryType === 'billing_domicilio') {
                        // Solo Olva y envío 1 día hábil
                        filteredMetodos = response.metodos.filter(function (metodo) {
                            const title = metodo.title.toLowerCase();
                            return title.includes('olva') || title.includes('1 hábil') || title.includes('1 día hábil') || title.includes('1 habíl') || title.includes('1 dia habil') || title.includes('1 día habil');
                        });
                    }
                    // billing_recojo: no filtra, muestra todos

                    if (filteredMetodos.length > 0) {
                        $shippingSelect.empty().append('<option value="">Seleccione método de envío</option>');

                        filteredMetodos.forEach(function (metodo) {
                            $shippingSelect.append(
                                `<option value="${metodo.cost}" data-method-id="${metodo.id}" data-method-title="${metodo.title}">
                                ${metodo.title}
                            </option>`
                            );
                        });

                        $shippingSelect.prop('disabled', false);
                        $shippingHelp.text(`${filteredMetodos.length} método(s) de envío disponible(s)`);

                        // Actualizar costo cuando se selecciona un método
                        $shippingSelect.off('change.cost').on('change.cost', function () {
                            const cost = $(this).val();
                            const methodTitle = $(this).find(':selected').data('method-title');

                            $('#shipping-cost').val(cost || 0).trigger('input');

                            if (methodTitle) {
                                showNotification('success', `Método seleccionado: ${methodTitle} - S/ ${parseFloat(cost).toFixed(2)}`);
                            }
                        });
                    } else {
                        $shippingSelect.empty()
                            .append('<option value="">No hay métodos disponibles para este tipo de entrega</option>');
                        $shippingHelp.html(`<span class="text-warning">⚠️ No hay métodos de envío disponibles para ${deliveryType}</span>`);
                        $('#shipping-cost').val(0);
                        showNotification('warning', `No hay métodos de envío para este tipo de entrega en ${distrito}`);
                    }
                } else {
                    $shippingSelect.empty()
                        .append('<option value="">No hay métodos disponibles</option>');
                    $shippingHelp.html(`<span class="text-warning">⚠️ No hay métodos de envío para este distrito</span>`);
                    $('#shipping-cost').val(0);
                    showNotification('warning', `No hay métodos de envío configurados para ${distrito}`);
                }

                // Ejecutar callback si fue proporcionado
                if (typeof callback === 'function') {
                    console.log('[loadMetodosEnvio] Ejecutando callback después de cargar métodos');
                    callback();
                }
            },
            error: function (xhr, status, error) {
                console.error('Error cargando métodos de envío:', {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    responseText: xhr.responseText,
                    error: error
                });

                $shippingSelect.empty().append('<option value="">Error al cargar</option>');
                $shippingHelp.html('<span class="text-danger">Error de conexión</span>');

                // Ejecutar callback incluso en caso de error
                if (typeof callback === 'function') {
                    console.log('[loadMetodosEnvio] Ejecutando callback después de error');
                    callback();
                }

                let errorMsg = 'Error al cargar métodos de envío';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.error) {
                        errorMsg += ': ' + response.error;
                        console.error('Error del servidor:', response.traceback);
                    }
                } catch (e) { }

                showNotification('error', errorMsg);
            }
        });
    }

    // ==================== LIGHTBOX PARA IMÁGENES DEL CARRITO ====================

    let lastTapTime = 0;

    function openImageLightbox(imgSrc) {
        $('#imageLightbox').find('img').attr('src', imgSrc);
        $('#imageLightbox').addClass('active');
        $('body').css('overflow', 'hidden');
    }

    function closeImageLightbox() {
        $('#imageLightbox').removeClass('active');
        $('body').css('overflow', '');
    }

    function initImageLightbox() {
        // Doble toque para móvil - imágenes de variantes y carrito
        $(document).on('touchend', '.variation-swatch-image, .cart-item-image', function (e) {
            const currentTime = new Date().getTime();
            const tapInterval = currentTime - lastTapTime;

            if (tapInterval < 300 && tapInterval > 0) {
                e.preventDefault();
                e.stopPropagation(); // Evitar que se seleccione la variante
                openImageLightbox($(this).attr('src'));
            }
            lastTapTime = currentTime;
        });

        // Doble click para escritorio - imágenes de variantes y carrito
        $(document).on('dblclick', '.variation-swatch-image, .cart-item-image', function (e) {
            e.stopPropagation(); // Evitar que se seleccione la variante
            openImageLightbox($(this).attr('src'));
        });

        // Cerrar lightbox
        $('#imageLightbox').on('click touchend', function () {
            closeImageLightbox();
        });

        // Cerrar con Escape
        $(document).on('keydown', function (e) {
            if (e.key === 'Escape') closeImageLightbox();
        });
    }

    // ==================== PASO 1: PRODUCTOS ====================

    function loadCategories() {
        $.ajax({
            url: '/orders/get-categories',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    categories = response.categories;
                    renderCategoriesSelect(response.categories);
                } else {
                    showNotification('error', 'Error al cargar categorías');
                }
            },
            error: function () {
                showNotification('error', 'Error de conexión');
            }
        });
    }

    function renderCategoriesSelect(cats) {
        const $select = $('#categories-select');

        // Buscar la categoría "Accesorios Smartwatch" y obtener sus hijos
        let subcategories = [];

        function findSmartwatch(categories) {
            categories.forEach(cat => {
                if (cat.name.toLowerCase().includes('accesorios') &&
                    cat.name.toLowerCase().includes('smartwatch')) {
                    // Encontrada, usar sus hijos
                    if (cat.children && cat.children.length > 0) {
                        subcategories = cat.children;
                    }
                }
                // Buscar recursivamente en hijos
                if (cat.children && cat.children.length > 0) {
                    findSmartwatch(cat.children);
                }
            });
        }

        findSmartwatch(cats);

        // Destruir Select2 si existe
        if ($select.hasClass('select2-hidden-accessible')) {
            $select.select2('destroy');
        }

        // Limpiar y agregar opciones
        $select.empty();
        $select.append('<option value="">Todas las categorías</option>');

        if (subcategories.length > 0) {
            subcategories.forEach(cat => {
                $select.append(
                    `<option value="${cat.id}" data-name="${cat.name}">
                    ${cat.name} (${cat.product_count} productos)
                </option>`
                );
            });
        }

        // Inicializar Select2 con búsqueda flexible
        $select.select2({
            theme: 'bootstrap-5',
            placeholder: 'Selecciona una categoría...',
            allowClear: true,
            width: '100%',
            matcher: function (params, data) {
                // Si no hay término de búsqueda, mostrar todo
                if ($.trim(params.term) === '') {
                    return data;
                }

                // No buscar en la opción por defecto
                if (typeof data.text === 'undefined') {
                    return null;
                }

                // Convertir a minúsculas para búsqueda insensible a mayúsculas
                const searchText = data.text.toLowerCase();
                const searchTerms = params.term.toLowerCase().split(' ');

                // Verificar que todas las palabras del término de búsqueda estén en el texto
                const allWordsMatch = searchTerms.every(term => searchText.includes(term));

                if (allWordsMatch) {
                    return data;
                }

                // Sin coincidencia
                return null;
            }
        });

        // Evento de selección
        $select.on('change', function () {
            const catId = $(this).val();
            const catName = $(this).find(':selected').data('name') || 'Todas las categorías';

            if (catId) {
                selectCategory(catId, catName);
            } else {
                // Sin categoría seleccionada, mostrar estado inicial
                selectedCategory = null;
                $('#product-filter-search').prop('disabled', true).val('');
                $('#product-search-context').text('Selecciona una categoría para ver productos');

                // Mostrar mensaje inicial vacío
                $('#products-grid').html(`
                <div class="col-12 text-center py-5">
                    <i class="bi bi-box" style="font-size: 3rem; color: #dee2e6;"></i>
                    <p class="text-muted mt-3">Selecciona una categoría</p>
                </div>
            `);
            }
        });
    }

    function selectCategory(catId, catName) {
        selectedCategory = catId;

        // Habilitar buscador
        $('#product-filter-search').prop('disabled', false);

        // Actualizar contexto de búsqueda
        $('#product-search-context').text(`Buscando en: ${catName}`);

        // Cargar productos
        loadProductsByCategory(catId);
    }

    // Función para cargar todos los productos al inicio
    function loadAllProducts() {
        $.ajax({
            url: '/orders/search-products',
            method: 'GET',
            data: { q: '' }, // Enviar query vacío para obtener todos
            success: function (response) {
                if (response.success && response.products) {
                    allProducts = response.products;
                    renderProducts(response.products);
                    $('#product-search-context').text('Buscando en: Todos los productos');
                }
            },
            error: function () {
                console.error('Error al cargar productos');
            }
        });
    }

    function loadProductsByCategory(catId) {
        const $select = $('#products-select');
        $select.empty().append('<option value="">Cargando productos...</option>');
        if ($select.hasClass('select2-hidden-accessible')) {
            $select.select2('destroy');
        }

        $.ajax({
            url: `/orders/get-products-by-category/${catId}`,
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    renderProducts(response.products);
                }
            },
            error: function () {
                showNotification('error', 'Error al cargar productos');
            }
        });
    }

    // Buscador contextual de productos
    let productFilterTimeout = null;
    $('#product-filter-search').on('input', function () {
        const searchTerm = $(this).val().trim().toLowerCase();

        // Limpiar timeout anterior
        if (productFilterTimeout) {
            clearTimeout(productFilterTimeout);
        }

        // Esperar 300ms antes de filtrar
        productFilterTimeout = setTimeout(() => {
            if (searchTerm.length === 0) {
                // Sin búsqueda, mostrar productos según contexto
                if (selectedCategory) {
                    // Si hay categoría seleccionada, recargar productos de esa categoría
                    loadProductsByCategory(selectedCategory);
                } else {
                    // Sin categoría, mostrar todos los productos
                    renderProducts(allProducts);
                }
                return;
            }

            // Determinar en qué conjunto buscar
            const productsToSearch = selectedCategory ? currentProducts : allProducts;

            // Filtrar productos
            const filtered = productsToSearch.filter(product => {
                const name = product.name.toLowerCase();
                const sku = (product.sku || '').toLowerCase();
                return name.includes(searchTerm) || sku.includes(searchTerm);
            });

            renderProducts(filtered);

            // Actualizar contador
            if (filtered.length === 0) {
                showNotification('info', `No se encontraron productos que coincidan con "${searchTerm}"`);
            }
        }, 300);
    });

    function renderProducts(products) {
        currentProducts = products;
        const container = $('#products-grid');
        container.empty();

        if (products.length === 0) {
            container.html(`
            <div class="col-12 text-center py-5">
                <i class="bi bi-inbox" style="font-size: 3rem; color: #dee2e6;"></i>
                <p class="text-muted mt-3">No hay productos en esta categoría</p>
            </div>
        `);
            return;
        }

        products.forEach(product => {
            const imageUrl = product.image_url || 'https://via.placeholder.com/200';
            const inStock = product.stock_status === 'instock';
            const stockClass = inStock ? '' : 'out-of-stock';

            const html = `
            <div class="product-card ${stockClass}" onclick="selectProduct(${product.id}, ${product.has_variations})">
                <img src="${imageUrl}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/200'">
                <div class="product-card-name">${product.name}</div>
                <div class="product-card-price">S/ ${product.price.toFixed(2)}</div>
                <div class="product-card-sku">SKU: ${product.sku}</div>
                ${!inStock ? '<div class="badge bg-danger mt-2">Sin Stock</div>' : ''}
                ${product.has_variations ? '<div class="badge bg-info mt-2">Tiene Variaciones</div>' : ''}
            </div>
        `;

            container.append(html);
        });
    }

    function selectProduct(productId, hasVariations) {
        if (hasVariations) {
            loadVariations(productId);
        } else {
            // Producto simple, agregar directamente
            showLoadingOverlay('Agregando producto...');

            $.ajax({
                url: `/orders/get-variations/${productId}`,
                method: 'GET',
                success: function (response) {
                    hideLoadingOverlay();
                    if (response.success) {
                        const parent = response.parent;
                        addToCart(parent.id, 0, parent.name, parent.price, parent.sku, parent.stock, parent.image_url);
                        showNotification('success', 'Producto agregado al carrito');
                    }
                },
                error: function () {
                    hideLoadingOverlay();
                    showNotification('error', 'Error al agregar producto');
                }
            });
        }
    }

    function loadVariations(productId) {
        // Mostrar overlay de carga
        showLoadingOverlay('Cargando variaciones...');

        $.ajax({
            url: `/orders/get-variations/${productId}`,
            method: 'GET',
            beforeSend: function () {
                // Deshabilitar clics en productos mientras se carga
                $('.product-card').css('pointer-events', 'none');
            },
            success: function (response) {
                if (response.success) {
                    hideLoadingOverlay();
                    showVariationsModal(response.parent, response.variations, response.available_attributes);
                }
            },
            error: function () {
                hideLoadingOverlay();
                showNotification('error', 'Error al cargar variaciones');
            },
            complete: function () {
                // Rehabilitar clics en productos
                $('.product-card').css('pointer-events', 'auto');
            }
        });
    }

    // Variables globales para el modal de variaciones
    let currentVariations = [];
    let currentParent = null;
    let selectedAttributes = {};

    function showVariationsModal(parent, variations, availableAttributes) {
        // LIMPIAR TODO PRIMERO
        selectedAttributes = {};
        currentVariations = variations;
        currentParent = parent;

        // Limpiar UI
        $('#selected-variation-info').hide();
        $('#no-variation-match').hide();

        // Actualizar título
        $('#variations-modal-title').text(parent.name);

        // Generar selectores de atributos
        const container = $('#attribute-selectors');
        container.empty();

        if (Object.keys(availableAttributes).length === 0) {
            container.html('<p class="text-muted">Este producto no tiene variaciones configuradas.</p>');
            $('#variationsModal').modal('show');
            return;
        }

        // Generar selector VISUAL para cada atributo
        for (const [attrName, values] of Object.entries(availableAttributes)) {
            const selectId = `attr-${attrName.toLowerCase().replace(/\s+/g, '-')}`;

            // Crear contenedor del atributo
            const attrHtml = `
            <div class="mb-4">
                <label class="form-label fw-bold">${attrName}:</label>
                <div class="variation-swatches" id="swatches-${selectId}">
                    ${values.map(value => {
                // Buscar variación con este valor de atributo para obtener imagen
                const matchingVar = variations.find(v => v.attributes[attrName] === value);
                const imageUrl = matchingVar?.image_url || parent.image_url || 'https://via.placeholder.com/80';
                const stock = matchingVar?.stock || 0;
                const inStock = stock > 0;
                const outOfStockClass = !inStock ? 'out-of-stock' : '';

                return `
                            <div class="variation-swatch ${outOfStockClass}"
                                 data-attr-name="${attrName}"
                                 data-attr-value="${value}"
                                 ${!inStock ? 'title="Sin stock"' : ''}>
                                <span class="variation-swatch-stock"></span>
                                <img src="${imageUrl}"
                                     alt="${value}"
                                     class="variation-swatch-image"
                                     onerror="this.src='https://via.placeholder.com/80?text=Sin+imagen'">
                                <span class="variation-swatch-label">${value}</span>
                            </div>
                        `;
            }).join('')}
                </div>
            </div>
        `;

            container.append(attrHtml);
        }

        // Mostrar modal
        $('#variationsModal').modal('show');

        // IMPORTANTE: Forzar la eliminación de aria-hidden después de que Bootstrap lo muestre
        setTimeout(() => {
            $('#variationsModal').removeAttr('aria-hidden');
            $('#variationsModal').attr('aria-modal', 'true');
        }, 50);
    }

    // Event listener para clicks en las miniaturas visuales
    // NOTA: Permitimos seleccionar incluso sin stock para que funcione la lógica de "agregar uno temporalmente"
    $(document).on('click', '.variation-swatch', function () {
        const $swatch = $(this);
        const attrName = $swatch.data('attr-name');
        const attrValue = $swatch.data('attr-value');

        // Remover selección de otros swatches del mismo atributo
        $swatch.siblings('.variation-swatch').removeClass('active');

        // Marcar este como activo
        $swatch.addClass('active');

        // Actualizar atributos seleccionados
        selectedAttributes[attrName] = attrValue;

        // Buscar variación que coincida
        findMatchingVariation();
    });

    function findMatchingVariation() {
        // Verificar si todos los atributos están seleccionados
        const totalAttributes = $('.variation-swatches').length;
        const selectedCount = Object.keys(selectedAttributes).length;

        if (selectedCount < totalAttributes) {
            // Aún faltan atributos por seleccionar
            $('#selected-variation-info').hide();
            $('#no-variation-match').hide();
            return;
        }

        // Buscar variación que coincida con TODOS los atributos seleccionados
        const matchingVariation = currentVariations.find(variation => {
            const match = Object.entries(selectedAttributes).every(([attrName, attrValue]) => {
                return variation.attributes[attrName] === attrValue;
            });
            return match;
        });

        if (matchingVariation) {
            // Mostrar información de la variación
            $('#selected-variation-name').text(matchingVariation.name);
            $('#selected-variation-sku').text(matchingVariation.sku);
            $('#selected-variation-price').text(matchingVariation.price.toFixed(2));

            const inStock = matchingVariation.stock > 0;
            const stockBadge = inStock
                ? `<span class="badge bg-success">En Stock (${matchingVariation.stock})</span>`
                : `<span class="badge bg-danger">Sin Stock</span>`;
            $('#selected-variation-stock-badge').html(stockBadge);

            // NO deshabilitar el botón, solo cambiar su texto si no hay stock
            $('#add-variation-btn').prop('disabled', false);
            $('#add-variation-btn').data('variation-id', matchingVariation.id);
            $('#add-variation-btn').data('variation-name', matchingVariation.name);
            $('#add-variation-btn').data('variation-price', matchingVariation.price);
            $('#add-variation-btn').data('variation-sku', matchingVariation.sku);
            $('#add-variation-btn').data('in-stock', inStock);
            $('#add-variation-btn').data('stock', matchingVariation.stock);
            $('#add-variation-btn').data('image-url', matchingVariation.image_url || currentParent.image_url);

            // Usar CSS directo en lugar de .show() para forzar visibilidad
            $('#selected-variation-info').css('display', 'block');
            $('#no-variation-match').hide();

        } else {
            // No hay variación que coincida
            $('#selected-variation-info').hide();
            $('#no-variation-match').show();
        }
    }

    // Event listener para agregar al carrito
    $(document).on('click', '#add-variation-btn', function () {
        const variationId = $(this).data('variation-id');
        const variationName = $(this).data('variation-name');
        const variationPrice = $(this).data('variation-price');
        const variationSku = $(this).data('variation-sku');
        const inStock = $(this).data('in-stock');
        const stock = $(this).data('stock');
        const imageUrl = $(this).data('image-url');

        // Si no hay stock, mostrar modal de confirmación
        if (!inStock) {
            showOutOfStockConfirmation(currentParent.id, variationId, variationName, variationPrice, variationSku, imageUrl);
        } else {
            // Hay stock, agregar directamente con validación de stock
            addToCart(currentParent.id, variationId, variationName, variationPrice, variationSku, stock, imageUrl);
            $('#variationsModal').modal('hide');
        }
    });

    // Limpiar modal cuando se cierra
    $('#variationsModal').on('hidden.bs.modal', function () {
        // Limpiar selectores
        selectedAttributes = {};
        $('.attribute-selector').val('');

        // Ocultar información de variación seleccionada
        $('#selected-variation-info').hide();
        $('#no-variation-match').hide();

        // Limpiar contenedor de selectores
        $('#attribute-selectors').empty();
    });

    function addToCart(productId, variationId, name, price, sku, stock = null, imageUrl = null) {
        const item = {
            product_id: productId,
            variation_id: variationId,
            name: name,
            price: parseFloat(price),
            quantity: 1,
            sku: sku,
            stock: stock, // Guardar stock disponible
            image_url: imageUrl || 'https://via.placeholder.com/60?text=Sin+imagen' // Imagen del producto
        };

        // Verificar si ya existe
        const existing = cart.find(i => i.variation_id === item.variation_id && i.product_id === item.product_id);

        if (existing) {
            // Verificar si hay stock suficiente
            if (existing.stock !== null && existing.quantity >= existing.stock) {
                showNotification('warning', `Stock máximo alcanzado: ${existing.stock} unidades disponibles`);
                return;
            }
            existing.quantity++;
        } else {
            cart.push(item);
        }

        updateCartDisplay();
        showNotification('success', 'Producto agregado al carrito');
    }

    // Función para mostrar confirmación cuando no hay stock
    function showOutOfStockConfirmation(productId, variationId, name, price, sku, imageUrl = null) {
        const message = `
        <div class="alert alert-warning">
            <h5><i class="bi bi-exclamation-triangle"></i> Producto sin stock</h5>
            <p><strong>${name}</strong> (SKU: ${sku})</p>
            <p>Este producto no tiene stock disponible en la web.</p>
            <p><strong>¿Desea habilitarlo para poder venderlo?</strong></p>
            <div class="mt-3">
                <label for="stock-quantity-input" class="form-label fw-bold">Cantidad a habilitar:</label>
                <input type="number" 
                       class="form-control" 
                       id="stock-quantity-input" 
                       value="1" 
                       min="1" 
                       max="9999"
                       style="max-width: 150px;">
                <small class="text-muted d-block mt-2">Esta cantidad se agregará al stock en WooCommerce y al carrito del pedido.</small>
            </div>
        </div>
    `;


        // Crear modal de confirmación con Bootstrap
        const modalHtml = `
        <div class="modal fade" id="outOfStockModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">Confirmar Habilitación de Stock</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${message}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="confirm-enable-stock">
                            <i class="bi bi-check-circle"></i> Sí, Habilitar y Agregar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

        // Eliminar modal si existe
        $('#outOfStockModal').remove();

        // Agregar modal al body
        $('body').append(modalHtml);

        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('outOfStockModal'));
        modal.show();

        // Event listener para confirmación
        $('#confirm-enable-stock').off('click').on('click', function () {
            // Leer cantidad del input
            const quantity = parseInt($('#stock-quantity-input').val()) || 1;

            // Validar cantidad
            if (quantity < 1) {
                showNotification('error', 'La cantidad debe ser al menos 1');
                return;
            }

            $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Habilitando...');

            // Llamar al endpoint para habilitar stock con la cantidad especificada
            enableProductStock(productId, variationId, name, price, sku, imageUrl, quantity);
        });
    }

    // Función para habilitar stock en WooCommerce
    function enableProductStock(productId, variationId, name, price, sku, imageUrl = null, quantity = 1) {
        $.ajax({
            url: `/orders/enable-stock/${productId}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                variation_id: variationId,
                min_stock: quantity
            }),
            success: function (response) {
                if (response.success) {
                    // Cerrar modal de confirmación
                    $('#outOfStockModal').modal('hide');

                    // Cerrar modal de variaciones
                    $('#variationsModal').modal('hide');

                    // Agregar al carrito con la cantidad especificada
                    addToCartWithQuantity(productId, variationId, name, price, sku, response.stock, imageUrl, quantity);

                    // Notificar éxito
                    showNotification('success', `Stock habilitado: ${response.stock} unidades. ${quantity} agregadas al carrito.`);
                } else {
                    showNotification('error', 'Error al habilitar stock: ' + response.error);
                    $('#confirm-enable-stock').prop('disabled', false).html('<i class="bi bi-check-circle"></i> Sí, Habilitar y Agregar');
                }
            },
            error: function () {
                showNotification('error', 'Error de conexión al habilitar stock');
                $('#confirm-enable-stock').prop('disabled', false).html('<i class="bi bi-check-circle"></i> Sí, Habilitar y Agregar');
            }
        });
    }

    // Función para agregar al carrito con cantidad personalizada
    function addToCartWithQuantity(productId, variationId, name, price, sku, stock = null, imageUrl = null, initialQuantity = 1) {
        const item = {
            product_id: productId,
            variation_id: variationId,
            name: name,
            price: parseFloat(price),
            quantity: initialQuantity,
            sku: sku,
            stock: stock,
            image_url: imageUrl || 'https://via.placeholder.com/60?text=Sin+imagen'
        };

        // Verificar si ya existe
        const existing = cart.find(i => i.variation_id === item.variation_id && i.product_id === item.product_id);

        if (existing) {
            // Sumar la cantidad especificada
            const newQuantity = existing.quantity + initialQuantity;

            // Verificar si hay stock suficiente
            if (existing.stock !== null && newQuantity > existing.stock) {
                showNotification('warning', `Stock máximo alcanzado: ${existing.stock} unidades disponibles`);
                return;
            }
            existing.quantity = newQuantity;
        } else {
            cart.push(item);
        }

        updateCartDisplay();
    }

    function removeFromCart(index) {

        cart.splice(index, 1);
        updateCartDisplay();
    }

    function updateQuantity(index, change) {
        const item = cart[index];
        const newQuantity = item.quantity + change;

        // Verificar si intenta exceder el stock disponible
        if (change > 0 && item.stock !== null && newQuantity > item.stock) {
            showNotification('warning', `Stock máximo alcanzado: ${item.stock} unidades disponibles`);
            return;
        }

        item.quantity = newQuantity;

        if (item.quantity < 1) {
            removeFromCart(index);
        } else {
            updateCartDisplay();
        }
    }

    function updateItemPrice(index, newPrice) {
        const price = parseFloat(newPrice);

        // Validar precio
        if (isNaN(price) || price < 0) {
            showNotification('error', 'Precio inválido. Debe ser un número positivo.');
            updateCartDisplay(); // Restaurar el input al valor anterior
            return;
        }

        // Actualizar precio en el carrito
        cart[index].price = price;

        // Actualizar display
        updateCartDisplay();

        // Mostrar notificación
        if (price !== cart[index].original_price) {
            showNotification('success', 'Precio modificado para este pedido');
        }
    }

    function resetItemPrice(index) {
        // Restaurar precio original
        cart[index].price = cart[index].original_price;

        // Actualizar display
        updateCartDisplay();

        showNotification('success', 'Precio restaurado al original');
    }

    function updateCartDisplay() {
        const container = $('#cart-items');
        const count = $('#cart-count');

        count.text(cart.length);

        if (cart.length === 0) {
            container.html(`
            <div class="text-center py-4 text-muted">
                <i class="bi bi-cart" style="font-size: 2rem;"></i>
                <p class="mt-2">Carrito vacío</p>
            </div>
        `);

            $('#btn-step-1').prop('disabled', true);
        } else {
            container.empty();

            cart.forEach((item, index) => {
                // Guardar precio original si no existe
                if (!item.original_price) {
                    item.original_price = item.price;
                }

                const isPriceModified = item.price !== item.original_price;
                const priceClass = isPriceModified ? 'text-warning' : 'text-muted';
                const originalPriceHtml = isPriceModified
                    ? `<small class="text-muted text-decoration-line-through">S/ ${item.original_price.toFixed(2)}</small> `
                    : '';

                const html = `
                <div class="cart-item">
                    <span class="cart-item-remove" onclick="removeFromCart(${index})">
                        <i class="bi bi-x-circle-fill"></i>
                    </span>
                    <img src="${item.image_url}"
                         class="cart-item-image"
                         alt="${item.name}"
                         onerror="this.src='https://via.placeholder.com/60?text=Sin+imagen'">
                    <div class="cart-item-info">
                        <strong style="font-size: 0.95rem;">${item.name}</strong><br>
                        <div class="d-flex align-items-center gap-2 mb-2">
                            ${originalPriceHtml}
                            <div class="input-group input-group-sm" style="max-width: 120px;">
                                <span class="input-group-text">S/</span>
                                <input type="number"
                                       class="form-control form-control-sm price-input ${priceClass}"
                                       value="${item.price.toFixed(2)}"
                                       min="0"
                                       step="0.01"
                                       onchange="updateItemPrice(${index}, this.value)"
                                       onclick="this.select()">
                            </div>
                            ${isPriceModified ? `
                                <button class="btn btn-sm btn-outline-secondary"
                                        onclick="resetItemPrice(${index})"
                                        title="Restaurar precio original">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                            ` : ''}
                        </div>
                        <div class="d-flex align-items-center justify-content-between mt-2">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="updateQuantity(${index}, -1)">-</button>
                                <button class="btn btn-outline-secondary" disabled>${item.quantity}</button>
                                <button class="btn btn-outline-secondary" onclick="updateQuantity(${index}, 1)">+</button>
                            </div>
                            <span class="fw-bold">S/ ${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `;

                container.append(html);
            });

            $('#btn-step-1').prop('disabled', false);
        }

        updateCartTotals();
    }

    function updateCartTotals() {
        // Los precios YA incluyen IGV
        let totalWithTax = 0;

        cart.forEach(item => {
            totalWithTax += item.price * item.quantity;
        });

        // Calcular subtotal sin IGV (precio / 1.18)
        const subtotal = totalWithTax / 1.18;
        const tax = totalWithTax - subtotal;

        $('#cart-subtotal').text(`S/ ${subtotal.toFixed(2)}`);
        $('#cart-tax').text(`S/ ${tax.toFixed(2)}`);
        $('#cart-total').text(`S/ ${totalWithTax.toFixed(2)}`);
    }

    // ==================== BUSCADOR DE PRODUCTOS ====================

    let searchTimeout = null;

    // Toggle del buscador
    $('#toggle-search').on('click', function () {
        $('#search-container').slideToggle();
        $('#product-search').focus();
    });

    // Limpiar búsqueda
    $('#clear-search').on('click', function () {
        $('#product-search').val('');
        $('#search-results').empty();
        $('#product-search').focus();
    });

    // Búsqueda en tiempo real (con debounce)
    $('#product-search').on('input', function () {
        const searchTerm = $(this).val().trim();

        // Limpiar timeout anterior
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }

        if (searchTerm.length < 2) {
            $('#search-results').empty();
            return;
        }

        // Esperar 500ms antes de buscar
        searchTimeout = setTimeout(() => {
            searchProducts(searchTerm);
        }, 500);
    });

    function searchProducts(searchTerm) {
        $('#search-results').html(`
        <div class="text-center py-2">
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            <small class="ms-2">Buscando...</small>
        </div>
    `);

        $.ajax({
            url: '/orders/search-products',
            method: 'GET',
            data: { q: searchTerm },
            success: function (response) {
                if (response.success) {
                    displaySearchResults(response.products);
                } else {
                    $('#search-results').html(`
                    <div class="alert alert-warning py-2">
                        <small>Error al buscar productos</small>
                    </div>
                `);
                }
            },
            error: function () {
                $('#search-results').html(`
                <div class="alert alert-danger py-2">
                    <small>Error de conexión</small>
                </div>
            `);
            }
        });
    }

    function displaySearchResults(products) {
        if (products.length === 0) {
            $('#search-results').html(`
            <div class="alert alert-info py-2 mb-0">
                <small><i class="bi bi-info-circle"></i> No se encontraron productos</small>
            </div>
        `);
            return;
        }

        let html = '<div class="list-group">';
        products.forEach(product => {
            const stockBadge = product.stock > 0
                ? `<span class="badge bg-success">${product.stock} en stock</span>`
                : `<span class="badge bg-danger">Sin stock</span>`;

            html += `
            <div class="list-group-item list-group-item-action py-2 search-result-item"
                 data-product-id="${product.id}"
                 data-product-type="${product.type}"
                 data-product-stock="${product.stock || 0}"
                 data-product-image="${product.image_url || ''}"
                 style="cursor: pointer;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${product.name}</strong><br>
                        <small class="text-muted">SKU: ${product.sku} | S/ ${product.price.toFixed(2)}</small>
                    </div>
                    <div>
                        ${stockBadge}
                    </div>
                </div>
            </div>
        `;
        });
        html += '</div>';

        $('#search-results').html(html);
    }

    // Event listener para resultados de búsqueda
    $(document).on('click', '.search-result-item', function () {
        const productId = $(this).data('product-id');
        const productType = $(this).data('product-type');

        if (productType === 'product_variation') {
            // Es una variación directa, podemos obtener datos desde la búsqueda
            const name = $(this).find('strong').text();
            const priceText = $(this).find('small').text();
            const price = parseFloat(priceText.split('S/')[1]);
            const sku = priceText.split('SKU: ')[1].split(' |')[0];
            const stock = $(this).data('product-stock') || null;
            const imageUrl = $(this).data('product-image') || null;

            addToCart(productId, productId, name, price, sku, stock, imageUrl);

            // Limpiar búsqueda
            $('#product-search').val('');
            $('#search-results').empty();
            $('#search-container').slideUp();

            showNotification('success', 'Producto agregado al carrito');
        } else {
            // Es producto padre, verificar si tiene variaciones
            loadSingleProduct(productId);
        }
    });

    function loadSingleProduct(productId) {
        showLoadingOverlay('Cargando producto...');

        $.ajax({
            url: `/orders/get-variations/${productId}`,
            method: 'GET',
            success: function (response) {
                hideLoadingOverlay();

                if (response.success && response.variations.length > 0) {
                    // Tiene variaciones, mostrar modal
                    showVariationsModal(response.parent, response.variations, response.available_attributes);

                    // Limpiar búsqueda
                    $('#product-search').val('');
                    $('#search-results').empty();
                } else {
                    // Producto simple, agregar directamente usando datos del response
                    const parent = response.parent;
                    addToCart(parent.id, 0, parent.name, parent.price, parent.sku, parent.stock, parent.image_url);

                    // Limpiar búsqueda
                    $('#product-search').val('');
                    $('#search-results').empty();
                    $('#search-container').slideUp();

                    showNotification('success', 'Producto agregado al carrito');
                }
            },
            error: function () {
                hideLoadingOverlay();
                showNotification('error', 'Error al cargar producto');
            }
        });
    }

    // ==================== PASO 2: CLIENTE ====================

    function updateCartSummary() {
        const shippingCost = parseFloat($('#shipping-cost').val()) || 0;
        const discountPercentage = parseFloat($('#discount-percentage').val()) || 0;

        // Los precios YA incluyen IGV
        let totalWithTax = 0;
        cart.forEach(item => {
            totalWithTax += item.price * item.quantity;
        });

        const subtotal = totalWithTax / 1.18;
        const tax = totalWithTax - subtotal;

        // Aplicar descuento al total de productos (incluye IGV)
        // Truncar a 2 decimales en lugar de redondear
        const discountAmount = Math.floor(totalWithTax * (discountPercentage / 100) * 100) / 100;
        const totalAfterDiscount = totalWithTax - discountAmount;

        // El gran total incluye el descuento y el envío
        const grandTotal = totalAfterDiscount + shippingCost;

        // Generar lista de productos
        let productsHtml = '';
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            productsHtml += `
            <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                <div style="flex: 1;">
                    <div class="fw-bold" style="font-size: 0.9rem;">${item.name}</div>
                    <small class="text-muted">S/ ${item.price.toFixed(2)} x ${item.quantity}</small>
                </div>
                <div class="text-end">
                    <span class="fw-bold">S/ ${itemTotal.toFixed(2)}</span>
                </div>
            </div>
        `;
        });

        // Construir HTML del resumen
        let discountHtml = '';
        if (discountPercentage > 0) {
            discountHtml = `
            <div class="d-flex justify-content-between mb-1 text-danger">
                <span>Descuento (${discountPercentage.toFixed(2)}%):</span>
                <span>- S/ ${discountAmount.toFixed(2)}</span>
            </div>
        `;
        }

        const html = `
        <div class="mb-3">
            <h6 class="mb-2">Productos (${cart.length})</h6>
            ${productsHtml}
        </div>
        <div class="d-flex justify-content-between mb-1">
            <span>Subtotal:</span>
            <span>S/ ${subtotal.toFixed(2)}</span>
        </div>
        <div class="d-flex justify-content-between mb-1">
            <span>IGV (18%):</span>
            <span>S/ ${tax.toFixed(2)}</span>
        </div>
        ${discountHtml}
        <div class="d-flex justify-content-between mb-1">
            <span>Envío:</span>
            <span>S/ ${shippingCost.toFixed(2)}</span>
        </div>
        <div class="d-flex justify-content-between border-top pt-2 mt-2">
            <strong>TOTAL:</strong>
            <strong class="text-success">S/ ${grandTotal.toFixed(2)}</strong>
        </div>
    `;

        $('#cart-summary').html(html);
    }

    // ==================== PASO 3: CONFIRMACIÓN ====================

    function showStep3Summary() {
        // Resumen del cliente
        const customerHtml = `
        <p><strong>Nombre:</strong> ${$('#first-name').val()} ${$('#last-name').val()}</p>
        <p><strong>Email:</strong> ${$('#email').val()}</p>
        <p><strong>Teléfono:</strong> ${$('#phone').val()}</p>
        <p><strong>DNI/CE:</strong> ${$('#dni').val()}</p>
        ${$('#ruc').val() ? `<p><strong>RUC:</strong> ${$('#ruc').val()}</p>` : ''}
    `;
        $('#customer-summary').html(customerHtml);

        // Resumen de entrega
        const deliveryType = $('#delivery-type option:selected').text();
        const deliveryTypeValue = $('#delivery-type').val();

        let deliveryHtml = `<p><strong>Tipo:</strong> ${deliveryType}</p>`;

        // Solo mostrar campos de dirección si NO es "Recojo en Almacén"
        if (deliveryTypeValue !== 'billing_recojo') {
            deliveryHtml += `
            <p><strong>Dirección:</strong> ${$('#address').val()}</p>
            ${$('#reference').val() ? `<p><strong>Referencia:</strong> ${$('#reference').val()}</p>` : ''}
            <p><strong>Distrito:</strong> ${$('#city').val()}</p>
            <p><strong>Departamento:</strong> ${$('#state').val()}</p>
        `;
        }

        // Obtener método de envío seleccionado
        const shippingMethodSelect = $('#shipping-method');
        const shippingMethodText = shippingMethodSelect.find('option:selected').data('method-title') || shippingMethodSelect.find('option:selected').text();

        if (shippingMethodText && shippingMethodText !== 'Primero seleccione distrito' && shippingMethodText !== '') {
            deliveryHtml += `<p><strong>Método de Envío:</strong> ${shippingMethodText}</p>`;
        }

        deliveryHtml += `<p><strong>Método de Pago:</strong> ${$('#payment-method option:selected').text()}</p>`;

        $('#delivery-summary').html(deliveryHtml);

        // Resumen de productos
        let productsHtml = '';
        cart.forEach(item => {
            productsHtml += `
            <div class="d-flex justify-content-between mb-2 pb-2 border-bottom">
                <div>
                    <strong>${item.name}</strong><br>
                    <small>Cantidad: ${item.quantity} x S/ ${item.price.toFixed(2)}</small>
                </div>
                <div class="text-end">
                    <strong>S/ ${(item.price * item.quantity).toFixed(2)}</strong>
                </div>
            </div>
        `;
        });
        $('#products-summary').html(productsHtml);

        // Totales
        const shippingCost = parseFloat($('#shipping-cost').val()) || 0;
        const discountPercentage = parseFloat($('#discount-percentage').val()) || 0;

        let totalWithTax = 0;
        cart.forEach(item => {
            totalWithTax += item.price * item.quantity;
        });

        const subtotal = totalWithTax / 1.18;
        const tax = totalWithTax - subtotal;

        // Aplicar descuento
        const discountAmount = Math.floor(totalWithTax * (discountPercentage / 100) * 100) / 100;
        const totalAfterDiscount = totalWithTax - discountAmount;
        const grandTotal = totalAfterDiscount + shippingCost;

        let discountHtml = '';
        if (discountPercentage > 0) {
            discountHtml = `
            <div class="d-flex justify-content-between mb-2 text-danger">
                <span>Descuento (${discountPercentage.toFixed(2)}%):</span>
                <span>- S/ ${discountAmount.toFixed(2)}</span>
            </div>
        `;
        }

        const totalsHtml = `
        <div class="d-flex justify-content-between mb-2">
            <span>Subtotal:</span>
            <span>S/ ${subtotal.toFixed(2)}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
            <span>IGV (18%):</span>
            <span>S/ ${tax.toFixed(2)}</span>
        </div>
        ${discountHtml}
        <div class="d-flex justify-content-between mb-2">
            <span>Costo de Envío:</span>
            <span>S/ ${shippingCost.toFixed(2)}</span>
        </div>
        <div class="d-flex justify-content-between border-top pt-2">
            <strong style="font-size: 1.3rem;">TOTAL:</strong>
            <strong style="font-size: 1.3rem;" class="text-success">S/ ${grandTotal.toFixed(2)}</strong>
        </div>
    `;
        $('#totals-summary').html(totalsHtml);
    }

    // ==================== NAVEGACIÓN ====================

    function goToStep(step) {
        // Validar antes de avanzar
        if (step === 2 && cart.length === 0) {
            showNotification('error', 'Debes agregar al menos un producto al carrito');
            return;
        }

        if (step === 2) {
            // Actualizar resumen del pedido al entrar al paso 2
            updateCartSummary();
        }

        if (step === 3) {
            if (!validateStep2()) {
                return;
            }
            updateCartSummary();
            showStep3Summary();
        }

        // Actualizar UI
        $('.wizard-content').removeClass('active');
        $(`#step-${step}`).addClass('active');

        $('.wizard-step').removeClass('active').removeClass('completed');

        for (let i = 1; i < step; i++) {
            $(`.wizard-step[data-step="${i}"]`).addClass('completed');
        }

        $(`.wizard-step[data-step="${step}"]`).addClass('active');

        currentStep = step;

        // Scroll to top
        window.scrollTo(0, 0);
    }

    function validateStep2() {
        // Campos siempre requeridos
        const alwaysRequired = ['first-name', 'last-name', 'email', 'phone', 'dni'];

        // Validar campos siempre requeridos
        for (const field of alwaysRequired) {
            const value = $(`#${field}`).val();
            if (!value || value.trim() === '') {
                showNotification('error', `Por favor completa todos los campos requeridos`);
                $(`#${field}`).focus();
                return false;
            }
        }

        // Validar campos de dirección solo si NO es "Recojo en Almacén"
        const deliveryType = $('#delivery-type').val();
        if (deliveryType !== 'billing_recojo') {
            const addressRequired = ['address', 'city', 'state'];

            for (const field of addressRequired) {
                const value = $(`#${field}`).val();
                if (!value || value.trim() === '') {
                    showNotification('error', `Por favor completa todos los campos de dirección requeridos`);
                    $(`#${field}`).focus();
                    return false;
                }
            }
        }

        // Validar email
        const email = $('#email').val();
        if (!email.includes('@')) {
            showNotification('error', 'Email inválido');
            $('#email').focus();
            return false;
        }

        return true;
    }

    // ==================== ENVÍO DE PEDIDO / ACTUALIZACIÓN ====================

    let createdOrderId = null;
    let isEditMode = {{ 'true' if edit_mode else 'false' }};
    let editingOrderId = {{ order_id|default ('null') }};

    // Inicializar Edit Mode si aplica
    $(document).ready(function () {
        if (isEditMode && editingOrderId) {
            loadOrderForEdit(editingOrderId);
        }
    });

    function loadOrderForEdit(orderId) {
        showLoadingOverlay('Cargando datos del pedido...');

        $.ajax({
            url: `/orders/api/get-order/${orderId}`,
            method: 'GET',
            success: function (response) {
                hideLoadingOverlay();
                populateOrderData(response);
            },
            error: function (xhr) {
                hideLoadingOverlay();
                showNotification('error', 'Error al cargar el pedido: ' + (xhr.responseJSON?.error || 'Desconocido'));
            }
        });
    }

    function populateOrderData(data) {
        console.log('[populateOrderData] Iniciando carga de datos del pedido:', data);

        // 1. Cargar items al carrito
        cart = []; // Limpiar
        data.items.forEach(item => {
            // Adaptar estructura si es necesario
            cart.push({
                product_id: item.product_id,
                variation_id: item.variation_id,
                name: item.name,
                price: item.price,
                quantity: item.quantity,
                original_item_id: item.item_id, // Importante para updates
                image_url: item.image_url || '' // Cargar imagen del backend
            });
        });
        updateCartDisplay(); // Función existente que renderiza el carrito lateral

        // 2. Cargar datos del cliente
        const cust = data.customer;
        $('#first-name').val(cust.first_name);
        $('#last-name').val(cust.last_name);
        $('#email').val(cust.email);
        $('#phone').val(cust.phone);
        $('#dni').val(cust.company); // Usamos company para DNI
        $('#ruc').val(cust.billing_ruc);
        $('#is-community').prop('checked', cust.is_community);

        // 3. Dirección y Entrega
        const deliveryType = cust.billing_entrega || 'billing_domicilio'; // Default
        console.log('[populateOrderData] Delivery type:', deliveryType);
        $('#delivery-type').val(deliveryType).trigger('change');

        $('#address').val(cust.address_1);
        $('#reference').val(cust.billing_referencia);

        console.log('[populateOrderData] Datos de ubicación:', {
            state: cust.state,
            city: cust.city,
            distrito: cust.city
        });

        console.log('[populateOrderData] Datos de envío:', data.shipping);

        // Cargar ubigeo y métodos de envío
        setTimeout(() => {
            console.log('[populateOrderData] Timeout 1 - Seleccionando departamento:', cust.state);
            // Seleccionar departamento
            $('#state').val(cust.state).trigger('change');

            // Esperar a que se carguen las provincias, luego seleccionar distrito
            setTimeout(() => {
                console.log('[populateOrderData] Timeout 2 - Seleccionando distrito:', cust.city);
                $('#city').val(cust.city).trigger('change');

                // Cargar métodos de envío SOLO si no es recojo en almacén
                if (deliveryType !== 'billing_recojo' && cust.city) {
                    console.log('[populateOrderData] No es recojo, cargando métodos de envío para:', cust.city);
                    // Esperar a que el distrito esté seleccionado antes de cargar métodos
                    setTimeout(() => {
                        console.log('[populateOrderData] Timeout 3 - Llamando a loadMetodosEnvio');
                        loadMetodosEnvio(cust.city, function () {
                            console.log('[populateOrderData] Callback ejecutado - Métodos cargados');
                            // Después de cargar los métodos, seleccionar el correcto y setear costo
                            setTimeout(() => {
                                console.log('[populateOrderData] Timeout 4 - Seleccionando método de envío');
                                // Buscar la opción que contiene el método de envío del pedido
                                const shippingOptions = $('#shipping-method option');
                                let foundMatch = false;

                                console.log('[populateOrderData] Opciones disponibles:', shippingOptions.length);
                                console.log('[populateOrderData] Buscando método:', data.shipping.method_title);

                                shippingOptions.each(function () {
                                    const optionText = $(this).text().toLowerCase();
                                    const methodTitle = data.shipping.method_title.toLowerCase();

                                    console.log('[populateOrderData] Comparando:', optionText, 'con', methodTitle);

                                    if (optionText.includes(methodTitle) || methodTitle.includes(optionText)) {
                                        $(this).prop('selected', true);
                                        foundMatch = true;
                                        console.log('[populateOrderData] Método encontrado y seleccionado');
                                        return false; // break
                                    }
                                });

                                // Establecer el costo de envío
                                console.log('[populateOrderData] Estableciendo costo de envío:', data.shipping.cost);
                                $('#shipping-cost').val(data.shipping.cost);

                                if (!foundMatch) {
                                    console.warn('[populateOrderData] No se encontró el método de envío:', data.shipping.method_title);
                                }
                            }, 200);
                        });
                    }, 300);
                } else {
                    console.log('[populateOrderData] Es recojo o no hay distrito, estableciendo costo:', data.shipping.cost || 0);
                    // Si es recojo, asegurar costo de envío
                    $('#shipping-cost').val(data.shipping.cost || 0);
                }
            }, 600);
        }, 500);

        // 4. Pago y Notas
        $('#payment-method').val(data.payment.method);
        $('#customer-note').val(data.customer_note);

        // 5. Totales (se recalculan con updateCartSummary pero podemos ajustar manualmente descuentos si hubiera logica)
        // El descuento en el backend se calcula al final. Aquí solo tenemos porcentaje manual en frontend.
        // Si el pedido tenia descuento, tratar de inferirlo?
        // data.totals.discount...

        // 6. Actualizar texto del botón para modo edición
        $('#btn-submit-text').text('Actualizar Pedido');

        showNotification('success', 'Datos del pedido cargados para edición');
    }


    function submitOrder() {
        const btn = $('#btn-submit');
        btn.prop('disabled', true);
        const loadingText = isEditMode ? 'Actualizando pedido...' : 'Creando pedido...';
        btn.html(`<span class="spinner-border spinner-border-sm me-2"></span>${loadingText}`);

        // **MOSTRAR MODAL INMEDIATAMENTE** con opciones de acción
        const modal = new bootstrap.Modal(document.getElementById('orderCreatedModal'));

        // Resetear el modal al estado inicial de "procesando en segundo plano"
        $('#modal-icon').html('<span class="spinner-border spinner-border-sm me-2"></span>');
        $('#modal-title-text').text('Procesando pedido en segundo plano...');
        $('#modal-message').html(`
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Tu pedido se está creando en segundo plano.
            Puedes continuar con tus tareas mientras tanto.
        </div>
        <p class="text-muted">¿Qué deseas hacer ahora?</p>
    `);

        // **MOSTRAR BOTONES DE ACCIÓN INMEDIATAMENTE**
        $('#modal-actions').html(`
        <div class="d-grid gap-2">
            <button type="button" class="btn btn-primary btn-lg" onclick="createNewOrder()">
                <i class="bi bi-plus-circle"></i> Crear Nuevo Pedido
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="goToOrdersList()">
                <i class="bi bi-list-ul"></i> Ir a Lista de Pedidos
            </button>
        </div>
    `).show();

        $('.modal-header').removeClass('bg-success bg-danger').addClass('bg-primary');

        // Mostrar el modal ANTES de enviar
        modal.show();

        // Verificar tipo de entrega
        const deliveryType = $('#delivery-type').val();
        const isPickup = deliveryType === 'billing_recojo';

        // Preparar datos
        const orderData = {
            customer: {
                first_name: $('#first-name').val(),
                last_name: $('#last-name').val(),
                email: $('#email').val(),
                phone: $('#phone').val(),
                dni: $('#dni').val(),  // DNI/CE
                ruc: $('#ruc').val() || '',
                company: $('#dni').val(),  // Para compatibilidad con WooCommerce (billing_company)
                // Si es recojo en almacén, usar valores por defecto; si no, usar los del formulario
                address_1: isPickup ? 'Recojo en Almacén' : $('#address').val(),
                city: isPickup ? 'Lima' : $('#city').val(),
                state: isPickup ? 'LIMA' : $('#state').val(),
                postcode: '',
                country: 'PE',
                delivery_type: deliveryType,
                reference: isPickup ? '' : ($('#reference').val() || ''),
                // Campos custom para WooCommerce
                billing_ruc: $('#ruc').val() || '',
                billing_entrega: deliveryType,
                billing_referencia: isPickup ? '' : ($('#reference').val() || '')
            },
            items: cart.map(item => ({
                product_id: item.product_id || 0,
                variation_id: item.variation_id || 0,
                quantity: item.quantity,
                price: item.price,
                name: item.name,
                original_item_id: item.original_item_id
            })),
            shipping_cost: parseFloat($('#shipping-cost').val()) || 0,
            shipping_method_title: $('#shipping-method option:selected').data('method-title') || '',
            discount_percentage: parseFloat($('#discount-percentage').val()) || 0,
            payment_method: $('#payment-method').val(),
            payment_method_title: $('#payment-method option:selected').text(),
            customer_note: $('#customer-note').val() || 'Pedido creado desde WooCommerce Manager (WhatsApp)',
            is_community: $('#is-community').is(':checked')
        };

        // Determinar endpoint y método según modo
        let endpoint, method;

        if (isEditMode) {
            endpoint = `/orders/update-order/${editingOrderId}`;
            method = 'PUT';
        } else {
            endpoint = orderType === 'external' ? '/orders/save-order-external' : '/orders/save-order';
            method = 'POST';
        }

        // Si es pedido externo (SOLO CREACION), agregar campo de fuente
        if (orderType === 'external' && !isEditMode) {
            orderData.external_source = $('#external-source').val() || 'otro';
            // Actualizar customer_note para reflejar que es externo
            orderData.customer_note = $('#customer-note').val() || 'Pedido externo creado desde WooCommerce Manager';
        }

        // Enviar
        $.ajax({
            url: endpoint,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(orderData),
            timeout: 60000, // 60 segundos timeout
            success: function (response) {
                if (response.success) {
                    // Guardar ID del pedido
                    createdOrderId = response.order_id;

                    // Si el modal aún está visible, actualizar con éxito
                    if ($('#orderCreatedModal').hasClass('show')) {
                        $('#modal-icon').html('<i class="bi bi-check-circle-fill fs-4"></i>');
                        $('#modal-title-text').text(isEditMode ? '¡Pedido Actualizado!' : '¡Pedido Creado Exitosamente!');
                        $('#modal-message').html(`
                        <div class="alert alert-success">
                            <strong>Pedido #${response.order_number || response.order_id}</strong> ${isEditMode ? 'actualizado' : 'creado'} correctamente
                        </div>
                        <p class="text-muted">¿Qué deseas hacer ahora?</p>
                    `);

                        // Actualizar botones (NO mostrar "Ver en WooCommerce" si es pedido externo)
                        const viewWooButton = orderType === 'external' ? '' : `
                        <button type="button" class="btn btn-outline-success" onclick="viewInWooCommerce()">
                            <i class="bi bi-box-arrow-up-right"></i> Ver en WooCommerce
                        </button>
                    `;

                        $('#modal-actions').html(`
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary btn-lg" onclick="createNewOrder()">
                                <i class="bi bi-plus-circle"></i> Crear Nuevo Pedido
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="goToOrdersList()">
                                <i class="bi bi-list-ul"></i> Ir a Lista de Pedidos
                            </button>
                            ${viewWooButton}
                        </div>
                    `);

                        // Cambiar color del header a éxito
                        $('.modal-header').removeClass('bg-primary').addClass('bg-success');
                    } else {
                        // Si el modal ya se cerró, mostrar notificación
                        showNotification('success', `Pedido #${response.order_number || response.order_id} creado exitosamente`);
                    }
                } else {
                    // Actualizar modal con error
                    $('#modal-icon').html('<i class="bi bi-x-circle-fill fs-4"></i>');
                    $('#modal-title-text').text(isEditMode ? 'Error al Actualizar' : 'Error al Crear Pedido');
                    $('#modal-message').html(`
                    <div class="alert alert-danger">
                        ${response.error || 'Error desconocido'}
                    </div>
                `);

                    // Cambiar color del header a error
                    $('.modal-header').removeClass('bg-primary').addClass('bg-danger');

                    // Mostrar solo opción de cerrar
                    $('#modal-actions').html(`
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cerrar
                    </button>
                `).show();

                    // Re-habilitar botón
                    btn.prop('disabled', false);
                    const btnText = isEditMode ? 'Actualizar Pedido' : 'Crear Pedido';
                    btn.html(`<i class="bi bi-check-circle"></i> <span id="btn-submit-text">${btnText}</span>`);
                }
            },
            error: function (xhr, status, error) {
                let errorMessage = 'Error de conexión';

                // Determinar el tipo de error
                if (status === 'timeout') {
                    errorMessage = 'La solicitud ha tardado demasiado. El pedido podría haberse creado, revisa la lista de pedidos.';
                } else if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                } else if (xhr.status === 0) {
                    errorMessage = 'No se pudo conectar al servidor. Verifica tu conexión a internet.';
                } else if (xhr.status >= 500) {
                    errorMessage = 'Error del servidor. El pedido podría haberse creado, revisa la lista de pedidos.';
                } else {
                    errorMessage = error || 'Error desconocido';
                }

                // Actualizar modal con error
                $('#modal-icon').html('<i class="bi bi-exclamation-triangle-fill fs-4"></i>');
                $('#modal-title-text').text(status === 'timeout' ? 'Tiempo de Espera Agotado' : 'Error de Conexión');
                $('#modal-message').html(`
                <div class="alert alert-warning">
                    ${errorMessage}
                </div>
            `);

                // Cambiar color del header a warning (amarillo) si es timeout
                $('.modal-header').removeClass('bg-primary').addClass(status === 'timeout' ? 'bg-warning' : 'bg-danger');

                // Mostrar opciones
                $('#modal-actions').html(`
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" onclick="goToOrdersList()">
                        <i class="bi bi-list-ul"></i> Verificar en Lista de Pedidos
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cerrar
                    </button>
                </div>
            `).show();

                // Re-habilitar botón
                btn.prop('disabled', false);
                btn.html(isEditMode ? '<i class="bi bi-check-circle"></i> Actualizar Pedido' : '<i class="bi bi-check-circle"></i> Crear Pedido');
            }
        });
    }

    // ==================== UTILIDADES ====================

    function showNotification(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-warning';
        const html = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3"
             style="z-index: 9999; max-width: 500px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
        $('body').append(html);
        setTimeout(() => $('.alert').fadeOut(), 3000);
    }

    // Función para actualizar campos según tipo de entrega
    function updateAddressFields() {
        const deliveryType = $('#delivery-type').val();
        const addressContainer = $('#address-container');
        const addressLabel = $('#address-label');
        const addressInput = $('#address');
        const referenceContainer = $('#reference-container');
        const locationContainer = $('#location-container');

        if (!deliveryType || deliveryType === '') {
            // Placeholder seleccionado - Ocultar todos los campos
            addressContainer.hide();
            referenceContainer.hide();
            locationContainer.hide();
            addressInput.removeAttr('required');
            $('#city').removeAttr('required');
            $('#state').removeAttr('required');

            // Deshabilitar método de envío
            $('#shipping-method').prop('disabled', true).empty()
                .append('<option value="">Seleccione tipo de entrega primero</option>');
            $('#shipping-cost').val(0);
            $('#shipping-help').text('Primero seleccione el tipo de entrega');
        } else if (deliveryType === 'billing_recojo') {
            // Recojo en Almacén - Ocultar todos los campos de dirección
            addressContainer.hide();
            referenceContainer.hide();
            locationContainer.hide();
            addressInput.removeAttr('required');
            $('#city').removeAttr('required');
            $('#state').removeAttr('required');

            // Para Recojo en Almacén, habilitar método de envío sin necesidad de distrito
            $('#shipping-method').prop('disabled', false).empty()
                .append('<option value="0" data-method-id="recojo_almacen" data-method-title="Recojo en Almacén">Recojo en Almacén - S/0.00</option>');
            $('#shipping-cost').val(0);
            $('#shipping-help').text('No tiene costo de envío');
        } else if (deliveryType === 'billing_agencia') {
            // En Agencia Shalom/Olva Courier - Cambiar label
            addressContainer.show();
            referenceContainer.show();
            locationContainer.show();
            addressLabel.html('Sede o Agencia Shalom / Olva Courier <span class="text-danger">*</span>');
            addressInput.attr('placeholder', 'Ej: Agencia Shalom Av. Faucett 492');
            addressInput.attr('required', 'required');
            $('#city').attr('required', 'required');
            $('#state').attr('required', 'required');

            // Resetear método de envío para que seleccione distrito
            $('#shipping-method').prop('disabled', true).empty()
                .append('<option value="">Primero seleccione distrito</option>');
            $('#shipping-cost').val(0);
            $('#shipping-help').text('Seleccione primero un distrito para ver métodos disponibles');
        } else {
            // Entrega a Domicilio - Mostrar todo normal
            addressContainer.show();
            referenceContainer.show();
            locationContainer.show();
            addressLabel.html('Dirección <span class="text-danger">*</span>');
            addressInput.attr('placeholder', '');
            addressInput.attr('required', 'required');
            $('#city').attr('required', 'required');
            $('#state').attr('required', 'required');

            // Resetear método de envío para que seleccione distrito
            $('#shipping-method').prop('disabled', true).empty()
                .append('<option value="">Primero seleccione distrito</option>');
            $('#shipping-cost').val(0);
            $('#shipping-help').text('Seleccione primero un distrito para ver métodos disponibles');
        }

        // Recargar métodos de envío si hay un distrito seleccionado (solo para agencia y domicilio)
        if (deliveryType !== 'billing_recojo') {
            const distrito = $('#city').val();
            if (distrito) {
                loadMetodosEnvio(distrito);
            }
        }
    }

    function showLoadingOverlay(message = 'Cargando...') {
        // Remover overlay existente si hay
        $('#loading-overlay').remove();

        const html = `
        <div id="loading-overlay" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        ">
            <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-light mt-3 fs-5">${message}</p>
        </div>
    `;
        $('body').append(html);
    }

    function hideLoadingOverlay() {
        $('#loading-overlay').fadeOut(300, function () {
            $(this).remove();
        });
    }

    // ==================== FUNCIONES DEL MODAL DE PEDIDO CREADO ====================

    function createNewOrder() {
        // Recargar la página para limpiar todo el formulario
        window.location.reload();
    }

    function goToOrdersList() {
        window.location.href = '/orders/';
    }

    function viewInWooCommerce() {
        // Obtener la URL base de WooCommerce del servidor
        $.ajax({
            url: '/orders/get-woo-orders-url',
            method: 'GET',
            success: function (response) {
                if (response.success && response.url) {
                    window.open(response.url, '_blank');
                } else {
                    // Fallback: construir URL manualmente si el backend no responde correctamente
                    alert('No se pudo obtener la URL de WooCommerce. Intenta acceder manualmente desde el panel de administración.');
                }
            },
            error: function () {
                // Fallback en caso de error
                alert('No se pudo obtener la URL de WooCommerce. Por favor, accede manualmente al panel de administración.');
            }
        });
    }
</script>
{% endblock %}