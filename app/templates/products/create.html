{% extends "base.html" %}

{% block title %}Crear Producto - WooCommerce Manager{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .form-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #0d6efd;
    }

    .dimensions-group {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }

    .price-group {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }

    .stock-group {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }

    .image-preview {
        max-width: 200px;
        max-height: 200px;
        margin-top: 10px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        display: none;
    }

    .select2-container {
        width: 100% !important;
    }

    .form-label .required {
        color: #dc3545;
    }

    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 4px;
    }

    .btn-submit-product {
        min-width: 150px;
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-spinner {
        background: white;
        padding: 30px;
        border-radius: 8px;
        text-align: center;
    }
</style>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0">
                <i class="bi bi-plus-circle"></i> Crear Nuevo Producto
            </h1>
            <nav aria-label="breadcrumb" class="mt-2">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="/products/">Productos</a></li>
                    <li class="breadcrumb-item active">Crear</li>
                </ol>
            </nav>
        </div>
    </div>

    <form id="productForm">
        <div class="row">
            <!-- Columna principal -->
            <div class="col-lg-8">

                <!-- Información Básica -->
                <div class="form-section">
                    <h2 class="form-section-title">Información Básica</h2>

                    <div class="mb-3">
                        <label for="title" class="form-label">
                            Título del Producto <span class="required">*</span>
                        </label>
                        <input type="text" class="form-control" id="title" name="title" required>
                        <div class="help-text">Nombre principal del producto</div>
                    </div>

                    <div class="mb-3">
                        <label for="slug" class="form-label">Slug/URL</label>
                        <input type="text" class="form-control" id="slug" name="slug">
                        <div class="help-text">Dejar vacío para generar automáticamente desde el título</div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Descripción Larga</label>
                        <textarea class="form-control" id="description" name="description" rows="6"></textarea>
                        <div class="help-text">Descripción completa del producto (acepta HTML)</div>
                    </div>

                    <div class="mb-3">
                        <label for="short_description" class="form-label">Descripción Corta</label>
                        <textarea class="form-control" id="short_description" name="short_description" rows="3"></textarea>
                        <div class="help-text">Resumen breve que aparece en listados</div>
                    </div>
                </div>

                <!-- Precios e Inventario -->
                <div class="form-section">
                    <h2 class="form-section-title">Precios e Inventario</h2>

                    <div class="price-group mb-3">
                        <div>
                            <label for="regular_price" class="form-label">
                                Precio Regular <span class="required">*</span>
                            </label>
                            <input type="number" step="0.01" class="form-control" id="regular_price" name="regular_price" required>
                        </div>

                        <div>
                            <label for="sale_price" class="form-label">Precio Oferta</label>
                            <input type="number" step="0.01" class="form-control" id="sale_price" name="sale_price">
                        </div>

                        <div>
                            <label for="cost_price" class="form-label">Precio Costo</label>
                            <input type="number" step="0.01" class="form-control" id="cost_price" name="cost_price">
                            <div class="help-text">Solo para control interno</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="sku" class="form-label">
                            SKU <span class="required">*</span>
                        </label>
                        <input type="text" class="form-control" id="sku" name="sku" required>
                        <div class="help-text">Código único de producto</div>
                    </div>

                    <div class="stock-group mb-3">
                        <div>
                            <label for="stock_quantity" class="form-label">Cantidad en Stock</label>
                            <input type="number" class="form-control" id="stock_quantity" name="stock_quantity" value="0">
                        </div>

                        <div>
                            <label for="stock_status" class="form-label">Estado de Stock</label>
                            <select class="form-select" id="stock_status" name="stock_status">
                                <option value="instock" selected>En Stock</option>
                                <option value="outofstock">Agotado</option>
                                <option value="onbackorder">En Pedido Pendiente</option>
                            </select>
                        </div>

                        <div>
                            <label for="low_stock_threshold" class="form-label">Umbral Stock Bajo</label>
                            <input type="number" class="form-control" id="low_stock_threshold" name="low_stock_threshold" value="5">
                        </div>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="manage_stock" name="manage_stock" value="yes" checked>
                        <label class="form-check-label" for="manage_stock">
                            Gestionar stock
                        </label>
                    </div>
                </div>

                <!-- Peso y Dimensiones -->
                <div class="form-section">
                    <h2 class="form-section-title">Peso y Dimensiones</h2>

                    <div class="mb-3">
                        <label for="weight" class="form-label">Peso (kg)</label>
                        <input type="number" step="0.01" class="form-control" id="weight" name="weight">
                    </div>

                    <div class="dimensions-group">
                        <div>
                            <label for="length" class="form-label">Largo (cm)</label>
                            <input type="number" step="0.01" class="form-control" id="length" name="length">
                        </div>

                        <div>
                            <label for="width" class="form-label">Ancho (cm)</label>
                            <input type="number" step="0.01" class="form-control" id="width" name="width">
                        </div>

                        <div>
                            <label for="height" class="form-label">Alto (cm)</label>
                            <input type="number" step="0.01" class="form-control" id="height" name="height">
                        </div>
                    </div>
                </div>

                <!-- Imágenes -->
                <div class="form-section">
                    <h2 class="form-section-title">Imágenes</h2>

                    <div class="mb-3">
                        <label for="image_url" class="form-label">URL Imagen Principal</label>
                        <input type="url" class="form-control" id="image_url" name="image_url">
                        <div class="help-text">URL completa de la imagen principal del producto</div>
                        <img id="image_preview" class="image-preview" alt="Preview">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Galería de Imágenes (URLs)</label>
                        <div id="gallery_container">
                            <div class="input-group mb-2">
                                <input type="url" class="form-control" name="gallery_images[]" placeholder="https://...">
                                <button type="button" class="btn btn-outline-danger" onclick="removeGalleryImage(this)">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addGalleryImage()">
                            <i class="bi bi-plus"></i> Agregar Imagen
                        </button>
                    </div>
                </div>

                <!-- SEO (Yoast) -->
                <div class="form-section">
                    <h2 class="form-section-title">SEO (Yoast)</h2>

                    <div class="mb-3">
                        <label for="seo_title" class="form-label">Título SEO</label>
                        <input type="text" class="form-control" id="seo_title" name="seo_title" maxlength="70">
                        <div class="help-text">Máximo 70 caracteres</div>
                    </div>

                    <div class="mb-3">
                        <label for="seo_description" class="form-label">Meta Descripción</label>
                        <textarea class="form-control" id="seo_description" name="seo_description" rows="3" maxlength="160"></textarea>
                        <div class="help-text">Máximo 160 caracteres</div>
                    </div>

                    <div class="mb-3">
                        <label for="focus_keyphrase" class="form-label">Focus Keyphrase</label>
                        <input type="text" class="form-control" id="focus_keyphrase" name="focus_keyphrase">
                        <div class="help-text">Palabra clave principal</div>
                    </div>

                    <div class="mb-3">
                        <label for="seo_keywords" class="form-label">Palabras Clave Relacionadas</label>
                        <textarea class="form-control" id="seo_keywords" name="seo_keywords" rows="2"></textarea>
                        <div class="help-text">Separar con comas</div>
                    </div>
                </div>

            </div>

            <!-- Columna lateral -->
            <div class="col-lg-4">

                <!-- Estado y Tipo -->
                <div class="form-section">
                    <h2 class="form-section-title">Publicación</h2>

                    <div class="mb-3">
                        <label for="status" class="form-label">Estado</label>
                        <select class="form-select" id="status" name="status">
                            <option value="draft" selected>Borrador</option>
                            <option value="publish">Publicado</option>
                            <option value="private">Privado</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="product_type" class="form-label">Tipo de Producto</label>
                        <select class="form-select" id="product_type" name="product_type">
                            <option value="simple" selected>Producto Simple</option>
                            <option value="variable">Producto Variable (con variaciones)</option>
                        </select>
                        <div class="help-text">Variable permite crear productos con atributos (color, talla, etc.)</div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-submit-product">
                            <i class="bi bi-check-circle"></i> Crear Producto
                        </button>
                        <a href="/products/" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                    </div>
                </div>

                <!-- Categorías -->
                <div class="form-section">
                    <h2 class="form-section-title">Categorías</h2>
                    <select class="form-select" id="categories" name="categories[]" multiple>
                        <!-- Se cargan dinámicamente -->
                    </select>
                </div>

                <!-- Tags -->
                <div class="form-section">
                    <h2 class="form-section-title">Etiquetas</h2>
                    <select class="form-select" id="tags" name="tags[]" multiple>
                        <!-- Se cargan dinámicamente -->
                    </select>
                </div>

                <!-- Marcas -->
                <div class="form-section">
                    <h2 class="form-section-title">Marcas</h2>
                    <select class="form-select" id="brands" name="brands[]" multiple>
                        <!-- Se cargan dinámicamente -->
                    </select>
                </div>

            </div>
        </div>
    </form>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <div class="h5">Creando producto...</div>
        <div class="text-muted">Por favor espera</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Inicializar Select2 para taxonomías
    $('#categories').select2({
        theme: 'bootstrap-5',
        placeholder: 'Seleccionar categorías',
        allowClear: true
    });

    $('#tags').select2({
        theme: 'bootstrap-5',
        placeholder: 'Seleccionar etiquetas',
        allowClear: true,
        tags: true
    });

    $('#brands').select2({
        theme: 'bootstrap-5',
        placeholder: 'Seleccionar marcas',
        allowClear: true
    });

    // Cargar categorías
    loadCategories();

    // Cargar tags
    loadTags();

    // Cargar brands
    loadBrands();

    // Preview de imagen principal
    $('#image_url').on('input', function() {
        const url = $(this).val();
        if (url) {
            $('#image_preview').attr('src', url).show();
        } else {
            $('#image_preview').hide();
        }
    });

    // Auto-generar slug desde título
    $('#title').on('input', function() {
        if ($('#slug').val() === '') {
            const slug = $(this).val()
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '');
            $('#slug').val(slug);
        }
    });

    // Detectar cambio en tipo de producto
    $('#product_type').on('change', function() {
        if ($(this).val() === 'variable') {
            if (confirm('Los productos variables requieren configurar atributos y variaciones.\n\n¿Deseas ir al wizard de productos variables?')) {
                window.location.href = '/products/create-variable-wizard';
            } else {
                $(this).val('simple');
            }
        }
    });

    // Enviar formulario
    $('#productForm').on('submit', function(e) {
        e.preventDefault();
        submitProduct();
    });
});

function loadCategories() {
    $.ajax({
        url: '/products/get-categories',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                $('#categories').empty();
                response.categories.forEach(function(cat) {
                    $('#categories').append(new Option(cat.name, cat.id));
                });
            }
        },
        error: function(xhr) {
            console.error('Error al cargar categorías:', xhr);
        }
    });
}

function loadTags() {
    $.ajax({
        url: '/products/get-tags',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                $('#tags').empty();
                response.tags.forEach(function(tag) {
                    $('#tags').append(new Option(tag.name, tag.id));
                });
            }
        },
        error: function(xhr) {
            console.error('Error al cargar tags:', xhr);
        }
    });
}

function loadBrands() {
    $.ajax({
        url: '/products/get-brands',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                $('#brands').empty();
                response.brands.forEach(function(brand) {
                    $('#brands').append(new Option(brand.name, brand.id));
                });
            }
        },
        error: function(xhr) {
            console.error('Error al cargar marcas:', xhr);
        }
    });
}

function addGalleryImage() {
    const html = `
        <div class="input-group mb-2">
            <input type="url" class="form-control" name="gallery_images[]" placeholder="https://...">
            <button type="button" class="btn btn-outline-danger" onclick="removeGalleryImage(this)">
                <i class="bi bi-x"></i>
            </button>
        </div>
    `;
    $('#gallery_container').append(html);
}

function removeGalleryImage(button) {
    $(button).closest('.input-group').remove();
}

function submitProduct() {
    // Validar campos requeridos
    if (!$('#title').val().trim()) {
        alert('El título es obligatorio');
        return;
    }

    if (!$('#sku').val().trim()) {
        alert('El SKU es obligatorio');
        return;
    }

    if (!$('#regular_price').val()) {
        alert('El precio regular es obligatorio');
        return;
    }

    // Mostrar overlay de carga
    $('#loadingOverlay').addClass('active');

    // Recopilar datos del formulario
    const formData = {
        title: $('#title').val().trim(),
        slug: $('#slug').val().trim(),
        description: $('#description').val(),
        short_description: $('#short_description').val(),
        status: $('#status').val(),
        product_type: $('#product_type').val(),
        sku: $('#sku').val().trim(),
        regular_price: $('#regular_price').val(),
        sale_price: $('#sale_price').val(),
        cost_price: $('#cost_price').val(),
        stock_quantity: $('#stock_quantity').val(),
        stock_status: $('#stock_status').val(),
        low_stock_threshold: $('#low_stock_threshold').val(),
        manage_stock: $('#manage_stock').is(':checked') ? 'yes' : 'no',
        weight: $('#weight').val(),
        length: $('#length').val(),
        width: $('#width').val(),
        height: $('#height').val(),
        image_url: $('#image_url').val(),
        seo_title: $('#seo_title').val(),
        seo_description: $('#seo_description').val(),
        focus_keyphrase: $('#focus_keyphrase').val(),
        seo_keywords: $('#seo_keywords').val(),
        categories: $('#categories').val() || [],
        tags: $('#tags').val() || [],
        brands: $('#brands').val() || [],
        gallery_images: []
    };

    // Recopilar galería de imágenes
    $('input[name="gallery_images[]"]').each(function() {
        const url = $(this).val().trim();
        if (url) {
            formData.gallery_images.push(url);
        }
    });

    // Enviar al backend
    $.ajax({
        url: '/products/create',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            $('#loadingOverlay').removeClass('active');

            if (response.success) {
                alert('¡Producto creado exitosamente!\nID: ' + response.product_id);

                // Redirigir al listado de productos
                window.location.href = '/products/';
            } else {
                alert('Error: ' + response.error);
            }
        },
        error: function(xhr) {
            $('#loadingOverlay').removeClass('active');

            let errorMsg = 'Error al crear el producto';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            }

            alert(errorMsg);
            console.error('Error completo:', xhr);
        }
    });
}
</script>
{% endblock %}
