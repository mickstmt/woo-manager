{% extends "base.html" %}

{% block title %}Gestión de Usuarios - WooCommerce Manager{% endblock %}

{% block extra_css %}
<style>
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--primary-light);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-color);
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .user-avatar:hover {
        transform: scale(1.05);
    }

    .user-row.inactive {
        opacity: 0.6;
        background-color: #f8f9fa;
    }

    .badge-role {
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-people"></i> Gestión de Usuarios
            </h1>

            <button class="btn btn-primary" onclick="showCreateUserModal()">
                <i class="bi bi-person-plus"></i> Crear Usuario
            </button>
        </div>

        <!-- Estadísticas -->
        <!-- Estadísticas Modernas -->
        <div class="row g-4 mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="card border border-light-subtle shadow-sm h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="avatar-lg rounded-circle bg-primary-subtle text-primary p-3 me-3 d-flex align-items-center justify-content-center"
                            style="width: 60px; height: 60px;">
                            <i class="bi bi-people fs-3"></i>
                        </div>
                        <div>
                            <span class="d-block text-muted text-uppercase small fw-bold mb-1">Total Usuarios</span>
                            <h3 class="mb-0 fw-bold" id="stat-total">-</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card border border-light-subtle shadow-sm h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="avatar-lg rounded-circle bg-success-subtle text-success p-3 me-3 d-flex align-items-center justify-content-center"
                            style="width: 60px; height: 60px;">
                            <i class="bi bi-person-check fs-3"></i>
                        </div>
                        <div>
                            <span class="d-block text-muted text-uppercase small fw-bold mb-1">Activos</span>
                            <h3 class="mb-0 fw-bold" id="stat-active">-</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card border border-light-subtle shadow-sm h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="avatar-lg rounded-circle bg-danger-subtle text-danger p-3 me-3 d-flex align-items-center justify-content-center"
                            style="width: 60px; height: 60px;">
                            <i class="bi bi-shield-lock fs-3"></i>
                        </div>
                        <div>
                            <span class="d-block text-muted text-uppercase small fw-bold mb-1">Administradores</span>
                            <h3 class="mb-0 fw-bold" id="stat-admins">-</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card border border-light-subtle shadow-sm h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="avatar-lg rounded-circle bg-info-subtle text-info p-3 me-3 d-flex align-items-center justify-content-center"
                            style="width: 60px; height: 60px;">
                            <i class="bi bi-activity fs-3"></i>
                        </div>
                        <div>
                            <span class="d-block text-muted text-uppercase small fw-bold mb-1">Activos Semana</span>
                            <h3 class="mb-0 fw-bold" id="stat-active-week">-</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Crear Usuario (Restored & Hidden) -->
        <div class="modal fade" id="createUserModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-person-plus"></i> Crear Nuevo Usuario</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="createUserForm">
                            <div class="mb-3">
                                <label class="form-label">Usuario *</label>
                                <input type="text" class="form-control" id="create-username" required>
                                <small class="text-muted">Nombre de usuario para inicar sesión</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nombre Completo</label>
                                <input type="text" class="form-control" id="create-fullname">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email Corporativo *</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="create-email-prefix" required>
                                    <span class="input-group-text">@izistoreperu.com</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Contraseña *</label>
                                    <input type="password" class="form-control" id="create-password" minlength="6"
                                        required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Confirmar *</label>
                                    <input type="password" class="form-control" id="create-password-confirm"
                                        minlength="6" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Rol *</label>
                                <select class="form-select" id="create-role" required>
                                    <option value="user" selected>Usuario</option>
                                    <option value="admin">Administrador</option>
                                    {% if current_user.role == 'master' %}
                                    <option value="master">Master</option>
                                    {% endif %}
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="createUser()">
                            <i class="bi bi-check-circle"></i> Crear Usuario
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros y Búsqueda -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-5">
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-end-0">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control border-start-0 ps-0" id="search-input"
                        placeholder="Buscar por usuario, email o nombre...">
                    <button class="btn btn-primary" onclick="searchUsers()">
                        Buscar
                    </button>
                    <button class="btn btn-light" onclick="clearSearch()">
                        Limpiar
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="role-filter">
                    <option value="">Todos los roles</option>
                    <option value="admin">Administradores</option>
                    <option value="user">Usuarios</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="status-filter">
                    <option value="">Todos los estados</option>
                    <option value="active">Activos</option>
                    <option value="inactive">Inactivos</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="per-page-select">
                    <option value="10">10 por página</option>
                    <option value="25" selected>25 por página</option>
                    <option value="50">50 por página</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de Usuarios -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-transparent border-bottom py-3">
        <h5 class="mb-0 fw-bold">Listado de Usuarios</h5>
    </div>
    <div class="card-body p-0">
        <div id="loading" class="text-center py-5" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2 text-muted">Cargando usuarios...</p>
        </div>

        <div id="users-table-container"></div>

        <!-- Paginación -->
        <div id="pagination-container" class="p-3"></div>
    </div>
</div>
</div>
</div>

<!-- Modal Editar Usuario -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil"></i> Editar Usuario
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-user-id">

                <div class="alert alert-info">
                    <strong>Usuario:</strong> <span id="edit-username-display"></span>
                </div>

                <form id="editUserForm">
                    <div class="mb-3">
                        <label class="form-label">Email Corporativo *</label>
                        <input type="email" class="form-control" id="edit-email" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" class="form-control" id="edit-fullname">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Rol *</label>
                        <select class="form-select" id="edit-role" required>
                            <option value="user">Usuario</option>
                            <option value="admin">Administrador</option>
                            {% if current_user.role == 'master' %}
                            <option value="master">Master</option>
                            {% endif %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="updateUser()">
                    <i class="bi bi-check-circle"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Restablecer Contraseña -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-key"></i> Restablecer Contraseña
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reset-user-id">

                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    Estás a punto de cambiar la contraseña de: <strong id="reset-username-display"></strong>
                </div>

                <form id="resetPasswordForm">
                    <div class="mb-3">
                        <label class="form-label">Nueva Contraseña *</label>
                        <input type="password" class="form-control" id="reset-password" minlength="6" required>
                        <small class="text-muted">Mínimo 6 caracteres</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Confirmar Nueva Contraseña *</label>
                        <input type="password" class="form-control" id="reset-password-confirm" minlength="6" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="resetPassword()">
                    <i class="bi bi-check-circle"></i> Restablecer Contraseña
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ver Historial -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-clock-history"></i> Historial de Accesos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="history-content">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let perPage = 25;
    let searchTerm = '';
    let roleFilter = '';
    let statusFilter = '';

    $(document).ready(function () {
        loadStats();
        loadUsers();

        // Eventos
        $('#search-input').on('keypress', function (e) {
            if (e.which === 13) searchUsers();
        });

        $('#role-filter, #status-filter').on('change', function () {
            roleFilter = $('#role-filter').val();
            statusFilter = $('#status-filter').val();
            currentPage = 1;
            loadUsers();
        });

        $('#per-page-select').on('change', function () {
            perPage = parseInt($(this).val());
            currentPage = 1;
            loadUsers();
        });
    });

    function loadStats() {
        $.ajax({
            url: '/users/stats',
            method: 'GET',
            success: function (data) {
                if (data.success) {
                    $('#stat-total').text(data.stats.total);
                    $('#stat-active').text(data.stats.active);
                    $('#stat-admins').text(data.stats.admins);
                    $('#stat-active-week').text(data.stats.active_last_week);
                }
            }
        });
    }

    function searchUsers() {
        searchTerm = $('#search-input').val();
        currentPage = 1;
        loadUsers();
    }

    function clearSearch() {
        searchTerm = '';
        $('#search-input').val('');
        roleFilter = '';
        statusFilter = '';
        $('#role-filter').val('');
        $('#status-filter').val('');
        currentPage = 1;
        loadUsers();
    }

    function loadUsers(page = currentPage) {
        currentPage = page;

        $('#loading').show();
        $('#users-table-container').hide();

        $.ajax({
            url: '/users/list',
            method: 'GET',
            data: {
                page: currentPage,
                per_page: perPage,
                search: searchTerm,
                role: roleFilter,
                status: statusFilter
            },
            success: function (data) {
                $('#loading').hide();
                $('#users-table-container').show();

                if (data.success) {
                    displayUsers(data.users);
                    displayPagination(data.pagination);
                }
            },
            error: function () {
                $('#loading').hide();
                showNotification('error', 'Error al cargar usuarios');
            }
        });
    }

    function displayUsers(users) {
        if (users.length === 0) {
            $('#users-table-container').html(
                '<div class="alert alert-info">No se encontraron usuarios</div>'
            );
            return;
        }

        let html = '<div class="table-responsive">';
        html += '<table class="table table-hover align-middle">';
        html += '<thead class="table-light">';
        html += '<tr>';
        html += '<th style="width: 60px;"></th>';
        html += '<th>Usuario</th>';
        html += '<th>Email</th>';
        html += '<th>Nombre Completo</th>';
        html += '<th style="width: 120px;">Rol</th>';
        html += '<th style="width: 100px;">Estado</th>';
        html += '<th style="width: 180px;">Último Acceso</th>';
        html += '<th style="width: 200px;">Acciones</th>';
        html += '</tr>';
        html += '</thead>';
        html += '<tbody>';

        users.forEach(function (user) {
            let rowClass = !user.is_active ? 'user-row inactive' : 'user-row';
            let initial = user.username.charAt(0).toUpperCase();

            let roleBadge = user.role === 'master'
                ? '<span class="badge badge-role bg-dark">Master</span>'
                : user.role === 'admin'
                ? '<span class="badge badge-role bg-danger">Administrador</span>'
                : '<span class="badge badge-role bg-primary">Usuario</span>';

            let statusBadge = user.is_active
                ? '<span class="badge bg-success">Activo</span>'
                : '<span class="badge bg-secondary">Inactivo</span>';

            let lastLogin = user.last_login
                ? new Date(user.last_login).toLocaleString('es-PE')
                : '<span class="text-muted">Nunca</span>';

            html += '<tr class="' + rowClass + '">';

            // Avatar
            html += '<td><div class="user-avatar">' + initial + '</div></td>';

            // Usuario
            html += '<td><strong>' + user.username + '</strong>';
            if (user.is_current_user) {
                html += ' <span class="badge bg-info">Tú</span>';
            }
            html += '</td>';

            // Email
            html += '<td>' + user.email + '</td>';

            // Nombre completo
            html += '<td>' + (user.full_name || '<span class="text-muted">-</span>') + '</td>';

            // Rol
            html += '<td>' + roleBadge + '</td>';

            // Estado
            html += '<td>' + statusBadge + '</td>';

            // Último acceso
            html += '<td><small>' + lastLogin + '</small></td>';

            // Acciones
            html += '<td>';
            html += '<div class="btn-group btn-group-sm" role="group">';

            html += '<button class="btn btn-info" onclick="viewHistory(' + user.id + ')" title="Ver historial">';
            html += '<i class="bi bi-clock-history"></i>';
            html += '</button>';

            html += '<button class="btn btn-primary" onclick="showEditUserModal(' + user.id + ')" title="Editar">';
            html += '<i class="bi bi-pencil"></i>';
            html += '</button>';

            html += '<button class="btn btn-warning" onclick="showResetPasswordModal(' + user.id + ', \'' + user.username + '\')" title="Cambiar contraseña">';
            html += '<i class="bi bi-key"></i>';
            html += '</button>';

            if (!user.is_current_user) {
                let toggleIcon = user.is_active ? 'ban' : 'check-circle';
                let toggleColor = user.is_active ? 'secondary' : 'success';
                html += '<button class="btn btn-' + toggleColor + '" onclick="toggleUserStatus(' + user.id + ', ' + user.is_active + ')" title="' + (user.is_active ? 'Desactivar' : 'Activar') + '">';
                html += '<i class="bi bi-' + toggleIcon + '"></i>';
                html += '</button>';

                html += '<button class="btn btn-danger" onclick="deleteUser(' + user.id + ', \'' + user.username + '\')" title="Eliminar">';
                html += '<i class="bi bi-trash"></i>';
                html += '</button>';
            }

            html += '</div>';
            html += '</td>';

            html += '</tr>';
        });

        html += '</tbody>';
        html += '</table>';
        html += '</div>';

        $('#users-table-container').html(html);
    }

    function displayPagination(pagination) {
        if (pagination.pages <= 1) {
            $('#pagination-container').html('');
            return;
        }

        let html = '<nav><ul class="pagination justify-content-center">';

        if (pagination.has_prev) {
            html += '<li class="page-item">';
            html += '<a class="page-link" href="#" onclick="loadUsers(' + pagination.prev_num + '); return false;">Anterior</a>';
            html += '</li>';
        }

        for (let i = 1; i <= pagination.pages; i++) {
            if (i === pagination.page) {
                html += '<li class="page-item active"><span class="page-link">' + i + '</span></li>';
            } else if (i === 1 || i === pagination.pages || (i >= pagination.page - 2 && i <= pagination.page + 2)) {
                html += '<li class="page-item">';
                html += '<a class="page-link" href="#" onclick="loadUsers(' + i + '); return false;">' + i + '</a>';
                html += '</li>';
            } else if (i === pagination.page - 3 || i === pagination.page + 3) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }

        if (pagination.has_next) {
            html += '<li class="page-item">';
            html += '<a class="page-link" href="#" onclick="loadUsers(' + pagination.next_num + '); return false;">Siguiente</a>';
            html += '</li>';
        }

        html += '</ul></nav>';

        if (pagination.total > 0) {
            let start = (pagination.page - 1) * pagination.per_page + 1;
            let end = Math.min(pagination.page * pagination.per_page, pagination.total);
            html += '<p class="text-center text-muted">';
            html += 'Mostrando ' + start + ' - ' + end + ' de ' + pagination.total + ' usuarios';
            html += '</p>';
        }

        $('#pagination-container').html(html);
    }

    function showCreateUserModal() {
        $('#createUserForm')[0].reset();
        let modal = new bootstrap.Modal(document.getElementById('createUserModal'));
        modal.show();
    }

    function createUser() {
        let username = $('#create-username').val().trim();
        let emailPrefix = $('#create-email-prefix').val().trim();
        let fullName = $('#create-fullname').val().trim();
        let password = $('#create-password').val();
        let passwordConfirm = $('#create-password-confirm').val();
        let role = $('#create-role').val();

        // Validaciones
        if (!username || !emailPrefix || !password) {
            showNotification('error', 'Usuario, email y contraseña son obligatorios');
            return;
        }

        if (password !== passwordConfirm) {
            showNotification('error', 'Las contraseñas no coinciden');
            return;
        }

        if (password.length < 6) {
            showNotification('error', 'La contraseña debe tener al menos 6 caracteres');
            return;
        }

        let email = emailPrefix + '@izistoreperu.com';

        $.ajax({
            url: '/users/create',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                username: username,
                email: email,
                full_name: fullName,
                password: password,
                role: role
            }),
            success: function (response) {
                if (response.success) {
                    showNotification('success', response.message);
                    $('#createUserModal').modal('hide');
                    loadStats();
                    loadUsers();
                } else {
                    showNotification('error', response.error);
                }
            },
            error: function (xhr) {
                let error = xhr.responseJSON ? xhr.responseJSON.error : 'Error al crear usuario';
                showNotification('error', error);
            }
        });
    }

    function showEditUserModal(userId) {
        $.ajax({
            url: '/users/' + userId,
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    let user = response.user;

                    $('#edit-user-id').val(user.id);
                    $('#edit-username-display').text(user.username);
                    $('#edit-email').val(user.email);
                    $('#edit-fullname').val(user.full_name);
                    $('#edit-role').val(user.role);

                    let modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                    modal.show();
                }
            }
        });
    }

    function updateUser() {
        let userId = $('#edit-user-id').val();
        let email = $('#edit-email').val().trim();
        let fullName = $('#edit-fullname').val().trim();
        let role = $('#edit-role').val();

        if (!email) {
            showNotification('error', 'El email es obligatorio');
            return;
        }

        $.ajax({
            url: '/users/' + userId + '/update',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                email: email,
                full_name: fullName,
                role: role
            }),
            success: function (response) {
                if (response.success) {
                    showNotification('success', response.message);
                    $('#editUserModal').modal('hide');
                    loadStats();
                    loadUsers();
                } else {
                    showNotification('error', response.error);
                }
            },
            error: function (xhr) {
                let error = xhr.responseJSON ? xhr.responseJSON.error : 'Error al actualizar usuario';
                showNotification('error', error);
            }
        });
    }

    function showResetPasswordModal(userId, username) {
        $('#reset-user-id').val(userId);
        $('#reset-username-display').text(username);
        $('#resetPasswordForm')[0].reset();

        let modal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));
        modal.show();
    }

    function resetPassword() {
        let userId = $('#reset-user-id').val();
        let password = $('#reset-password').val();
        let passwordConfirm = $('#reset-password-confirm').val();

        if (password !== passwordConfirm) {
            showNotification('error', 'Las contraseñas no coinciden');
            return;
        }

        if (password.length < 6) {
            showNotification('error', 'La contraseña debe tener al menos 6 caracteres');
            return;
        }

        if (!confirm('¿Estás seguro de cambiar la contraseña de este usuario?')) {
            return;
        }

        $.ajax({
            url: '/users/' + userId + '/reset-password',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                new_password: password
            }),
            success: function (response) {
                if (response.success) {
                    showNotification('success', response.message);
                    $('#resetPasswordModal').modal('hide');
                } else {
                    showNotification('error', response.error);
                }
            },
            error: function (xhr) {
                let error = xhr.responseJSON ? xhr.responseJSON.error : 'Error al restablecer contraseña';
                showNotification('error', error);
            }
        });
    }

    function toggleUserStatus(userId, currentStatus) {
        let action = currentStatus ? 'desactivar' : 'activar';

        if (!confirm('¿Estás seguro de ' + action + ' este usuario?')) {
            return;
        }

        $.ajax({
            url: '/users/' + userId + '/toggle-status',
            method: 'POST',
            success: function (response) {
                if (response.success) {
                    showNotification('success', response.message);
                    loadStats();
                    loadUsers();
                } else {
                    showNotification('error', response.error);
                }
            },
            error: function (xhr) {
                let error = xhr.responseJSON ? xhr.responseJSON.error : 'Error al cambiar estado';
                showNotification('error', error);
            }
        });
    }

    function deleteUser(userId, username) {
        if (!confirm('¿Estás seguro de ELIMINAR permanentemente al usuario "' + username + '"?\n\nEsta acción NO se puede deshacer.')) {
            return;
        }

        $.ajax({
            url: '/users/' + userId + '/delete',
            method: 'POST',
            success: function (response) {
                if (response.success) {
                    showNotification('success', response.message);
                    loadStats();
                    loadUsers();
                } else {
                    showNotification('error', response.error);
                }
            },
            error: function (xhr) {
                let error = xhr.responseJSON ? xhr.responseJSON.error : 'Error al eliminar usuario';
                showNotification('error', error);
            }
        });
    }

    function viewHistory(userId) {
        $('#history-content').html('<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>');

        let modal = new bootstrap.Modal(document.getElementById('historyModal'));
        modal.show();

        $.ajax({
            url: '/users/' + userId,
            method: 'GET',
            success: function (response) {
                if (response.success && response.login_history) {
                    displayHistory(response.user, response.login_history);
                } else {
                    $('#history-content').html('<div class="alert alert-info">No hay historial disponible</div>');
                }
            },
            error: function () {
                $('#history-content').html('<div class="alert alert-danger">Error al cargar historial</div>');
            }
        });
    }

    function displayHistory(user, history) {
        let html = '<div class="mb-3">';
        html += '<h6><strong>Usuario:</strong> ' + user.username + '</h6>';
        html += '<p class="text-muted mb-0">' + user.email + '</p>';
        html += '</div><hr>';

        if (history.length === 0) {
            html += '<div class="alert alert-info">No hay registros de acceso</div>';
        } else {
            html += '<div class="table-responsive">';
            html += '<table class="table table-sm table-hover">';
            html += '<thead><tr>';
            html += '<th>Fecha y Hora</th>';
            html += '<th>IP</th>';
            html += '<th>Navegador</th>';
            html += '</tr></thead><tbody>';

            history.forEach(function (record) {
                html += '<tr>';
                html += '<td>' + new Date(record.login_at).toLocaleString('es-PE') + '</td>';
                html += '<td><code>' + record.ip_address + '</code></td>';
                html += '<td><small>' + record.user_agent.substring(0, 50) + '...</small></td>';
                html += '</tr>';
            });

            html += '</tbody></table>';
            html += '</div>';
        }

        $('#history-content').html(html);
    }

    function showNotification(type, message) {
        let bgClass = type === 'success' ? 'bg-success' : type === 'warning' ? 'bg-warning' : 'bg-danger';
        let icon = type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'x-circle';

        let notification = $('<div class="toast-notification"></div>')
            .addClass(bgClass)
            .html('<i class="bi bi-' + icon + '"></i> ' + message)
            .css({
                position: 'fixed',
                top: '80px',
                right: '20px',
                padding: '15px 20px',
                borderRadius: '5px',
                color: 'white',
                zIndex: 9999,
                boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                minWidth: '300px'
            });

        $('body').append(notification);
        notification.fadeIn(300);

        setTimeout(function () {
            notification.fadeOut(300, function () {
                $(this).remove();
            });
        }, 3000);
    }
</script>
{% endblock %}